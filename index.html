<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ ÙˆØ§Ù„Ø´Ù‡Ø±ÙŠ</title>
    <style>
        /* Ø§Ù„Ø£Ù†Ù…Ø§Ø· (CSS) */
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f4f4f9;
            color: #333;
            margin: 0;
            padding: 20px;
            text-align: right;
            direction: rtl;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        h1, h2, h3 {
            color: #007bff;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-top: 20px;
        }
        .action-buttons {
            margin-bottom: 20px;
        }
        button {
            padding: 10px 15px;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
            transition: background-color 0.3s;
            background-color: #007bff;
        }
        button:hover {
            opacity: 0.9;
        }
        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹ */
        .week-buttons button {
            background-color: #6c757d;
            margin: 5px;
            font-weight: bold;
        }
        .week-buttons button.active {
            background-color: #28a745;
        }
        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£ÙŠØ§Ù… */
        .day-buttons button {
            background-color: #17a2b8;
            margin: 5px 5px 5px 0;
            font-weight: normal;
        }
        .day-buttons button.active {
            background-color: #007bff;
        }

        /* Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ÙˆØ§Ù„Ø£ÙŠØ§Ù… */
        .weekly-table, .monthly-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.95em;
        }
        .weekly-table th, .weekly-table td, .monthly-table th, .monthly-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center; 
        }
        .weekly-table th, .monthly-table th {
            background-color: #f2f2f2;
            color: #333;
        }
        .weekly-table thead th:first-child, .monthly-table thead th:first-child {
            text-align: right;
        }
        /* Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
        .status-absent {
            background-color: #f8d7da; 
            color: #721c24; 
            font-weight: bold;
        }
        .status-present {
            background-color: #d4edda; 
            color: #155724; 
            font-weight: bold;
        }
        .status-default-muted {
            color: #999; 
            font-style: italic;
        }
        .status-not-scheduled {
            background-color: #f9f9f9;
            color: #ccc;
            font-size: 0.8em;
        }
        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ */
        .monthly-summary {
            background-color: #e9f7ef;
            border: 1px solid #c8e6c9;
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
        }
        #copy-monthly-button {
            background-color: #ffc107; 
            color: #333;
            margin-left: 0;
            margin-right: 10px;
        }
        #whatsapp-day-button {
             background-color: #075E54; /* Ù„ÙˆÙ† Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ù…Ù† Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù‚Ø¯ÙŠÙ… */
             margin-left: 0;
             display: block;
             width: 100%;
             padding: 15px;
             margin-top: 20px;
             font-size: 1.1em;
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
</head>
<body>

<div class="container">
    <h1>ğŸ—“ï¸ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ</h1>
    
    <div id="result-area" style="margin-top:15px; padding:10px; border:1px solid #eee;">
        <p style="color:#007bff;">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„" Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.</p>
    </div>

    <div class="action-buttons">
        <button onclick="initializeWeeksAndFetchData()">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
    </div>

    <hr>

    <h2 id="week-title-area">ğŸ—“ï¸ Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø¶ÙˆØ± Ø­Ø³Ø¨ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</h2>

    <div id="week-buttons-container" class="week-buttons">
        <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø£Ø³Ø§Ø¨ÙŠØ¹ Ø§Ù„Ø¯ÙˆØ±Ø©...</p>
    </div>

    <div id="week-details">
        <p>Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø£Ø³Ø¨ÙˆØ¹ Ù„Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØªØ·ÙˆØ¹ÙŠÙ†.</p>
    </div>
    
    <hr>

    <h2 onclick="calculateMonthlyAttendance()" style="cursor:pointer;">ğŸ“Š Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ Ø§Ù„Ø¯Ù‚ÙŠÙ‚ (Ø§Ø¶ØºØ· Ù„Ù„Ø­Ø³Ø§Ø¨)</h2>
    <div id="monthly-report-area">
        <p>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø£Ø¹Ù„Ø§Ù‡ Ù„Ø­Ø³Ø§Ø¨ Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ø¹ØªØ°Ø§Ø± Ù„Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ø´Ù‡Ø±ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© (26 - 25).</p>
    </div>
</div>

<script>
    // âš ï¸ Ù…ÙØ§ØªÙŠØ­ Firebase (Ø§Ø³ØªØ¨Ø¯Ù„Ù‡Ø§ Ø¨Ù…ÙØ§ØªÙŠØ­Ùƒ Ø§Ù„Ø­Ù‚ÙŠÙ‚ÙŠØ©)
    const firebaseConfig = {
        apiKey: "AIzaSyCDJANXMfd6TR7R2ruLIi-xytlrB-LiCEs", 
        authDomain: "rdtt-15cbe.firebaseapp.com",
        projectId: "rdtt-15cbe",
        storageBucket: "rdtt-15cbe.firebasestorage.app",
        messagingSenderId: "219502671343",
        appId: "1:219502671343:web:b289b11869e25c9a30321a"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    
    // ----------------------------------------------------------------
    // 1. Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø«Ø§Ø¨ØªØ© ÙˆØ§Ù„Ø¬Ø¯ÙˆÙ„Ø©
    // ----------------------------------------------------------------
    const WORKING_DAYS = ["Ø§Ù„Ø³Ø¨Øª", "Ø§Ù„Ø£Ø­Ø¯", "Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†", "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡", "Ø§Ù„Ø®Ù…ÙŠØ³"];

    const FIXED_VOLUNTEERS = {
        "Ø£Ø­Ù…Ø¯": WORKING_DAYS, "Ù‡Ø¯ÙŠØ±": WORKING_DAYS, "Ù…Ø­Ù…Ø¯ Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…": WORKING_DAYS, 
        "Ù…Ø­Ù…Ø¯ Ø¹Ø¨Ø¯Ø§Ù„Ø­Ù…ÙŠØ¯": WORKING_DAYS, "Ø³Ø§Ù…Ù‰": ["Ø§Ù„Ø³Ø¨Øª", "Ø§Ù„Ø£Ø­Ø¯", "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡"], 
        "Ù…Ù…ØªØ§Ø²": WORKING_DAYS, "Ø­Ø¨ÙŠØ¨Ø©": WORKING_DAYS, "Ø³Ø§Ù†Ø¯ÙŠ": [],
        "Ø±Ø­Ø§Ø¨": ["Ø§Ù„Ø³Ø¨Øª", "Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†", "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡"], "Ù…Ø¹Ø§Ø°": ["Ø§Ù„Ø£Ø­Ø¯", "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", "Ø§Ù„Ø®Ù…ÙŠØ³"], 
        "Ù…Ø§Ø²Ù†": WORKING_DAYS, "ÙŠÙˆØ³Ù": [], "Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…": WORKING_DAYS, 
        "Ù…Ø±ÙˆØ§Ù†": [], "Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù†": [], "Ù…Ø¹ØªØ²": WORKING_DAYS 
    };
    
    const VOLUNTEER_NAMES_ORDERED = Object.keys(FIXED_VOLUNTEERS);
    
    let allAttendanceData = {}; 
    let cycleWeeks = []; 
    let finalMonthlyReportData = { cycleDisplay: '', data: {} }; 
    
    // ğŸ’¡ ØªÙ… ØªØ­Ø¯ÙŠØ« Ù‡Ø°Ø§ Ù„ÙŠØ®Ø²Ù† Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„ØªÙŠ Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„Ù‡Ø§ Ù„Ù„ÙˆØ§ØªØ³Ø§Ø¨
    let currentDayWhatsAppList = { names: [], dayName: null, dateKey: null };
    
    let cycleDaysCache = {}; // ØªØ®Ø²ÙŠÙ† ØªÙØ§ØµÙŠÙ„ Ø£ÙŠØ§Ù… Ø§Ù„Ø¯ÙˆØ±Ø© Ø¨Ø§Ù„ÙƒØ§Ù…Ù„ Ø¨Ø§Ù„Ù€ dateKey

    const JS_DAY_MAP = {
        0: "Ø§Ù„Ø£Ø­Ø¯", 1: "Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†", 2: "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", 3: "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡", 4: "Ø§Ù„Ø®Ù…ÙŠØ³", 5: "Ø§Ù„Ø¬Ù…Ø¹Ø©", 6: "Ø§Ù„Ø³Ø¨Øª"
    };
     
    const MONTH_MAP = {
        "ÙŠÙ†Ø§ÙŠØ±": 0, "ÙØ¨Ø±Ø§ÙŠØ±": 1, "Ù…Ø§Ø±Ø³": 2, "Ø£Ø¨Ø±ÙŠÙ„": 3, "Ù…Ø§ÙŠÙˆ": 4, "ÙŠÙˆÙ†ÙŠÙˆ": 5, 
        "ÙŠÙˆÙ„ÙŠÙˆ": 6, "Ø£ØºØ³Ø·Ø³": 7, "Ø³Ø¨ØªÙ…Ø¨Ø±": 8, "Ø£ÙƒØªÙˆØ¨Ø±": 9, "Ù†ÙˆÙÙ…Ø¨Ø±": 10, "Ø¯ÙŠØ³Ù…Ø¨Ø±": 11,
        "ÙŠÙ†Ø§ÙŠÙ€Ø±": 0, "ÙØ¨Ø±Ø§ÙŠÙ€Ø±": 1, "Ù…Ù€Ø§Ø±Ø³": 2, "Ø¥Ø¨Ø±ÙŠÙ€Ù„": 3, "Ù…Ø§ÙŠÙ€Ùˆ": 4, "ÙŠÙˆÙ†ÙŠÙ€Ùˆ": 5, 
        "ÙŠÙˆÙ„ÙŠÙ€Ùˆ": 6, "Ø£ØºØ³Ø·Ù€Ø³": 7, "Ø³Ø¨ØªÙ…Ø¨Ù€Ø±": 8, "Ø£ÙƒØªÙˆØ¨Ù€Ø±": 9, "Ù†ÙˆÙÙ…Ø¨Ù€Ø±": 10, "Ø¯ÙŠØ³Ù…Ø¨Ù€Ø±": 11 
    };

    function parseRegistrationDate(timeString) {
        if (!timeString) return null;
        const datePart = timeString.split(' â€“ ')[0].trim();
        const parts = datePart.split(' ');
        if (parts.length < 3) return null;
        const day = parseInt(parts[0]);
        const monthName = parts[1].trim().replace(/[\u200e\u200f\s]/g, ''); 
        const month = MONTH_MAP[monthName];
        const year = parseInt(parts[2]);
        if (isNaN(day) || month === undefined || isNaN(year)) return null;
        const date = new Date(year, month, day);
        date.setHours(0, 0, 0, 0); 
        return date;
    }
    
    // ----------------------------------------------------------------
    // 2. Ø¯ÙˆØ§Ù„ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹ ÙˆØ§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ø´Ù‡Ø±ÙŠØ© 
    // ----------------------------------------------------------------
    
    function getCurrentAttendanceCycle() {
        const today = new Date();
        let startDate, endDate;

        if (today.getDate() <= 25) {
            startDate = new Date(today.getFullYear(), today.getMonth() - 1, 26);
            endDate = new Date(today.getFullYear(), today.getMonth(), 25);
        } else {
            startDate = new Date(today.getFullYear(), today.getMonth(), 26);
            endDate = new Date(today.getFullYear(), today.getMonth() + 1, 25);
        }
        
        startDate.setHours(0, 0, 0, 0); 
        endDate.setHours(23, 59, 59, 999); 

        const dateFormatter = new Intl.DateTimeFormat('ar-EG', { day: 'numeric', month: 'long', year: 'numeric' });
        const startStr = dateFormatter.format(startDate);
        const endStr = dateFormatter.format(endDate);

        return { 
            startDate: startDate,
            endDate: endDate,
            display: `${startStr} Ø­ØªÙ‰ ${endStr}`,
        };
    }

    function calculateWorkingWeeks(startDate, endDate) {
        const weeks = [];
        let currentDate = new Date(startDate);
        currentDate.setHours(0, 0, 0, 0); 
        
        let tempDate = new Date(startDate);
        let startDayIndex = tempDate.getDay(); 
        
        while (startDayIndex !== 6) { 
            tempDate.setDate(tempDate.getDate() - 1);
            startDayIndex = tempDate.getDay();
        }
        currentDate = tempDate; 

        while (currentDate.getTime() <= endDate.getTime() + (7 * 24 * 60 * 60 * 1000)) { 
            let currentWeekDays = [];
            let weekStartDate = new Date(currentDate);

            for (let i = 0; i < 7; i++) {
                const day = new Date(currentDate);
                const arabicDay = JS_DAY_MAP[day.getDay()];

                if (day.getTime() >= startDate.getTime() && day.getTime() <= endDate.getTime()) {
                    const dayInfo = {
                        date: day,
                        dayName: arabicDay,
                        dateKey: day.toDateString(),
                        isWorkingDay: WORKING_DAYS.includes(arabicDay)
                    };
                    currentWeekDays.push(dayInfo);
                    // ØªØ®Ø²ÙŠÙ† Ø§Ù„ÙŠÙˆÙ… ÙÙŠ Ø§Ù„ÙƒØ§Ø´ Ù„ÙŠØªÙ… Ø§Ø³ØªØ®Ø¯Ø§Ù…Ù‡ Ù„Ø§Ø­Ù‚Ø§Ù‹ ÙÙŠ viewDay
                    cycleDaysCache[dayInfo.dateKey] = dayInfo; 
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            const workingDaysInWeek = currentWeekDays.filter(d => d.isWorkingDay);
            
            if (workingDaysInWeek.length > 0) {
                weeks.push({
                    index: weeks.length + 1,
                    days: workingDaysInWeek, 
                    startDisplay: workingDaysInWeek[0].date.toLocaleDateString('ar-EG', { month: 'short', day: 'numeric' }),
                    endDisplay: workingDaysInWeek[workingDaysInWeek.length - 1].date.toLocaleDateString('ar-EG', { month: 'short', day: 'numeric' }),
                    weekStartDate: weekStartDate.toLocaleDateString('ar-EG'),
                });
            }
        }
        return weeks;
    }

    // ØªÙ‡ÙŠØ¦Ø© Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹
    function initializeWeeksButtons() {
        const cycle = getCurrentAttendanceCycle();
        cycleWeeks = calculateWorkingWeeks(cycle.startDate, cycle.endDate);
        const container = document.getElementById('week-buttons-container');
        container.innerHTML = '';
        
        document.getElementById('week-title-area').textContent = `ğŸ—“ï¸ Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø¶ÙˆØ± Ø­Ø³Ø¨ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ (Ø§Ù„ÙØªØ±Ø©: ${cycle.display})`;

        if (cycleWeeks.length === 0) {
            container.innerHTML = '<p class="status-default-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø§Ø¨ÙŠØ¹ Ø¹Ù…Ù„ ÙƒØ§Ù…Ù„Ø© Ø£Ùˆ Ø¬Ø²Ø¦ÙŠØ© ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙˆØ±Ø©.</p>';
            document.getElementById('week-details').innerHTML = '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø§Ø¨ÙŠØ¹ Ù„Ø¹Ø±Ø¶Ù‡Ø§.</p>';
            return;
        }

        cycleWeeks.forEach(week => {
            const button = document.createElement('button');
            button.id = `btn-week-${week.index}`;
            button.textContent = `Ø£Ø³Ø¨ÙˆØ¹ ${week.index} (${week.startDisplay} - ${week.endDisplay})`;
            button.onclick = () => viewWeek(week);
            container.appendChild(button);
        });
        
        viewWeek(cycleWeeks[0]);
    }


    // ----------------------------------------------------------------
    // 3. ÙˆØ¸ÙŠÙØ© Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ÙˆØ§Ù„Ø£ÙŠØ§Ù…
    // ----------------------------------------------------------------

    async function fetchAttendanceData() {
        const resultArea = document.getElementById('result-area');
        resultArea.innerHTML = '<p style="color:#007bff;">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase...</p>';

        allAttendanceData = {}; 

        try {
            const snapshot = await db.collection("user_attendance").get();

            snapshot.forEach(doc => {
                const data = doc.data();
                const name = data.volunteerName;
                
                let recordDate;
                let recordTimePart = data.registrationTime ? data.registrationTime.split(' â€“ ')[1] : '';

                if (data.registrationDateTimestamp && typeof data.registrationDateTimestamp.toDate === 'function') {
                    recordDate = data.registrationDateTimestamp.toDate();
                } else if (data.registrationTime) {
                    recordDate = parseRegistrationDate(data.registrationTime);
                } else {
                    return;
                }
                
                if(!recordDate) return;
                
                const dateKey = recordDate.toDateString(); 

                if (!allAttendanceData[dateKey]) {
                    allAttendanceData[dateKey] = {};
                }
                
                allAttendanceData[dateKey][name] = { 
                    status: data.status, 
                    reason: data.reason,
                    time: recordTimePart 
                };
            });

            resultArea.innerHTML = `<p class="status-present">âœ… **ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­.** (ØªÙ… Ø¬Ù„Ø¨ ${snapshot.docs.length} Ø³Ø¬Ù„)</p>`;
            
            if(cycleWeeks.length > 0) {
                 const activeWeekButton = document.querySelector('.week-buttons button.active');
                 if (activeWeekButton) {
                     const weekIndexMatch = activeWeekButton.textContent.match(/Ø£Ø³Ø¨ÙˆØ¹ (\d+)/);
                     if (weekIndexMatch) {
                         const weekIndex = parseInt(weekIndexMatch[1]);
                         const activeWeek = cycleWeeks.find(w => w.index === weekIndex);
                         if (activeWeek) {
                              const activeDayButton = document.querySelector('.day-buttons button.active');
                              if (activeDayButton) {
                                  const activeDateKey = activeDayButton.getAttribute('data-date-key');
                                  viewWeek(activeWeek); 
                                  if (activeDateKey) {
                                       viewDay(activeDateKey);
                                       return;
                                  }
                             }
                         }
                     }
                 }
                viewWeek(cycleWeeks[0]);
            }

        } catch (error) {
            resultArea.innerHTML = `<p class="status-absent">âŒ **Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:** ${error.message}</p>`;
            console.error("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ", error);
        }
    }
    
    async function initializeWeeksAndFetchData() {
         initializeWeeksButtons(); 
         await fetchAttendanceData();
    }
    
    // ÙˆØ¸ÙŠÙØ© Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ (Ø§Ù„ØªÙŠ ØªØ­ØªÙˆÙŠ Ø¹Ù„Ù‰ Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£ÙŠØ§Ù…)
    function viewWeek(week) {
        const weekDetailsDiv = document.getElementById('week-details');
        
        document.querySelectorAll('.week-buttons button').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`btn-week-${week.index}`).classList.add('active');
        
        let weekHeader = `
            <h3>Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${week.index}: Ù…Ù† ${week.startDisplay} Ø¥Ù„Ù‰ ${week.endDisplay}</h3>
            <div id="day-buttons-container" class="day-buttons" style="margin-bottom: 15px;">
                <h4>Ø§Ø®ØªØ± Ø§Ù„ÙŠÙˆÙ…:</h4>
        `;
        
        week.days.forEach(dayInfo => {
            const displayDate = dayInfo.date.toLocaleDateString('ar-EG', { month: 'short', day: 'numeric' });
             // ğŸ’¡ Ù†Ù…Ø±Ø± ÙÙ‚Ø· Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ù†ØµÙŠ (dateKey)
            weekHeader += `<button class="day-btn" data-date-key="${dayInfo.dateKey}" onclick="viewDay('${dayInfo.dateKey}')">${dayInfo.dayName} (${displayDate})</button>`; 
        });
        
        weekHeader += `</div><div id="day-attendance-area"></div>`;
        weekDetailsDiv.innerHTML = weekHeader;
        
        // Ø§Ù„Ø§Ù†ØªÙ‚Ø§Ù„ ØªÙ„Ù‚Ø§Ø¦ÙŠØ§Ù‹ Ù„Ø¹Ø±Ø¶ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø£ÙˆÙ„ Ù…Ù† Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹
        if (week.days.length > 0) {
            viewDay(week.days[0].dateKey);
        }
    }

    // ÙˆØ¸ÙŠÙØ© Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ ÙŠÙˆÙ… ÙˆØ§Ø­Ø¯
    function viewDay(dateKey) {
        const dayInfo = cycleDaysCache[dateKey]; 
        if (!dayInfo) return; 
        
        const dayAttendanceArea = document.getElementById('day-attendance-area');
        const arabicDate = dayInfo.date.toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        
        document.querySelectorAll('.day-buttons button').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`button[data-date-key='${dateKey}']`)?.classList.add('active');

        let tableHTML = `
            <h4> Ø­Ø¶ÙˆØ± ÙŠÙˆÙ…: ${arabicDate} </h4>
            <div class="action-buttons">
                <button id="whatsapp-day-button" onclick="sendAttendanceListViaWhatsApp()"> ğŸ“² Ø¥Ø±Ø³Ø§Ù„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø¶ÙˆØ± Ù„ÙŠÙˆÙ… ${dayInfo.dayName} Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨ </button>
            </div>
            <table class="weekly-table" id="daily-attendance-table">
                <thead>
                    <tr>
                        <th style="text-align:right;">Ø§Ù„Ø§Ø³Ù…</th>
                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª/ÙˆÙ‚Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        let finalAttendanceNames = []; // Ù‚Ø§Ø¦Ù…Ø© Ø¨Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ø­Ø§Ø¶Ø±ÙŠÙ† ÙÙ‚Ø· Ù„Ø²Ø± Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨
        
        VOLUNTEER_NAMES_ORDERED.forEach(name => {
            const isFixed = FIXED_VOLUNTEERS[name].includes(dayInfo.dayName);
            const recordedStatus = allAttendanceData[dateKey] ? allAttendanceData[dateKey][name] : null;

            let displayStatus;
            let statusClass = '';
            let notes = '';
            
            const isAttending = (isFixed && (!recordedStatus || recordedStatus.status !== 'Ø§Ø¹ØªØ°Ø§Ø±')) || 
                                (recordedStatus && recordedStatus.status === 'Ø­Ø¶ÙˆØ±');


            if (!isFixed && !recordedStatus) {
                // ØºÙŠØ± Ù…Ø¬Ø¯ÙˆÙ„ ÙˆÙ„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ = ØºÙŠØ± Ù…Ø¬Ø¯ÙˆÙ„
                displayStatus = 'ØºÙŠØ± Ù…Ø¬Ø¯ÙˆÙ„';
                statusClass = 'status-not-scheduled';
                notes = '-';
            } else if (recordedStatus) {
                // ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ (Ø­Ø¶ÙˆØ± Ø£Ùˆ Ø§Ø¹ØªØ°Ø§Ø±)
                notes = recordedStatus.time || recordedStatus.reason || '-';
                if (recordedStatus.status === 'Ø§Ø¹ØªØ°Ø§Ø±') {
                    displayStatus = 'Ø§Ø¹ØªØ°Ø§Ø± âŒ';
                    statusClass = 'status-absent';
                } else { 
                    displayStatus = 'Ø­Ø¶ÙˆØ± âœ…';
                    statusClass = 'status-present';
                }
            } else {
                // Ù…Ø¬Ø¯ÙˆÙ„ ÙˆÙ„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¬Ù„ = Ø­Ø¶ÙˆØ± Ø§ÙØªØ±Ø§Ø¶ÙŠ
                displayStatus = 'Ø­Ø¶ÙˆØ± (Ø§ÙØªØ±Ø§Ø¶ÙŠ) âœ…';
                statusClass = 'status-present';
                notes = 'Ù…Ø¬Ø¯ÙˆÙ„ (Ø§ÙØªØ±Ø§Ø¶ÙŠ)';
            }
            
            if (isAttending) {
                finalAttendanceNames.push(name);
            }

            tableHTML += `
                <tr>
                    <td style="text-align:right;">${name}</td>
                    <td class="${statusClass}">${displayStatus}</td>
                    <td>${notes}</td>
                </tr>
            `;
        });

        tableHTML += `</tbody></table>`;
        dayAttendanceArea.innerHTML = tableHTML;
        
        // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø®Ø§Øµ Ø¨Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨
        currentDayWhatsAppList.names = finalAttendanceNames;
        currentDayWhatsAppList.dayName = dayInfo.dayName;
        currentDayWhatsAppList.dateKey = dateKey;
        
        // ğŸ’¡ ØªØ­Ø¯ÙŠØ« Ø²Ø± Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ù„ÙŠØ¸Ù‡Ø± Ø§Ù„Ø¹Ø¯Ø¯
        document.getElementById('whatsapp-day-button').textContent = `ğŸ“² Ø¥Ø±Ø³Ø§Ù„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø¶ÙˆØ± Ù„ÙŠÙˆÙ… ${dayInfo.dayName} Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨ (${finalAttendanceNames.length} Ù…ØªØ·ÙˆØ¹)`;
    }

    // ----------------------------------------------------------------
    // 4. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ (ØªÙ…Øª Ø§Ø³ØªØ¹Ø§Ø¯ØªÙ‡Ø§ Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù‚Ø¯ÙŠÙ…)
    // ----------------------------------------------------------------

    function getTomorrowDateString() {
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1); 
        const dateString = tomorrow.toLocaleDateString('ar-EG', { day: 'numeric', month: 'long', year: 'numeric' });
        return dateString;
    }

    function sendAttendanceListViaWhatsApp() {
        if (!currentDayWhatsAppList.dayName) return;

        const day = currentDayWhatsAppList.dayName;
        const attendanceList = currentDayWhatsAppList.names;
        
        // ğŸ’¡ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø¯Ø§Ù„Ø© getTomorrowDateString ÙƒÙ…Ø§ ÙƒØ§Ù†Øª ÙÙŠ Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ù‚Ø¯ÙŠÙ…
        const dateString = getTomorrowDateString(); 
        let listText = attendanceList.map((name, index) => `${index + 1}. ${name}`).join('\n');
        
        if (attendanceList.length === 0) {
            listText = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø¶ÙˆØ± Ù…Ø¤ÙƒØ¯ Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ….";
        }
        
        const message = `
ğŸ“Œ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
ğŸ—“ï¸ Ø§Ù„ÙŠÙˆÙ… : ${day} - ${dateString}
ğŸ•’ Ù…Ø¹Ø§Ø¯ Ø§Ù„Ø´ØºÙ„: Ù£ Ø§Ù„Ø¹ØµØ±
ğŸ‘¥ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªØ·ÙˆØ¹ÙŠÙ† : ${attendanceList.length}

---
Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØ·ÙˆØ¹ÙŠÙ† Ø§Ù„Ø­Ø§Ø¶Ø±ÙŠÙ† Ø§Ù„ÙŠÙˆÙ…:
${listText}
`;
        
        const encodedMessage = encodeURIComponent(message.trim());
        const whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
        const sendButton = document.getElementById('whatsapp-day-button');
        sendButton.textContent = 'âœ… Ø¬Ø§Ø±ÙŠ ÙØªØ­ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨...';
        
        window.open(whatsappUrl, '_blank');
        
        setTimeout(() => {
             sendButton.textContent = `ğŸ“² Ø¥Ø±Ø³Ø§Ù„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø¶ÙˆØ± Ù„ÙŠÙˆÙ… ${day} Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨ (${attendanceList.length} Ù…ØªØ·ÙˆØ¹)`;
        }, 5000);
    }
    
    // ----------------------------------------------------------------
    // 5. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ (Ù„Ù… ØªØªØºÙŠØ±)
    // ----------------------------------------------------------------

    function getDaysInCycle(start, end) {
        const cycleDays = [];
        let currentDate = new Date(start);
        currentDate.setHours(0, 0, 0, 0); 
        
        while (currentDate.getTime() <= end.getTime()) { 
            const jsDayIndex = currentDate.getDay();
            const arabicDay = JS_DAY_MAP[jsDayIndex];

            if (WORKING_DAYS.includes(arabicDay)) {
                cycleDays.push({
                    date: new Date(currentDate), 
                    day: arabicDay 
                });
            }
            currentDate.setDate(currentDate.getDate() + 1);
        }
        return cycleDays;
    }
    
    async function calculateMonthlyAttendance() {
        const monthlyReportArea = document.getElementById('monthly-report-area');
        monthlyReportArea.innerHTML = '<p style="color:#007bff;">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ ÙˆÙÙ„ØªØ±Ø© Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØ© Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙ‚Ø±ÙŠØ±...</p>';

        try {
            if (Object.keys(allAttendanceData).length === 0) {
                 await fetchAttendanceData();
            }

            const cycle = getCurrentAttendanceCycle();
            const cycleDays = getDaysInCycle(cycle.startDate, cycle.endDate); 
            
            const CLEAN_REPORT = {};
            VOLUNTEER_NAMES_ORDERED.forEach(name => {
                CLEAN_REPORT[name] = { expected: 0, attended: 0, apologies: 0, absence: 0 };
            });

            const attendanceMap = new Map();
            
            // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªØ´Ù…Ù„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„ÙØ¹Ù„ÙŠ ÙÙŠ Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ø´Ù‡Ø±ÙŠØ©
            for (const dateKey in allAttendanceData) {
                const recordDate = new Date(dateKey);
                // Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù€ cycle.startDate/endDate ÙƒØ£Ø´ÙŠØ§Ø¡ ØªØ§Ø±ÙŠØ® Ù„Ù„Ù…Ù‚Ø§Ø±Ù†Ø©
                if (recordDate.getTime() >= cycle.startDate.getTime() && recordDate.getTime() <= cycle.endDate.getTime()) {
                     for (const name in allAttendanceData[dateKey]) {
                        if (!attendanceMap.has(name)) {
                            attendanceMap.set(name, new Map());
                        }
                        attendanceMap.get(name).set(dateKey, allAttendanceData[dateKey][name].status);
                    }
                }
            }
            
            VOLUNTEER_NAMES_ORDERED.forEach(name => {
                const report = CLEAN_REPORT[name];
                
                let scheduledPresent = 0;
                let scheduledApology = 0;
                let explicitPresent = 0;
                
                cycleDays.forEach(dayInfo => {
                    const dateKey = dayInfo.date.toDateString();
                    const dayArabic = dayInfo.day;
                    const status = attendanceMap.get(name)?.get(dateKey);

                    if (FIXED_VOLUNTEERS[name].includes(dayArabic)) { 
                        report.expected++;
                        
                        if (status === 'Ø­Ø¶ÙˆØ±') {
                            scheduledPresent++; 
                        } else if (status === 'Ø§Ø¹ØªØ°Ø§Ø±') {
                            scheduledApology++; 
                        } else {
                            scheduledPresent++; 
                        }
                    } else { 
                        if (status === 'Ø­Ø¶ÙˆØ±') {
                            explicitPresent++; 
                        }
                    }
                });

                report.attended = scheduledPresent + explicitPresent; 
                report.apologies = scheduledApology; 
                
                report.absence = report.expected - scheduledPresent - scheduledApology;
                
                if (report.expected === 0) {
                     report.absence = 0;
                }
            });

            finalMonthlyReportData.cycleDisplay = cycle.display;
            finalMonthlyReportData.data = CLEAN_REPORT;

            let tableHTML = `
                <h3>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø­Ø¶ÙˆØ± (Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆÙÙ‚Ø§Ù‹ Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¹Ù…Ù„)</h3>
                <div class="monthly-summary">
                    <p>ØªÙ… Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© **"Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„ Ø­Ø§Ø¶Ø± Ù…Ø§ Ù„Ù… ÙŠØ¹ØªØ°Ø±ØŒ ÙˆØ§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ØµØ±ÙŠØ­ ÙŠØ­Ø³Ø¨ Ø¯Ø§Ø¦Ù…Ø§Ù‹"** Ù„Ù„ÙØªØ±Ø©:</p>
                    <p>ğŸ“… **${cycle.display}**</p>
                    <div class="action-buttons" style="margin-bottom: 0;">
                        <button id="copy-monthly-button" onclick="copyMonthlyTableContent()"> Ù†Ø³Ø® Ø§Ù„ØªÙ‚Ø±ÙŠØ± (Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ù…Ø­ØªØ³Ø¨ ÙÙ‚Ø·) </button>
                    </div>
                </div>
                
                <table class="monthly-table">
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ø§Ø³Ù…</th>
                            <th>Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø© (Ù…Ø¬Ø¯ÙˆÙ„)</th>
                            <th>Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ù…Ø­ØªØ³Ø¨ (Ø§Ù„ÙØ¹Ù„ÙŠ + Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ)</th>
                            <th>Ø§Ù„Ø§Ø¹ØªØ°Ø§Ø± Ø§Ù„Ù…Ø³Ø¬Ù„ (Ø§Ù„ÙØ¹Ù„ÙŠ)</th>
                            <th>Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            VOLUNTEER_NAMES_ORDERED.forEach(name => {
                const report = CLEAN_REPORT[name];
                
                tableHTML += `
                    <tr>
                        <td>${name}</td>
                        <td>${report.expected} Ø£ÙŠØ§Ù…</td>
                        <td class="status-present">${report.attended} Ø£ÙŠØ§Ù…</td>
                        <td class="status-absent">${report.apologies} Ø£ÙŠØ§Ù…</td>
                        <td>${report.absence} Ø£ÙŠØ§Ù…</td>
                    </tr>
                `;
            });

            tableHTML += `</tbody></table>`;
            
            monthlyReportArea.innerHTML = tableHTML;
            
        } catch(error) {
             monthlyReportArea.innerHTML = `<p class="status-absent">âŒ **Ø®Ø·Ø£ ÙØ§Ø¯Ø­ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:** ${error.message}. ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Console Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„ØªÙØ§ØµÙŠÙ„.</p>`;
             console.error("Critical Error in Monthly Calculation:", error);
        }
    }

    function copyMonthlyTableContent() {
        if (!finalMonthlyReportData.data || Object.keys(finalMonthlyReportData.data).length === 0) {
             alert('âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ Ø§Ù„Ø¯Ù‚ÙŠÙ‚" Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.');
             return;
        }

        const cycleDisplay = finalMonthlyReportData.cycleDisplay;
        const reportData = finalMonthlyReportData.data;
        
        let textToCopy = `ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ Ù„Ù„ÙØªØ±Ø© ${cycleDisplay}\n\n`;
        textToCopy += '------------------------------------------\n';
        
        VOLUNTEER_NAMES_ORDERED.forEach(name => {
            const report = reportData[name];
            if (report) {
                textToCopy += `${name}\t: ${report.attended} Ø£ÙŠØ§Ù… Ø­Ø¶ÙˆØ±\n`;
            }
        });

        navigator.clipboard.writeText(textToCopy.trim())
            .then(() => {
                alert(`âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ Ø¨Ù†Ø¬Ø§Ø­!`);
            })
            .catch(err => {
                console.error('ÙØ´Ù„ ÙÙŠ Ø§Ù„Ù†Ø³Ø®:', err);
                alert('âŒ ÙØ´Ù„ ÙÙŠ Ù†Ø³Ø® Ø§Ù„ØªÙ‚Ø±ÙŠØ±. Ù‚Ø¯ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ù…ØªØµÙØ­ Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø©.');
            });
    }

    window.onload = initializeWeeksAndFetchData;
</script>

</body>
</html>
