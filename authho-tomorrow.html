<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø§Ù„Ø­Ø¶ÙˆØ± - V3 Pro (Smart Logic)</title>
    <style>
        :root {
            --primary-color: #007bff;
            --sidebar-width: 260px;
            --sidebar-bg: #1e293b;
            --sidebar-text: #f1f5f9;
            --accent-color: #f59e0b;
            --success-color: #10b981;
            --danger-color: #ef4444;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #f3f4f6;
            margin: 0;
            padding: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        /* --- 1. Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© (Sidebar) --- */
        aside.sidebar {
            width: var(--sidebar-width);
            background-color: var(--sidebar-bg);
            color: var(--sidebar-text);
            display: flex;
            flex-direction: column;
            padding: 20px;
            box-shadow: -4px 0 15px rgba(0,0,0,0.2);
            overflow-y: auto;
            flex-shrink: 0;
            z-index: 1000;
            transition: transform 0.3s ease-in-out;
        }

        @media (max-width: 768px) {
            aside.sidebar {
                position: fixed;
                right: 0;
                top: 0;
                height: 100%;
                transform: translateX(100%);
                width: 280px;
            }
            aside.sidebar.active {
                transform: translateX(0);
            }
            .overlay {
                display: none;
                position: fixed;
                top: 0; left: 0; right: 0; bottom: 0;
                background: rgba(0,0,0,0.5);
                z-index: 999;
            }
            .overlay.active { display: block; }
        }

        .brand-box {
            text-align: center;
            padding-bottom: 20px;
            border-bottom: 1px solid rgba(255,255,255,0.1);
            margin-bottom: 20px;
            position: relative;
        }

        .close-sidebar-btn {
            display: none;
            position: absolute;
            left: 0;
            top: 0;
            background: none;
            border: none;
            color: white;
            font-size: 1.5rem;
            cursor: pointer;
        }
        @media (max-width: 768px) { .close-sidebar-btn { display: block; } }

        .version-badge {
            background: linear-gradient(45deg, #f59e0b, #d97706);
            color: white;
            padding: 5px 15px;
            border-radius: 20px;
            font-weight: bold;
            font-size: 1.5rem;
            display: inline-block;
            box-shadow: 0 4px 6px rgba(0,0,0,0.2);
        }
        
        .version-text {
            display: block;
            margin-top: 5px;
            font-size: 0.85rem;
            color: #94a3b8;
            letter-spacing: 1px;
        }

        .stats-box {
            background: rgba(255,255,255,0.05);
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: center;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .stats-number { font-size: 1.8rem; font-weight: bold; color: #38bdf8; display: block; }
        .stats-label { font-size: 0.8rem; color: #cbd5e1; }

        .calendar-wrapper { margin-bottom: 25px; }
        .calendar-title { font-size: 0.9rem; color: var(--accent-color); margin-bottom: 10px; text-align: center; font-weight: bold; }
        .mini-calendar { width: 100%; border-collapse: collapse; font-size: 0.75rem; color: #cbd5e1; }
        .mini-calendar th { color: #64748b; padding: 3px; }
        .mini-calendar td { padding: 5px; text-align: center; border: 1px solid rgba(255,255,255,0.05); }
        .current-day { background-color: var(--primary-color); color: white; border-radius: 4px; font-weight: bold; }

        /* --- 2. Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ --- */
        main.content {
            flex-grow: 1;
            padding: 20px;
            overflow-y: auto;
            position: relative;
            width: 100%;
        }

        .menu-toggle-btn {
            display: none;
            background: none;
            border: none;
            font-size: 2rem;
            cursor: pointer;
            color: #1e293b;
            padding: 0 10px;
        }
        @media (max-width: 768px) { .menu-toggle-btn { display: block; } }

        .header-area {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .container {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            max-width: 1000px;
            margin: 0 auto;
        }

        h1, h2, h3 { color: #1e293b; border-bottom: 2px solid #f1f5f9; padding-bottom: 10px; }
        
        button {
            padding: 10px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: 0.2s;
            background-color: var(--primary-color);
            color: white;
            font-family: inherit;
        }
        button:hover { opacity: 0.9; transform: translateY(-1px); }

        .week-buttons button { background-color: #64748b; margin: 4px; font-size: 0.9rem; }
        .week-buttons button.active { background-color: var(--success-color); box-shadow: 0 0 0 2px rgba(16,185,129,0.3); }

        .day-buttons button { 
            background-color: white; 
            color: #334155; 
            border: 1px solid #cbd5e1;
            margin: 5px; 
            min-width: 120px;
        }
        .day-buttons button.active { 
            background-color: var(--primary-color); 
            color: white; 
            border-color: var(--primary-color);
        }

        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { padding: 12px; border: 1px solid #e2e8f0; text-align: center; }
        th { background-color: #f8fafc; color: #475569; }
        
        .status-present { background-color: #dcfce7; color: #166534; font-weight: bold; }
        .status-absent { background-color: #fee2e2; color: #991b1b; font-weight: bold; }
        .status-ns { background-color: #f1f5f9; color: #94a3b8; font-size: 0.85em; }

        #whatsapp-day-button { background-color: #25D366; width: 100%; margin-top: 15px; display: block; font-size: 1.1rem; }
        #copy-monthly-button { background-color: var(--accent-color); color: white; margin-bottom: 15px; }

        .alert-box {
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: bold;
        }
        .alert-info { background-color: #e0f2fe; color: #0369a1; border: 1px solid #bae6fd; }
        .alert-success { background-color: #dcfce7; color: #15803d; border: 1px solid #bbf7d0; }
        
        .cycle-info {
            background: #fffbeb;
            border: 1px solid #fcd34d;
            color: #92400e;
            padding: 10px;
            border-radius: 6px;
            text-align: center;
            margin-bottom: 15px;
            font-size: 0.9rem;
        }

    </style>
    
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
</head>
<body>

    <div class="overlay" onclick="toggleSidebar()"></div>

    <aside class="sidebar" id="sidebar">
        <div class="brand-box">
            <button class="close-sidebar-btn" onclick="toggleSidebar()">âœ•</button>
            <div class="version-badge">V 3.0</div>
            <span class="version-text">Ù†Ø¸Ø§Ù… Ø§Ù„Ù…ØªØ·ÙˆØ¹ÙŠÙ† Ø§Ù„Ø°ÙƒÙŠ</span>
        </div>

        <div class="stats-box">
            <span id="fetched-count" class="stats-number">0</span>
            <span class="stats-label">Ø³Ø¬Ù„ ØªÙ… ØªØ­Ù„ÙŠÙ„Ù‡</span>
        </div>

        <div class="calendar-wrapper">
            <div id="cal-current-title" class="calendar-title"></div>
            <div id="cal-current-body"></div>
        </div>

        <div class="calendar-wrapper">
            <div id="cal-next-title" class="calendar-title"></div>
            <div id="cal-next-body"></div>
        </div>
    </aside>

    <main class="content">
        <div class="container">
            <div class="header-area">
                <div style="display:flex; align-items:center; gap:10px;">
                    <button class="menu-toggle-btn" onclick="toggleSidebar()">&#8942;</button>
                    <h1 style="margin:0; border:none; font-size: 1.5rem;">ğŸ—“ï¸ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø¶ÙˆØ±</h1>
                </div>
                <button onclick="initializeWeeksAndFetchData()">ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
            </div>

            <div id="status-message" class="alert-box alert-info" style="display:none;"></div>
            
            <div id="cycle-display-area" class="cycle-info">Ø¬Ø§Ø±ÙŠ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø¯ÙˆØ±Ø©...</div>

            <div id="week-buttons-container" class="week-buttons" style="margin-bottom: 20px; display:flex; flex-wrap:wrap; justify-content:center;">
                <p>Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</p>
            </div>

            <div id="week-view-area"></div>

            <hr style="margin: 30px 0; border-top: 1px dashed #cbd5e1;">

            <h2 onclick="calculateMonthlyAttendance()" style="cursor:pointer; font-size:1.2rem; color: #475569;">
                ğŸ“Š Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ (Ø§Ø¶ØºØ· Ù‡Ù†Ø§ Ù„Ù„Ø­Ø³Ø§Ø¨)
            </h2>
            <div id="monthly-report-area"></div>
        </div>
    </main>

<script>
    // --- Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase ---
    const firebaseConfig = {
        apiKey: "AIzaSyCDJANXMfd6TR7R2ruLIi-xytlrB-LiCEs", 
        authDomain: "rdtt-15cbe.firebaseapp.com",
        projectId: "rdtt-15cbe",
        storageBucket: "rdtt-15cbe.firebasestorage.app",
        messagingSenderId: "219502671343",
        appId: "1:219502671343:web:b289b11869e25c9a30321a"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();

    // --- Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø«Ø§Ø¨ØªØ© ÙˆØ§Ù„Ù…ÙˆØ§Ø¹ÙŠØ¯ ---
    const WORKING_DAYS = ["Ø§Ù„Ø³Ø¨Øª", "Ø§Ù„Ø£Ø­Ø¯", "Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†", "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡", "Ø§Ù„Ø®Ù…ÙŠØ³"];
    
    // ğŸ’¡ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØ·ÙˆØ¹ÙŠÙ† (ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„: ÙƒÙ„ Ù…ØªØ·ÙˆØ¹ ÙÙŠ Ø³Ø·Ø± Ù„ØªØ³Ù‡ÙŠÙ„ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„)
    const FIXED_VOLUNTEERS = {
        "Ø£Ø­Ù…Ø¯":             WORKING_DAYS,
        "Ù…Ø­Ù…Ø¯ Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…":    WORKING_DAYS,
        "Ù…Ù…ØªØ§Ø²":            WORKING_DAYS,
        "Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…":          ["Ø§Ù„Ø³Ø¨Øª", "Ø§Ù„Ø£Ø­Ø¯", "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡"],
        "Ù…Ø¹Ø§Ø°":             ["Ø§Ù„Ø£Ø­Ø¯", "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", "Ø§Ù„Ø®Ù…ÙŠØ³"],
        "Ø³Ø§Ù…Ù‰":             ["Ø§Ù„Ø³Ø¨Øª", "Ø§Ù„Ø£Ø­Ø¯", "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡"],
        "Ù…Ø¹ØªØ²":             WORKING_DAYS,
        "Ù…Ø§Ø²Ù†":             WORKING_DAYS,
        "Ø­Ø¨ÙŠØ¨Ø©":            WORKING_DAYS,
        "Ø±Ø­Ø§Ø¨":             ["Ø§Ù„Ø³Ø¨Øª", "Ø§Ù„Ø£Ø­Ø¯", "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡"],
        "Ø³Ø§Ù†Ø¯ÙŠ":            ["Ø§Ù„Ø³Ø¨Øª", "Ø§Ù„Ø£Ø­Ø¯", "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡", "Ø§Ù„Ø®Ù…ÙŠØ³"],
        "Ø³Ø¬Ø¯Ø©":             WORKING_DAYS,
        "Ø´Ù…Ø³":              WORKING_DAYS
    };

    // Ø§Ù„ØªØ±ØªÙŠØ¨ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨ Ù„Ù„Ø¹Ø±Ø¶
    const VOLUNTEER_NAMES_ORDERED = Object.keys(FIXED_VOLUNTEERS);
    
    // Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø¹Ø§Ù…Ø©
    let allAttendanceData = {};
    let cycleWeeks = [];
    let cycleDaysCache = {};
    let currentWhatsappData = {};
    let finalReportData = {};
    let currentCycleInfo = {};

    const DAY_MAP = { 0: "Ø§Ù„Ø£Ø­Ø¯", 1: "Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†", 2: "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", 3: "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡", 4: "Ø§Ù„Ø®Ù…ÙŠØ³", 5: "Ø§Ù„Ø¬Ù…Ø¹Ø©", 6: "Ø§Ù„Ø³Ø¨Øª" };
    const MONTH_MAP = {
        "ÙŠÙ†Ø§ÙŠØ±": 0, "ÙØ¨Ø±Ø§ÙŠØ±": 1, "Ù…Ø§Ø±Ø³": 2, "Ø£Ø¨Ø±ÙŠÙ„": 3, "Ù…Ø§ÙŠÙˆ": 4, "ÙŠÙˆÙ†ÙŠÙˆ": 5, 
        "ÙŠÙˆÙ„ÙŠÙˆ": 6, "Ø£ØºØ³Ø·Ø³": 7, "Ø³Ø¨ØªÙ…Ø¨Ø±": 8, "Ø£ÙƒØªÙˆØ¨Ø±": 9, "Ù†ÙˆÙÙ…Ø¨Ø±": 10, "Ø¯ÙŠØ³Ù…Ø¨Ø±": 11,
        "ÙŠÙ†Ø§ÙŠÙ€Ø±": 0, "ÙØ¨Ø±Ø§ÙŠÙ€Ø±": 1, "Ù…Ù€Ø§Ø±Ø³": 2, "Ø¥Ø¨Ø±ÙŠÙ€Ù„": 3, "Ù…Ø§ÙŠÙ€Ùˆ": 4, "ÙŠÙˆÙ†ÙŠÙ€Ùˆ": 5, 
        "ÙŠÙˆÙ„ÙŠÙ€Ùˆ": 6, "Ø£ØºØ³Ø·Ù€Ø³": 7, "Ø³Ø¨ØªÙ…Ø¨Ù€Ø±": 8, "Ø£ÙƒØªÙˆØ¨Ù€Ø±": 9, "Ù†ÙˆÙÙ…Ø¨Ù€Ø±": 10, "Ø¯ÙŠØ³Ù…Ø¨Ù€Ø±": 11 
    };

    // --- Ø¯ÙˆØ§Ù„ Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„Ù„ØªÙˆØ§Ø±ÙŠØ® ---

    function formatDateKey(date) {
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, '0');
        const d = String(date.getDate()).padStart(2, '0');
        return `${y}-${m}-${d}`;
    }

    function parseRegistrationDate(data) {
        let recordDate = null;
        if (data.dateKey && data.dateKey.match(/^\d{4}-\d{2}-\d{2}$/)) {
            recordDate = new Date(data.dateKey); 
        } else if (data.registrationDateTimestamp && typeof data.registrationDateTimestamp.toDate === 'function') {
            recordDate = data.registrationDateTimestamp.toDate();
        } else if (data.registrationTime) {
            const timeString = data.registrationTime;
            const datePart = timeString.split(' â€“ ')[0].trim();
            const parts = datePart.split(' ');
            if (parts.length >= 3) {
                const day = parseInt(parts[0]);
                const monthName = parts[1].trim().replace(/[\u200e\u200f\s]/g, ''); 
                const month = MONTH_MAP[monthName];
                const year = parseInt(parts[2]);
                if (!isNaN(day) && month !== undefined && !isNaN(year)) {
                    recordDate = new Date(year, month, day);
                }
            }
        }
        if (recordDate && !isNaN(recordDate)) {
             recordDate.setHours(0, 0, 0, 0); 
             return recordDate;
        }
        return null;
    }

    // --- Ø¯ÙˆØ§Ù„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ---
    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('active');
        document.querySelector('.overlay').classList.toggle('active');
    }

    function renderCalendar(date, containerId, titleId) {
        const arMonths = ["ÙŠÙ†Ø§ÙŠØ±", "ÙØ¨Ø±Ø§ÙŠØ±", "Ù…Ø§Ø±Ø³", "Ø£Ø¨Ø±ÙŠÙ„", "Ù…Ø§ÙŠÙˆ", "ÙŠÙˆÙ†ÙŠÙˆ", "ÙŠÙˆÙ„ÙŠÙˆ", "Ø£ØºØ³Ø·Ø³", "Ø³Ø¨ØªÙ…Ø¨Ø±", "Ø£ÙƒØªÙˆØ¨Ø±", "Ù†ÙˆÙÙ…Ø¨Ø±", "Ø¯ÙŠØ³Ù…Ø¨Ø±"];
        const year = date.getFullYear();
        const month = date.getMonth();
        document.getElementById(titleId).innerText = `${arMonths[month]} ${year}`;
        const firstDay = new Date(year, month, 1);
        const lastDay = new Date(year, month + 1, 0);
        let html = '<table class="mini-calendar"><thead><tr><th>Ø­</th><th>Ù†</th><th>Ø«</th><th>Ø±</th><th>Ø®</th><th>Ø¬</th><th>Ø³</th></tr></thead><tbody><tr>';
        for(let i=0; i<firstDay.getDay(); i++) html += '<td></td>';
        const today = new Date();
        for(let d=1; d<=lastDay.getDate(); d++) {
            const curr = new Date(year, month, d);
            const isToday = (curr.toDateString() === today.toDateString());
            html += `<td class="${isToday ? 'current-day' : ''}">${d}</td>`;
            if(curr.getDay() === 6) html += '</tr><tr>';
        }
        html += '</tr></tbody></table>';
        document.getElementById(containerId).innerHTML = html;
    }

    function initSidebar() {
        const now = new Date();
        renderCalendar(now, 'cal-current-body', 'cal-current-title');
        renderCalendar(new Date(now.getFullYear(), now.getMonth()+1, 1), 'cal-next-body', 'cal-next-title');
    }

    // --- Ù…Ù†Ø·Ù‚ Ø§Ù„Ø¯ÙˆØ±Ø© ÙˆØ§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹ ---

    function getCycleDates() {
        const today = new Date();
        let start, end;
        if (today.getDate() <= 25) {
            start = new Date(today.getFullYear(), today.getMonth() - 1, 26);
            end = new Date(today.getFullYear(), today.getMonth(), 25);
        } else {
            start = new Date(today.getFullYear(), today.getMonth(), 26);
            end = new Date(today.getFullYear(), today.getMonth() + 1, 25);
        }
        start.setHours(0,0,0,0); end.setHours(23,59,59,999);
        
        const formatter = new Intl.DateTimeFormat('ar-EG', { day: 'numeric', month: 'long' });
        return { start, end, label: `${formatter.format(start)} Ø¥Ù„Ù‰ ${formatter.format(end)}` };
    }

    function buildWeeks(start, end) {
        let curr = new Date(start);
        
        let tempDate = new Date(start);
        while (tempDate.getDay() !== 6) {
            tempDate.setDate(tempDate.getDate() - 1);
        }
        curr = tempDate;

        cycleWeeks = [];
        cycleDaysCache = {};

        while(curr <= end) {
            let weekDays = [];
            for(let i=0; i<7; i++) {
                let d = new Date(curr);
                let arDay = DAY_MAP[d.getDay()];
                let key = formatDateKey(d);
                
                const isInCycle = d >= start && d <= end;
                const isWork = WORKING_DAYS.includes(arDay);

                let info = { date: d, dayName: arDay, dateKey: key, isWork: isWork, inCycle: isInCycle };
                
                if (isInCycle) {
                    weekDays.push(info);
                    cycleDaysCache[key] = info;
                }
                
                curr.setDate(curr.getDate() + 1);
            }
            
            if(weekDays.length > 0) {
                cycleWeeks.push({ 
                    id: cycleWeeks.length+1, 
                    days: weekDays,
                    label: `${weekDays[0].date.getDate()}/${weekDays[0].date.getMonth()+1} - ${weekDays[weekDays.length-1].date.getDate()}/${weekDays[weekDays.length-1].date.getMonth()+1}`
                });
            }
        }
    }

    // --- Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ---

    function renderWeeksButtons() {
        const container = document.getElementById('week-buttons-container');
        container.innerHTML = '';
        if(cycleWeeks.length === 0) { container.innerHTML = 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø§Ø¨ÙŠØ¹ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙˆØ±Ø©'; return; }
        
        cycleWeeks.forEach(w => {
            let btn = document.createElement('button');
            btn.id = `wk-btn-${w.id}`;
            btn.innerHTML = `Ø£Ø³Ø¨ÙˆØ¹ ${w.id}<br><span style="font-size:0.75em; opacity:0.8">${w.label}</span>`;
            btn.onclick = () => showWeek(w);
            container.appendChild(btn);
        });
    }

    async function fetchAttendanceData() {
        const msgDiv = document.getElementById('status-message');
        msgDiv.style.display = 'block';
        msgDiv.className = 'alert-box alert-info';
        msgDiv.innerText = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø§ØªØµØ§Ù„ Ø¨Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª...';
        
        try {
            const snap = await db.collection("user_attendance").get();
            let raw = [];
            snap.forEach(doc => raw.push({ id: doc.id, ...doc.data() }));
            
            raw.sort((a,b) => (a.timestamp?.seconds || 0) - (b.timestamp?.seconds || 0));
            
            allAttendanceData = {};
            let countInCycle = 0;

            raw.forEach(rec => {
                let d = parseRegistrationDate(rec);
                if(!d) return;
                
                let key = formatDateKey(d);
                
                if(!cycleDaysCache[key]) return;
                
                countInCycle++;
                if(!allAttendanceData[key]) allAttendanceData[key] = {};
                
                allAttendanceData[key][rec.volunteerName] = { 
                    status: rec.status, 
                    reason: rec.reason || '', 
                    time: rec.registrationTime ? rec.registrationTime.split(' â€“ ')[1] : '' 
                };
            });
            
            document.getElementById('fetched-count').innerText = countInCycle;
            msgDiv.className = 'alert-box alert-success';
            msgDiv.innerText = 'âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¨Ù†Ø¬Ø§Ø­';
            setTimeout(() => msgDiv.style.display = 'none', 3000);
            
            jumpToTomorrow();

        } catch(e) {
            msgDiv.className = 'alert-box alert-danger';
            msgDiv.style.backgroundColor = '#fee2e2';
            msgDiv.style.color = '#991b1b';
            msgDiv.innerText = 'Ø®Ø·Ø£: ' + e.message;
        }
    }

    function jumpToTomorrow() {
        const today = new Date();
        const tomorrow = new Date(today);
        tomorrow.setDate(today.getDate() + 1);

        const tomorrowKey = formatDateKey(tomorrow);
        let targetWeek = cycleWeeks.find(w => w.days.some(d => d.dateKey === tomorrowKey));
        
        if(targetWeek) {
            showWeek(targetWeek);
            setTimeout(() => {
                const dayBtn = document.querySelector(`button[data-key="${tomorrowKey}"]`);
                if(dayBtn) dayBtn.click();
            }, 100);
        } else {
            if(cycleWeeks.length > 0) showWeek(cycleWeeks[cycleWeeks.length - 1]);
        }
    }

    async function initializeWeeksAndFetchData() {
        initSidebar();
        currentCycleInfo = getCycleDates();
        
        document.getElementById('cycle-display-area').innerHTML = 
            `<strong>Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©:</strong> ${currentCycleInfo.label}`;
            
        buildWeeks(currentCycleInfo.start, currentCycleInfo.end);
        renderWeeksButtons();
        await fetchAttendanceData();
    }

    function showWeek(week) {
        document.querySelectorAll('.week-buttons button').forEach(b => b.classList.remove('active'));
        document.getElementById(`wk-btn-${week.id}`)?.classList.add('active');
        
        const area = document.getElementById('week-view-area');
        let html = `<div class="day-buttons" style="display:flex; flex-wrap:wrap; justify-content:center; margin-bottom:15px;">`;
        
        week.days.filter(d => d.isWork).forEach(d => {
            html += `<button data-key="${d.dateKey}" onclick="showDay('${d.dateKey}')">${d.dayName}<br>${d.date.getDate()}/${d.date.getMonth()+1}</button>`;
        });
        
        html += `</div><div id="day-detail-area"></div>`;
        area.innerHTML = html;
        
        const firstWorkDay = week.days.find(d => d.isWork);
        if(firstWorkDay) showDay(firstWorkDay.dateKey);
    }

    function showDay(key) {
        document.querySelectorAll('.day-buttons button').forEach(b => b.classList.remove('active'));
        const btn = document.querySelector(`button[data-key="${key}"]`);
        if(btn) btn.classList.add('active');
        
        const info = cycleDaysCache[key];
        const container = document.getElementById('day-detail-area');
        
        if(!info) { container.innerHTML = '<p>ØªØ§Ø±ÙŠØ® Ø®Ø§Ø±Ø¬ Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ©</p>'; return; }

        let html = `
            <div style="background:white; border-radius:8px; padding:15px; box-shadow:0 2px 4px rgba(0,0,0,0.05);">
            <h3 style="text-align:center; color:#1e293b; margin-top:0;">ØªÙØ§ØµÙŠÙ„ ÙŠÙˆÙ… ${info.dayName} (${info.date.toLocaleDateString('ar-EG')})</h3>
            <table>
                <thead><tr><th style="text-align:right">Ø§Ù„Ø§Ø³Ù…</th><th>Ø§Ù„Ø­Ø§Ù„Ø©</th><th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª</th></tr></thead>
                <tbody>
        `;
        
        let whatsappNames = [];
        
        VOLUNTEER_NAMES_ORDERED.forEach(name => {
            const isScheduled = FIXED_VOLUNTEERS[name].includes(info.dayName);
            const record = allAttendanceData[key]?.[name];
            
            let statusTxt = "", statusClass = "", note = "-";
            let isPresent = false;

            if (!isScheduled && !record) {
                statusTxt = "ØºÙŠØ± Ù…Ø¬Ø¯ÙˆÙ„"; statusClass = "status-ns";
            } else if (record) {
                if (record.status === 'Ø§Ø¹ØªØ°Ø§Ø±') {
                    statusTxt = "Ø§Ø¹ØªØ°Ø§Ø± âŒ"; statusClass = "status-absent"; note = record.reason;
                } else {
                    statusTxt = "Ø­Ø¶ÙˆØ± âœ…"; statusClass = "status-present"; note = record.time || 'ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„';
                    isPresent = true;
                }
            } else {
                statusTxt = "Ø­Ø¶ÙˆØ± (ØªÙ„Ù‚Ø§Ø¦ÙŠ)"; statusClass = "status-present"; note = "Ù„Ù… ÙŠØ³Ø¬Ù„ (Ù…Ø¬Ø¯ÙˆÙ„)";
                isPresent = true;
            }

            if(isPresent) whatsappNames.push(name);

            html += `<tr>
                <td style="font-weight:bold;">${name}</td>
                <td class="${statusClass}">${statusTxt}</td>
                <td style="font-size:0.9em;">${note}</td>
            </tr>`;
        });
        
        html += `</tbody></table>`;
        html += `<button id="whatsapp-day-button" onclick="sendWhatsapp()">ğŸ“² Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ÙˆØ§ØªØ³Ø§Ø¨ (${whatsappNames.length})</button></div>`;
        
        container.innerHTML = html;
        currentWhatsappData = {
            date: info.date.toLocaleDateString('ar-EG', {weekday:'long', month:'long', day:'numeric'}),
            names: whatsappNames
        };
    }

    function sendWhatsapp() {
        if(!currentWhatsappData.names) return;
        const list = currentWhatsappData.names.map((n,i) => `${i+1}. ${n}`).join('\n');
        const text = `ğŸ“Œ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ…ÙŠØ©\nğŸ—“ï¸ ${currentWhatsappData.date}\nğŸ•’ Ø§Ù„Ù…ÙˆØ¹Ø¯: Ù£ Ø§Ù„Ø¹ØµØ±\nğŸ‘¥ Ø§Ù„Ø¹Ø¯Ø¯: ${currentWhatsappData.names.length}\n\n${list || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø¶ÙˆØ±'}`;
        window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
    }

    // --- Ù…Ù†Ø·Ù‚ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ ---

    function calculateMonthlyAttendance() {
        const area = document.getElementById('monthly-report-area');
        area.innerHTML = '<p class="alert-box alert-info">Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ø¯Ù‚Ø©...</p>';
        
        const allDaysKeys = Object.keys(cycleDaysCache).sort();
        
        let html = `
            <div style="background:#f0fdf4; padding:15px; border:1px solid #bbf7d0; margin-bottom:15px; border-radius:8px;">
                ÙØªØ±Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ±: <strong>${currentCycleInfo.label}</strong>
                <br><small>Ø§Ù„Ù‚Ø§Ø¹Ø¯Ø©: Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„ Ø­Ø§Ø¶Ø± Ù…Ø§ Ù„Ù… ÙŠØ¹ØªØ°Ø±ØŒ ÙˆØ§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ø¥Ø¶Ø§ÙÙŠ ÙŠØ­Ø³Ø¨.</small>
            </div>
            <button id="copy-monthly-button" onclick="copyReport()">ğŸ“‹ Ù†Ø³Ø® Ù…Ù„Ø®Øµ Ø§Ù„Ø­Ø¶ÙˆØ±</button>
            <table class="monthly-table">
                <thead><tr><th>Ø§Ù„Ø§Ø³Ù…</th><th>Ø£ÙŠØ§Ù… Ø§Ù„Ø¹Ù…Ù„</th><th>Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ù…Ø­ØªØ³Ø¨</th><th>Ø§Ù„Ø§Ø¹ØªØ°Ø§Ø±</th><th>Ù„Ù… ÙŠØ³Ø¬Ù„ (Ø­Ø§Ø¶Ø±)</th></tr></thead>
                <tbody>
        `;
        
        finalReportData = {};

        VOLUNTEER_NAMES_ORDERED.forEach(name => {
            let expected = 0;
            let attended = 0;
            let apologies = 0;
            let autoAttended = 0;

            allDaysKeys.forEach(key => {
                const dayInfo = cycleDaysCache[key];
                const isScheduled = FIXED_VOLUNTEERS[name].includes(dayInfo.dayName);
                const record = allAttendanceData[key]?.[name];
                const status = record?.status;

                if (isScheduled) {
                    expected++;
                    if (status === 'Ø§Ø¹ØªØ°Ø§Ø±') {
                        apologies++;
                    } else if (status === 'Ø­Ø¶ÙˆØ±') {
                        attended++;
                    } else {
                        attended++;
                        autoAttended++;
                    }
                } else {
                    if (status === 'Ø­Ø¶ÙˆØ±') {
                        attended++;
                    }
                }
            });

            finalReportData[name] = attended;

            html += `<tr>
                <td>${name}</td>
                <td>${expected}</td>
                <td class="status-present" style="font-size:1.1em">${attended}</td>
                <td class="status-absent">${apologies}</td>
                <td style="color:#64748b">${autoAttended}</td>
            </tr>`;
        });
        html += '</tbody></table>';
        area.innerHTML = html;
    }

    function copyReport() {
        let txt = `ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ (${currentCycleInfo.label})\n------------------\n`;
        VOLUNTEER_NAMES_ORDERED.forEach(n => {
            if(finalReportData[n] !== undefined) txt += `${n}: ${finalReportData[n]} Ø£ÙŠØ§Ù…\n`;
        });
        navigator.clipboard.writeText(txt).then(() => alert('ØªÙ… Ø§Ù„Ù†Ø³Ø® Ù„Ù„Ø­Ø§ÙØ¸Ø©!'));
    }

    window.onload = initializeWeeksAndFetchData;
</script>
</body>
</html>
