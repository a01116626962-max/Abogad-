<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ</title>
    <style>
        /* Ø§Ù„Ø£Ù†Ù…Ø§Ø· (CSS) */
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f4f4f9;
            color: #333;
            margin: 0;
            padding: 20px;
            text-align: right;
            direction: rtl;
        }
        .container {
            max-width: 900px;
            margin: 0 auto;
            background: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        h1, h2, h3 {
            color: #007bff;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-top: 20px;
        }
        .action-buttons {
            margin-bottom: 20px;
        }
        button {
            padding: 10px 15px;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
            transition: background-color 0.3s;
            background-color: #007bff; /* Ø²Ø± Ø§Ù„ØªØ­Ø¯ÙŠØ« */
        }
        button:hover {
            opacity: 0.9;
        }
        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£ÙŠØ§Ù… */
        .day-buttons button {
            background-color: #6c757d;
            margin: 5px;
            font-weight: bold;
        }
        .day-buttons button.active {
            background-color: #28a745; /* Ø£Ø®Ø¶Ø± Ù„Ù„Ø¯Ù„Ø§Ù„Ø© Ø¹Ù„Ù‰ Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ù…Ø®ØªØ§Ø± */
        }
        /* Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø£ÙŠØ§Ù… */
        .day-table, .monthly-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        .day-table th, .day-table td, .monthly-table th, .monthly-table td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: right;
        }
        .day-table th, .monthly-table th {
            background-color: #f2f2f2;
            color: #333;
        }
        .status-absent {
            color: #dc3545; 
            font-weight: bold;
        }
        .status-present {
            color: #28a745; 
            font-weight: bold;
        }
        .status-default-muted {
            color: #999; 
            font-style: italic;
        }
        .monthly-summary {
            background-color: #e9f7ef;
            border: 1px solid #c8e6c9;
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
        }
        .monthly-summary .note {
            color:#dc3545;
            font-weight:bold;
        }
        /* Ø§Ù„Ø²Ø± Ø§Ù„Ø«Ø§Ø¨Øª */
        #static-whatsapp-button {
            display: block;
            width: 100%;
            padding: 15px;
            margin-top: 20px;
            background-color: #075E54; 
            font-size: 1.1em;
        }
        /* Ø²Ø± Ø§Ù„Ù†Ø³Ø® Ø§Ù„Ø¬Ø¯ÙŠØ¯ (Ù„Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ) */
        #copy-monthly-button {
            background-color: #ffc107; /* Ù„ÙˆÙ† Ø£ØµÙØ± ÙˆØ§Ø¶Ø­ */
            color: #333;
            margin-left: 0;
            margin-right: 10px;
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
</head>
<body>

<div class="container">
    <h1>ğŸ—“ï¸ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ…ÙŠ</h1>
    
    <div id="result-area" style="margin-top:15px; padding:10px; border:1px solid #eee;">
        <p style="color:#007bff;">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„" Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ø§Ù„Ø¥Ù†ØªØ±Ù†Øª.</p>
    </div>

    <div class="action-buttons">
        <button onclick="fetchAttendanceData()">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
    </div>

    <hr>

    <h2>ğŸ—“ï¸ Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø¶ÙˆØ± Ø­Ø³Ø¨ Ø§Ù„ÙŠÙˆÙ… (Ù„Ù„Ø­Ø§Ø¶Ø±ÙŠÙ† Ø£Ùˆ Ø§Ù„Ù…Ø¹ØªØ°Ø±ÙŠÙ†)</h2>

    <div class="day-buttons">
        <button id="btn-Ø§Ù„Ø³Ø¨Øª" onclick="viewDay('Ø§Ù„Ø³Ø¨Øª')">Ø§Ù„Ø³Ø¨Øª</button>
        <button id="btn-Ø§Ù„Ø£Ø­Ø¯" onclick="viewDay('Ø§Ù„Ø£Ø­Ø¯')">Ø§Ù„Ø£Ø­Ø¯</button>
        <button id="btn-Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†" onclick="viewDay('Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†')">Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†</button>
        <button id="btn-Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡" onclick="viewDay('Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡')">Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡</button>
        <button id="btn-Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡" onclick="viewDay('Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡')">Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡</button>
        <button id="btn-Ø§Ù„Ø®Ù…ÙŠØ³" onclick="viewDay('Ø§Ù„Ø®Ù…ÙŠØ³')">Ø§Ù„Ø®Ù…ÙŠØ³</button>
    </div>

    <div id="day-details">
        <p>Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± ÙŠÙˆÙ… Ù„Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØªØ·ÙˆØ¹ÙŠÙ†.</p>
    </div>
    
    <button id="static-whatsapp-button" onclick="sendAttendanceListViaWhatsApp()" disabled>
        ğŸ“² ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ÙŠÙˆÙ… Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø¶ÙˆØ±
    </button>

    <hr>

    <h2 onclick="calculateMonthlyAttendance()" style="cursor:pointer;">ğŸ“Š Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ Ø§Ù„Ø¯Ù‚ÙŠÙ‚ (Ø§Ø¶ØºØ· Ù„Ù„Ø­Ø³Ø§Ø¨)</h2>
    <div id="monthly-report-area">
        <p>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø£Ø¹Ù„Ø§Ù‡ Ù„Ø­Ø³Ø§Ø¨ Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ø¹ØªØ°Ø§Ø± Ù„Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ø´Ù‡Ø±ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© (26 - 25).</p>
    </div>
</div>

<script>
    // âš ï¸ Ù…ÙØ§ØªÙŠØ­ Firebase Ø§Ù„Ø®Ø§ØµØ© Ø¨Ù…Ø´Ø±ÙˆØ¹Ùƒ Ø§Ù„Ø¹Ø§Ù…Ù„ (rdtt-15cbe) - ØªØ£ÙƒØ¯ Ù…Ù† ØµØ­ØªÙ‡Ø§
    const firebaseConfig = {
        apiKey: "AIzaSyCDJANXMfd6TR7R2ruLIi-xytlrB-LiCEs", 
        authDomain: "rdtt-15cbe.firebaseapp.com",
        projectId: "rdtt-15cbe",
        storageBucket: "rdtt-15cbe.firebasestorage.app",
        messagingSenderId: "219502671343",
        appId: "1:219502671343:web:b289b11869e25c9a30321a"
    };

    // ØªÙ‡ÙŠØ¦Ø© Firebase ÙˆØ§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Firestore
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    
    // ----------------------------------------------------------------
    // 1. Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø«Ø§Ø¨ØªØ© ÙˆØ§Ù„Ù…Ø¬Ø¯ÙˆÙ„Ø© 
    // ----------------------------------------------------------------
    const WORKING_DAYS = ["Ø§Ù„Ø³Ø¨Øª", "Ø§Ù„Ø£Ø­Ø¯", "Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†", "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡", "Ø§Ù„Ø®Ù…ÙŠØ³"];
    const ALL_WORKING_DAYS = WORKING_DAYS; 

    const FIXED_VOLUNTEERS = {
        "Ø£Ø­Ù…Ø¯": ALL_WORKING_DAYS, "Ù‡Ø¯ÙŠØ±": ALL_WORKING_DAYS, "Ù…Ø­Ù…Ø¯ Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…": ALL_WORKING_DAYS, 
        "Ù…Ø­Ù…Ø¯ Ø¹Ø¨Ø¯Ø§Ù„Ø­Ù…ÙŠØ¯": ALL_WORKING_DAYS, "Ø³Ø§Ù…Ù‰": ["Ø§Ù„Ø³Ø¨Øª", "Ø§Ù„Ø£Ø­Ø¯", "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡"], 
        "Ù…Ù…ØªØ§Ø²": ALL_WORKING_DAYS, "Ø­Ø¨ÙŠØ¨Ø©": ALL_WORKING_DAYS, "Ø³Ø§Ù†Ø¯ÙŠ": [],
        "Ø±Ø­Ø§Ø¨": ["Ø§Ù„Ø³Ø¨Øª", "Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†", "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡"], "Ù…Ø¹Ø§Ø°": ["Ø§Ù„Ø£Ø­Ø¯", "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", "Ø§Ù„Ø®Ù…ÙŠØ³"], 
        "Ù…Ø§Ø²Ù†": ALL_WORKING_DAYS, "ÙŠÙˆØ³Ù": [], "Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…": ALL_WORKING_DAYS, 
        "Ù…Ø±ÙˆØ§Ù†": [], "Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù†": [], "Ù…Ø¹ØªØ²": ALL_WORKING_DAYS 
    };
    
    const VOLUNTEER_NAMES_ORDERED = Object.keys(FIXED_VOLUNTEERS);
    
    let currentAttendanceData = {}; 
    let selectedDay = null;
    let currentAttendanceList = [];
    
    let finalMonthlyReportData = { cycleDisplay: '', data: {} };

    const JS_DAY_MAP = {
        0: "Ø§Ù„Ø£Ø­Ø¯", 1: "Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†", 2: "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", 3: "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡", 4: "Ø§Ù„Ø®Ù…ÙŠØ³", 5: "Ø§Ù„Ø¬Ù…Ø¹Ø©", 6: "Ø§Ù„Ø³Ø¨Øª"
    };

    // Ø®Ø±ÙŠØ·Ø© Ø§Ù„Ø´Ù‡ÙˆØ± (Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙÙ‚Ø·)
    const MONTH_MAP = {
        "ÙŠÙ†Ø§ÙŠØ±": 0, "ÙØ¨Ø±Ø§ÙŠØ±": 1, "Ù…Ø§Ø±Ø³": 2, "Ø£Ø¨Ø±ÙŠÙ„": 3, "Ù…Ø§ÙŠÙˆ": 4, "ÙŠÙˆÙ†ÙŠÙˆ": 5, 
        "ÙŠÙˆÙ„ÙŠÙˆ": 6, "Ø£ØºØ³Ø·Ø³": 7, "Ø³Ø¨ØªÙ…Ø¨Ø±": 8, "Ø£ÙƒØªÙˆØ¨Ø±": 9, "Ù†ÙˆÙÙ…Ø¨Ø±": 10, "Ø¯ÙŠØ³Ù…Ø¨Ø±": 11,
        "ÙŠÙ†Ø§ÙŠÙ€Ø±": 0, "ÙØ¨Ø±Ø§ÙŠÙ€Ø±": 1, "Ù…Ù€Ø§Ø±Ø³": 2, "Ø¥Ø¨Ø±ÙŠÙ€Ù„": 3, "Ù…Ø§ÙŠÙ€Ùˆ": 4, "ÙŠÙˆÙ†ÙŠÙ€Ùˆ": 5, 
        "ÙŠÙˆÙ„ÙŠÙ€Ùˆ": 6, "Ø£ØºØ³Ø·Ù€Ø³": 7, "Ø³Ø¨ØªÙ…Ø¨Ù€Ø±": 8, "Ø£ÙƒØªÙˆØ¨Ù€Ø±": 9, "Ù†ÙˆÙÙ…Ø¨Ù€Ø±": 10, "Ø¯ÙŠØ³Ù…Ø¨Ù€Ø±": 11 
    };

    // Ø¯Ø§Ù„Ø© ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†ØµÙŠ (Ù„Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ù‚Ø¯ÙŠÙ…Ø© ÙÙ‚Ø·)
    function parseRegistrationDate(timeString) {
        if (!timeString) return null;
        const datePart = timeString.split(' â€“ ')[0].trim();
        const parts = datePart.split(' ');
        if (parts.length < 3) return null;
        const day = parseInt(parts[0]);
        const monthName = parts[1].trim().replace(/[\u200e\u200f\s]/g, ''); 
        const month = MONTH_MAP[monthName];
        const year = parseInt(parts[2]);
        if (isNaN(day) || month === undefined || isNaN(year)) return null;
        const date = new Date(year, month, day);
        date.setHours(0, 0, 0, 0); 
        return date;
    }

    // ----------------------------------------------------------------
    // 2. ÙˆØ¸ÙŠÙØ© Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase ÙˆØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„ (Ù„Ù… ØªØªØºÙŠØ±)
    // ----------------------------------------------------------------
    async function fetchAttendanceData() {
        const resultArea = document.getElementById('result-area');
        resultArea.style.display = 'block';
        resultArea.innerHTML = '<p style="color:#007bff;">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase...</p>';

        currentAttendanceData = {}; 

        try {
            const snapshot = await db.collection("user_attendance").get();

            snapshot.forEach(doc => {
                const data = doc.data();
                const name = data.volunteerName;
                const day = data.day;

                if (!currentAttendanceData[name]) {
                    currentAttendanceData[name] = {};
                }
                
                currentAttendanceData[name][day] = { 
                    status: data.status, 
                    reason: data.reason,
                    registrationTime: data.registrationTime // Ù†Øµ Ø§Ù„ØªØ§Ø±ÙŠØ®
                };
            });

            resultArea.innerHTML = `<p class="status-present">âœ… **ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­.** (ØªÙ… Ø¬Ù„Ø¨ ${snapshot.docs.length} Ø³Ø¬Ù„)</p>`;
            
            if(selectedDay) {
                viewDay(selectedDay); 
            }

        } catch (error) {
            resultArea.innerHTML = `<p class="status-absent">âŒ **Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:** ${error.message}</p>`;
            console.error("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ", error);
        }
    }

    // ----------------------------------------------------------------
    // 3. ÙˆØ¸ÙŠÙØ© Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙŠÙˆÙ… (Ù„Ù… ØªØªØºÙŠØ±)
    // ----------------------------------------------------------------
    function viewDay(day) {
        // ... (ÙƒÙˆØ¯ Ø¹Ø±Ø¶ ØªÙØ§ØµÙŠÙ„ Ø§Ù„ÙŠÙˆÙ…) ...
        const dayDetailsDiv = document.getElementById('day-details');
        
        document.querySelectorAll('.day-buttons button').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`btn-${day}`).classList.add('active');
        
        selectedDay = day;

        let tableHTML = `
            <h3>Ø¬Ø¯ÙˆÙ„ ÙŠÙˆÙ… ${day}</h3>
            <table class="day-table">
                <thead>
                    <tr>
                        <th>Ø§Ù„Ø§Ø³Ù…</th>
                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª / Ø§Ù„Ø³Ø¨Ø¨</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        let finalAttendanceList = []; 
        
        VOLUNTEER_NAMES_ORDERED.forEach(name => {
            const isFixed = FIXED_VOLUNTEERS[name] && FIXED_VOLUNTEERS[name].includes(day);
            const recordedStatus = currentAttendanceData[name] && currentAttendanceData[name][day];

            let displayStatus;
            let statusClass;
            let reason = '';
            
            if (recordedStatus) {
                reason = recordedStatus.status === 'Ø§Ø¹ØªØ°Ø§Ø±' ? recordedStatus.reason : '';
                const timeDisplay = recordedStatus.registrationTime ? ` (Ø³ÙØ¬Ù‘Ù„: ${recordedStatus.registrationTime.split(' â€“ ')[1]})` : '';

                if (recordedStatus.status === 'Ø§Ø¹ØªØ°Ø§Ø±') {
                    displayStatus = `âŒ Ø§Ø¹ØªØ°Ø§Ø± Ø·Ø§Ø±Ø¦${timeDisplay}`;
                    statusClass = 'status-absent';
                } else { 
                    displayStatus = `âœ… Ø­Ø¶ÙˆØ± Ù…Ø¤ÙƒØ¯ (ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„)${timeDisplay}`;
                    statusClass = 'status-present';
                }
            } else {
                if (isFixed) {
                    displayStatus = 'âœ… Ø­Ø¶ÙˆØ± Ù…Ø¤ÙƒØ¯ (Ø¬Ø¯ÙˆÙ„ Ø«Ø§Ø¨Øª)'; 
                    statusClass = 'status-present'; 
                } else {
                    displayStatus = '--- ØºÙŠØ± Ù…Ø¬Ø¯ÙˆÙ„';
                    statusClass = 'status-default-muted'; 
                }
            }
            
            const isAttending = (isFixed && (!recordedStatus || recordedStatus.status !== 'Ø§Ø¹ØªØ°Ø§Ø±')) || 
                                (recordedStatus && recordedStatus.status === 'Ø­Ø¶ÙˆØ±');

            if (isAttending) {
                finalAttendanceList.push(name);
            }

            tableHTML += `
                <tr>
                    <td>${name}</td>
                    <td class="${statusClass}">${displayStatus}</td>
                    <td>${reason || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯'}</td>
                </tr>
            `;
        });


        tableHTML += `</tbody></table>`;
        
        dayDetailsDiv.innerHTML = tableHTML;
        
        currentAttendanceList = finalAttendanceList;
        updateStaticWhatsAppButton(day, finalAttendanceList);
    }
    
    // ----------------------------------------------------------------
    // 5. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ (Ù…Ù†Ø·Ù‚ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¬Ø¯ÙŠØ¯ ÙˆØ§Ù„Ù…Ø¹Ø¯Ù„)
    // ----------------------------------------------------------------
    
    function getCurrentAttendanceCycle() {
        const today = new Date();
        let startDate, endDate;

        // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙŠÙˆÙ… <= 25ØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø³Ø§Ø¨Ù‚
        if (today.getDate() <= 25) {
            startDate = new Date(today.getFullYear(), today.getMonth() - 1, 26);
            endDate = new Date(today.getFullYear(), today.getMonth(), 25);
        } else {
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙŠÙˆÙ… > 25ØŒ Ù†Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø­Ø§Ù„ÙŠ
            startDate = new Date(today.getFullYear(), today.getMonth(), 26);
            endDate = new Date(today.getFullYear(), today.getMonth() + 1, 25);
        }
        
        // Ø¥Ø¹Ø§Ø¯Ø© ØªØ¹ÙŠÙŠÙ† Ø§Ù„ÙˆÙ‚Øª
        startDate.setHours(0, 0, 0, 0); 
        endDate.setHours(23, 59, 59, 999); 

        const dateFormatter = new Intl.DateTimeFormat('ar-EG', { day: 'numeric', month: 'long', year: 'numeric' });
        const startStr = dateFormatter.format(startDate);
        const endStr = dateFormatter.format(endDate);

        return { 
            startDate: startDate.getTime(), // Ø±Ù‚Ù… Ø¨Ø§Ù„Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ©
            endDate: endDate.getTime(),     // Ø±Ù‚Ù… Ø¨Ø§Ù„Ù…Ù„Ù„ÙŠ Ø«Ø§Ù†ÙŠØ©
            display: `${startStr} Ø­ØªÙ‰ ${endStr}`,
            startDateObj: startDate, // ÙƒØ§Ø¦Ù† Ø§Ù„ØªØ§Ø±ÙŠØ®
            endDateObj: endDate      // ÙƒØ§Ø¦Ù† Ø§Ù„ØªØ§Ø±ÙŠØ®
        };
    }

    function getDaysInCycle(start, end) {
        const cycleDays = [];
        let currentDate = new Date(start);
        currentDate.setHours(0, 0, 0, 0); 
        
        while (currentDate.getTime() <= end.getTime()) { 
            const jsDayIndex = currentDate.getDay();
            const arabicDay = JS_DAY_MAP[jsDayIndex];

            if (WORKING_DAYS.includes(arabicDay)) {
                cycleDays.push({
                    date: new Date(currentDate), 
                    day: arabicDay 
                });
            }
            currentDate.setDate(currentDate.getDate() + 1);
        }
        return cycleDays;
    }
    
    async function calculateMonthlyAttendance() {
        const monthlyReportArea = document.getElementById('monthly-report-area');
        monthlyReportArea.innerHTML = '<p style="color:#007bff;">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ ÙˆÙÙ„ØªØ±Ø© Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØ© Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙ‚Ø±ÙŠØ±...</p>';

        try {
            const cycle = getCurrentAttendanceCycle();
            const cycleDays = getDaysInCycle(cycle.startDateObj, cycle.endDateObj); 
            
            const CLEAN_REPORT = {};
            VOLUNTEER_NAMES_ORDERED.forEach(name => {
                CLEAN_REPORT[name] = { expected: 0, attended: 0, apologies: 0, absence: 0 };
            });

            // 1. Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØªØ¬Ù…ÙŠØ¹Ù‡Ø§
            const snapshot = await db.collection("user_attendance").get();
            const attendanceMap = new Map();
            
            snapshot.docs.forEach(doc => {
                const data = doc.data();
                const name = data.volunteerName;
                
                let recordTimeMs;
                
                // ğŸ¯ Ù†Ù‚Ø·Ø© Ø§Ù„Ø¥ØµÙ„Ø§Ø­: Ø§Ù„ØªØ­Ù‚Ù‚ Ø§Ù„Ø¢Ù…Ù† Ù…Ù† Ø­Ù‚Ù„ Ø§Ù„Ù€ Timestamp 
                if (data.registrationDateTimestamp && typeof data.registrationDateTimestamp.toDate === 'function') {
                    // Ø³Ø¬Ù„ Ø¬Ø¯ÙŠØ¯ Ù…Ø¹ Timestamp Ø³Ù„ÙŠÙ…
                    recordTimeMs = data.registrationDateTimestamp.toDate().getTime();
                } else if (data.registrationTime) {
                    // Ø³Ø¬Ù„ Ù‚Ø¯ÙŠÙ… ÙŠØ¹ØªÙ…Ø¯ Ø¹Ù„Ù‰ ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†Øµ Ø§Ù„Ø¹Ø±Ø¨ÙŠ
                    const recordDate = parseRegistrationDate(data.registrationTime);
                    if (recordDate) recordTimeMs = recordDate.getTime();
                }

                if (recordTimeMs && recordTimeMs >= cycle.startDate && recordTimeMs <= cycle.endDate) {
                    const recordDate = new Date(recordTimeMs);
                    const dateKey = recordDate.toDateString(); 
                    
                    if (!attendanceMap.has(name)) {
                        attendanceMap.set(name, new Map());
                    }
                    
                    attendanceMap.get(name).set(dateKey, data.status);
                }
            });
            
            // 2. ØªØ·Ø¨ÙŠÙ‚ Ù…Ù†Ø·Ù‚ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ÙŠÙˆÙ…ÙŠ 
            cycleDays.forEach(dayInfo => {
                const dateKey = dayInfo.date.toDateString();
                const dayArabic = dayInfo.day;
                
                VOLUNTEER_NAMES_ORDERED.forEach(name => {
                    const isFixed = FIXED_VOLUNTEERS[name].includes(dayArabic);
                    const status = attendanceMap.get(name)?.get(dateKey); 
                    const report = CLEAN_REPORT[name];

                    if (isFixed) {
                        report.expected++;
                    }

                    // Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø§Ø¬Ø© Ù„Ø­Ø³Ø§Ø¨ attended/apologies Ù‡Ù†Ø§
                });
            });

            // 3. Ø­Ø³Ø§Ø¨ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ø¹ØªØ°Ø§Ø± ÙˆØ§Ù„ØºÙŠØ§Ø¨ Ø¨Ø¯Ù‚Ø©
            VOLUNTEER_NAMES_ORDERED.forEach(name => {
                const report = CLEAN_REPORT[name];
                
                let scheduledPresent = 0;
                let scheduledApology = 0;
                let explicitPresent = 0;
                let explicitApology = 0;
                
                cycleDays.forEach(dayInfo => {
                    const dateKey = dayInfo.date.toDateString();
                    const dayArabic = dayInfo.day;
                    const status = attendanceMap.get(name)?.get(dateKey);

                    if (FIXED_VOLUNTEERS[name].includes(dayArabic)) { // 1. Ù…Ø¬Ø¯ÙˆÙ„
                        if (status === 'Ø­Ø¶ÙˆØ±') {
                            scheduledPresent++; // Ø­Ø¶ÙˆØ± ØµØ±ÙŠØ­ Ù…Ø¬Ø¯ÙˆÙ„
                        } else if (status === 'Ø§Ø¹ØªØ°Ø§Ø±') {
                            scheduledApology++; // Ø§Ø¹ØªØ°Ø§Ø± ØµØ±ÙŠØ­ Ù…Ø¬Ø¯ÙˆÙ„
                        } else {
                            scheduledPresent++; // Ø­Ø¶ÙˆØ± Ø§ÙØªØ±Ø§Ø¶ÙŠ Ù…Ø¬Ø¯ÙˆÙ„ (Ù„Ù… ÙŠØ³Ø¬Ù„ Ø´ÙŠØ¦Ø§Ù‹)
                        }
                    } else { // 2. ØºÙŠØ± Ù…Ø¬Ø¯ÙˆÙ„
                        if (status === 'Ø­Ø¶ÙˆØ±') {
                            explicitPresent++; // Ø­Ø¶ÙˆØ± ØµØ±ÙŠØ­ ØºÙŠØ± Ù…Ø¬Ø¯ÙˆÙ„
                        } else if (status === 'Ø§Ø¹ØªØ°Ø§Ø±') {
                            explicitApology++; // Ø§Ø¹ØªØ°Ø§Ø± ØµØ±ÙŠØ­ ØºÙŠØ± Ù…Ø¬Ø¯ÙˆÙ„
                        }
                    }
                });

                // Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ù…Ø­ØªØ³Ø¨ = (Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ ÙˆØ§Ù„Ù…Ø¤ÙƒØ¯) + (Ø§Ù„Ø­Ø¶ÙˆØ± ØºÙŠØ± Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ù…Ø¤ÙƒØ¯)
                report.attended = scheduledPresent + explicitPresent; 
                
                // Ø§Ù„Ø§Ø¹ØªØ°Ø§Ø± Ø§Ù„Ù…Ø³Ø¬Ù„ = (Ø§Ù„Ø§Ø¹ØªØ°Ø§Ø± Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„) + (Ø§Ù„Ø§Ø¹ØªØ°Ø§Ø± ØºÙŠØ± Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„)
                report.apologies = scheduledApology + explicitApology;

                // Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„ = Ø§Ù„Ù…ØªÙˆÙ‚Ø¹ - (Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„ Ø§Ù„ÙØ¹Ù„ÙŠ ÙˆØ§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ) - (Ø§Ù„Ø§Ø¹ØªØ°Ø§Ø± Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„)
                report.absence = report.expected - scheduledPresent - scheduledApology;
                
                if (report.expected === 0) {
                     report.absence = 0;
                }
            });

            // âœ… ØªØ®Ø²ÙŠÙ† Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙÙŠ Ø§Ù„Ù…ØªØºÙŠØ± Ø§Ù„Ø¹Ø§Ù… Ù„Ù„Ù†Ø³Ø®
            finalMonthlyReportData.cycleDisplay = cycle.display;
            finalMonthlyReportData.data = CLEAN_REPORT;


            // 4. Ø¹Ø±Ø¶ Ø§Ù„Ù†ØªØ§Ø¦Ø¬ + Ø²Ø± Ø§Ù„Ù†Ø³Ø®
            let tableHTML = `
                <h3>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø­Ø¶ÙˆØ± (Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆÙÙ‚Ø§Ù‹ Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¹Ù…Ù„)</h3>
                <div class="monthly-summary">
                    <p>ØªÙ… Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© **"Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„ Ø­Ø§Ø¶Ø± Ù…Ø§ Ù„Ù… ÙŠØ¹ØªØ°Ø±ØŒ ÙˆØ§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ØµØ±ÙŠØ­ ÙŠØ­Ø³Ø¨ Ø¯Ø§Ø¦Ù…Ø§Ù‹"** Ù„Ù„ÙØªØ±Ø©:</p>
                    <p>ğŸ“… **${cycle.display}**</p>
                    <div class="action-buttons" style="margin-bottom: 0;">
                        <button id="copy-monthly-button" onclick="copyMonthlyTableContent()"> Ù†Ø³Ø® Ø§Ù„ØªÙ‚Ø±ÙŠØ± (Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ù…Ø­ØªØ³Ø¨ ÙÙ‚Ø·) </button>
                    </div>
                </div>
                
                <table class="monthly-table">
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ø§Ø³Ù…</th>
                            <th>Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø© (Ù…Ø¬Ø¯ÙˆÙ„)</th>
                            <th>Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ù…Ø­ØªØ³Ø¨ (Ø§Ù„ÙØ¹Ù„ÙŠ + Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ)</th>
                            <th>Ø§Ù„Ø§Ø¹ØªØ°Ø§Ø± Ø§Ù„Ù…Ø³Ø¬Ù„ (Ø§Ù„ÙØ¹Ù„ÙŠ)</th>
                            <th>Ø§Ù„ØºÙŠØ§Ø¨ Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„*</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            VOLUNTEER_NAMES_ORDERED.forEach(name => {
                const report = CLEAN_REPORT[name];
                
                tableHTML += `
                    <tr>
                        <td>${name}</td>
                        <td>${report.expected} Ø£ÙŠØ§Ù…</td>
                        <td class="status-present">${report.attended} Ø£ÙŠØ§Ù…</td>
                        <td class="status-absent">${report.apologies} Ø£ÙŠØ§Ù…</td>
                        <td>${report.absence} Ø£ÙŠØ§Ù…</td>
                    </tr>
                `;
            });

            tableHTML += `</tbody></table>`;
            
            monthlyReportArea.innerHTML = tableHTML;
            
        } catch(error) {
             monthlyReportArea.innerHTML = `<p class="status-absent">âŒ **Ø®Ø·Ø£ ÙØ§Ø¯Ø­ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:** ${error.message}. ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Console Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„ØªÙØ§ØµÙŠÙ„.</p>`;
             console.error("Critical Error in Monthly Calculation:", error);
        }
    }

    /**
     * ÙˆØ¸ÙŠÙØ© Ù†Ø³Ø® Ù…Ø­ØªÙˆÙ‰ Ø¬Ø¯ÙˆÙ„ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ Ø¥Ù„Ù‰ Ø§Ù„Ø­Ø§ÙØ¸Ø©
     */
    function copyMonthlyTableContent() {
        if (!finalMonthlyReportData.data || Object.keys(finalMonthlyReportData.data).length === 0) {
             alert('âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ Ø§Ù„Ø¯Ù‚ÙŠÙ‚" Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.');
             return;
        }

        const cycleDisplay = finalMonthlyReportData.cycleDisplay;
        const reportData = finalMonthlyReportData.data;
        
        let textToCopy = `ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ Ù„Ù„ÙØªØ±Ø© ${cycleDisplay}\n\n`;
        textToCopy += '------------------------------------------\n';
        
        VOLUNTEER_NAMES_ORDERED.forEach(name => {
            const report = reportData[name];
            if (report) {
                textToCopy += `${name}\t${report.attended} Ø£ÙŠØ§Ù…\n`;
            }
        });

        navigator.clipboard.writeText(textToCopy.trim())
            .then(() => {
                alert(`âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ Ø¨Ù†Ø¬Ø§Ø­!`);
            })
            .catch(err => {
                console.error('ÙØ´Ù„ ÙÙŠ Ø§Ù„Ù†Ø³Ø®:', err);
                alert('âŒ ÙØ´Ù„ ÙÙŠ Ù†Ø³Ø® Ø§Ù„ØªÙ‚Ø±ÙŠØ±. Ù‚Ø¯ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ù…ØªØµÙØ­ Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø©.');
            });
    }

    // ----------------------------------------------------------------
    // 4. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ (Ù„Ù… ØªØªØºÙŠØ±)
    // ----------------------------------------------------------------

    function getTomorrowDateString() {
        const tomorrow = new Date();
        tomorrow.setDate(tomorrow.getDate() + 1); 
        const dateString = tomorrow.toLocaleDateString('ar-EG', { day: 'numeric', month: 'long', year: 'numeric' });
        return dateString;
    }

    function updateStaticWhatsAppButton(day, list) {
        const staticButton = document.getElementById('static-whatsapp-button');
        if (day && list) {
            staticButton.disabled = false;
            staticButton.textContent = `ğŸ“² Ø¥Ø±Ø³Ø§Ù„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø¶ÙˆØ± Ù„ÙŠÙˆÙ… ${day} Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨ (${list.length} Ù…ØªØ·ÙˆØ¹)`;
            staticButton.style.backgroundColor = '#075E54';
        } else {
             staticButton.disabled = true;
             staticButton.textContent = 'ğŸ“² ÙŠØ±Ø¬Ù‰ Ø§Ø®ØªÙŠØ§Ø± ÙŠÙˆÙ… Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø¹Ø±Ø¶ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø¶ÙˆØ±';
             staticButton.style.backgroundColor = '#6c757d';
        }
    }

    function sendAttendanceListViaWhatsApp() {
        if (!selectedDay) return;

        const day = selectedDay;
        const attendanceList = currentAttendanceList;
        const dateString = getTomorrowDateString(); 
        let listText = attendanceList.map((name, index) => `${index + 1}. ${name}`).join('\n');
        
        if (attendanceList.length === 0) {
            listText = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø¶ÙˆØ± Ù…Ø¤ÙƒØ¯ Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ….";
        }
        
        const message = `
ğŸ“Œ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
ğŸ—“ï¸ Ø§Ù„ÙŠÙˆÙ… : ${day} - ${dateString}
ğŸ•’ Ù…Ø¹Ø§Ø¯ Ø§Ù„Ø´ØºÙ„: Ù£ Ø§Ù„Ø¹ØµØ±
ğŸ‘¥ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªØ·ÙˆØ¹ÙŠÙ† : ${attendanceList.length}

---
Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØ·ÙˆØ¹ÙŠÙ† Ø§Ù„Ø­Ø§Ø¶Ø±ÙŠÙ† Ø§Ù„ÙŠÙˆÙ…:
${listText}
`;
        
        const encodedMessage = encodeURIComponent(message.trim());
        const whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
        const sendButton = document.getElementById('static-whatsapp-button');
        sendButton.textContent = 'âœ… Ø¬Ø§Ø±ÙŠ ÙØªØ­ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨...';
        
        window.open(whatsappUrl, '_blank');
        
        setTimeout(() => {
             sendButton.textContent = `ğŸ“² Ø¥Ø±Ø³Ø§Ù„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø¶ÙˆØ± Ù„ÙŠÙˆÙ… ${day} Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨ (${attendanceList.length} Ù…ØªØ·ÙˆØ¹)`;
        }, 5000);
    }
    
    // Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©ØŒ Ø§Ø·Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹
    window.onload = fetchAttendanceData;
</script>

</body>
</html>
