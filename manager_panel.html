<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ÙŠ ÙˆØ§Ù„Ø´Ù‡Ø±ÙŠ</title>
    <style>
        /* (Ø§Ù„Ø£Ù†Ù…Ø§Ø· CSS Ù„Ù… ØªØªØºÙŠØ± Ø¹Ù† Ø§Ù„ÙƒÙˆØ¯ Ø§Ù„Ø£Ø®ÙŠØ±) */
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f4f4f9;
            color: #333;
            margin: 0;
            padding: 20px;
            text-align: right;
            direction: rtl;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            background: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        h1, h2, h3 {
            color: #007bff;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-top: 20px;
        }
        .action-buttons {
            margin-bottom: 20px;
        }
        button {
            padding: 10px 15px;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin-left: 10px;
            transition: background-color 0.3s;
            background-color: #007bff;
        }
        button:hover {
            opacity: 0.9;
        }
        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹ */
        .week-buttons button {
            background-color: #6c757d;
            margin: 5px;
            font-weight: bold;
        }
        .week-buttons button.active {
            background-color: #28a745;
        }
        /* Ø£Ø²Ø±Ø§Ø± Ø§Ù„Ø£ÙŠØ§Ù… */
        .day-buttons button {
            background-color: #17a2b8;
            margin: 5px 5px 5px 0;
            font-weight: normal;
        }
        .day-buttons button.active {
            background-color: #007bff;
        }

        /* Ø¬Ø¯Ø§ÙˆÙ„ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ÙˆØ§Ù„Ø£ÙŠØ§Ù… */
        .weekly-table, .monthly-table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
            font-size: 0.95em;
        }
        .weekly-table th, .weekly-table td, .monthly-table th, .monthly-table td {
            border: 1px solid #ddd;
            padding: 8px;
            text-align: center; 
        }
        .weekly-table th, .monthly-table th {
            background-color: #f2f2f2;
            color: #333;
        }
        .weekly-table thead th:first-child, .monthly-table thead th:first-child {
            text-align: right;
        }
        /* Ø­Ø§Ù„Ø§Øª Ø§Ù„Ø¬Ø¯ÙˆÙ„ */
        .status-absent {
            background-color: #f8d7da; 
            color: #721c24; 
            font-weight: bold;
        }
        .status-present {
            background-color: #d4edda; 
            color: #155724; 
            font-weight: bold;
        }
        .status-not-scheduled {
            background-color: #f9f9f9;
            color: #ccc;
            font-size: 0.8em;
        }
        /* ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ */
        .monthly-summary {
            background-color: #e9f7ef;
            border: 1px solid #c8e6c9;
            padding: 15px;
            border-radius: 4px;
            margin-top: 15px;
        }
        #copy-monthly-button {
            background-color: #ffc107; 
            color: #333;
            margin-left: 0;
            margin-right: 10px;
        }
        #whatsapp-day-button {
             background-color: #075E54;
             margin-left: 0;
             display: block;
             width: 100%;
             padding: 15px;
             margin-top: 20px;
             font-size: 1.1em;
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/8.6.8/firebase-firestore.js"></script>
</head>
<body>

<div class="container">
    <h1>ğŸ—“ï¸ Ø¬Ø¯ÙˆÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ</h1>
    
    <div id="result-area" style="margin-top:15px; padding:10px; border:1px solid #eee;">
        <p style="color:#007bff;">Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ "ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„" Ù„Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.</p>
    </div>

    <div class="action-buttons">
        <button onclick="initializeWeeksAndFetchData()">ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ù…Ù† Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
    </div>

    <hr>

    <h2 id="week-title-area">ğŸ—“ï¸ Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø¶ÙˆØ± Ø­Ø³Ø¨ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹</h2>

    <div id="week-buttons-container" class="week-buttons">
        <p>Ø¬Ø§Ø±ÙŠ ØªØ­Ù…ÙŠÙ„ Ø£Ø³Ø§Ø¨ÙŠØ¹ Ø§Ù„Ø¯ÙˆØ±Ø©...</p>
    </div>

    <div id="week-details">
        <p>Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ø®ØªÙŠØ§Ø± Ø£Ø³Ø¨ÙˆØ¹ Ù„Ø¹Ø±Ø¶ Ø­Ø§Ù„Ø© Ø§Ù„Ù…ØªØ·ÙˆØ¹ÙŠÙ†.</p>
    </div>
    
    <hr>

    <h2 onclick="calculateMonthlyAttendance()" style="cursor:pointer;">ğŸ“Š Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ Ø§Ù„Ø¯Ù‚ÙŠÙ‚ (Ø§Ø¶ØºØ· Ù„Ù„Ø­Ø³Ø§Ø¨)</h2>
    <div id="monthly-report-area">
        <p>Ø§Ø¶ØºØ· Ø¹Ù„Ù‰ Ø§Ù„Ø¹Ù†ÙˆØ§Ù† Ø£Ø¹Ù„Ø§Ù‡ Ù„Ø­Ø³Ø§Ø¨ Ø£ÙŠØ§Ù… Ø§Ù„Ø­Ø¶ÙˆØ± ÙˆØ§Ù„Ø§Ø¹ØªØ°Ø§Ø± Ù„Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ø´Ù‡Ø±ÙŠØ© Ø§Ù„Ø­Ø§Ù„ÙŠØ© (26 - 25).</p>
    </div>
</div>

<script>
    // âš ï¸ Ù…ÙØ§ØªÙŠØ­ Firebase (ØªÙ… ØªÙˆØ­ÙŠØ¯Ù‡Ø§ ÙˆØªØµØ­ÙŠØ­Ù‡Ø§)
    const firebaseConfig = {
        apiKey: "AIzaSyCDJANXMfd6TR7R2ruLIi-xytlrB-LiCEs", 
        authDomain: "rdtt-15cbe.firebaseapp.com",
        projectId: "rdtt-15cbe",
        storageBucket: "rdtt-15cbe.firebasestorage.app",
        messagingSenderId: "219502671343",
        appId: "1:219502671343:web:b289b11869e25c9a30321a"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    
    // ----------------------------------------------------------------
    // 1. Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„Ø«Ø§Ø¨ØªØ© ÙˆØ§Ù„Ø¬Ø¯ÙˆÙ„Ø©
    // ----------------------------------------------------------------
    const WORKING_DAYS = ["Ø§Ù„Ø³Ø¨Øª", "Ø§Ù„Ø£Ø­Ø¯", "Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†", "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡", "Ø§Ù„Ø®Ù…ÙŠØ³"];

    const FIXED_VOLUNTEERS = {
        "Ø£Ø­Ù…Ø¯": WORKING_DAYS, "Ù‡Ø¯ÙŠØ±": WORKING_DAYS, "Ù…Ø­Ù…Ø¯ Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…": WORKING_DAYS, 
         "Ø³Ø§Ù…Ù‰": ["Ø§Ù„Ø³Ø¨Øª", "Ø§Ù„Ø£Ø­Ø¯", "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡"], 
        "Ù…Ù…ØªØ§Ø²": WORKING_DAYS, "Ø­Ø¨ÙŠØ¨Ø©": WORKING_DAYS, "Ø³Ø§Ù†Ø¯ÙŠ": [],
        "Ø±Ø­Ø§Ø¨": ["Ø§Ù„Ø³Ø¨Øª", "Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†", "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡"], "Ù…Ø¹Ø§Ø°": ["Ø§Ù„Ø£Ø­Ø¯", "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", "Ø§Ù„Ø®Ù…ÙŠØ³"], 
        "Ù…Ø§Ø²Ù†": WORKING_DAYS, "ÙŠÙˆØ³Ù": [], "Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…": WORKING_DAYS, 
        "Ù…Ø±ÙˆØ§Ù†": [], "Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù†": [], "Ù…Ø¹ØªØ²": WORKING_DAYS , "Ø³Ø¬Ø¯Ø©": WORKING_DAYS
    };
    
    const VOLUNTEER_NAMES_ORDERED = Object.keys(FIXED_VOLUNTEERS);
    
    let allAttendanceData = {}; 
    let cycleWeeks = []; 
    let finalMonthlyReportData = { cycleDisplay: '', data: {} }; 
    let currentDayWhatsAppList = { names: [], dayName: null, dateKey: null };
    let cycleDaysCache = {}; // Ù„ØªØ®Ø²ÙŠÙ† Ù…Ø¹Ù„ÙˆÙ…Ø§Øª ÙƒÙ„ ÙŠÙˆÙ… Ø¹Ù…Ù„ ÙÙŠ Ø§Ù„Ø¯ÙˆØ±Ø©

    const JS_DAY_MAP = {
        0: "Ø§Ù„Ø£Ø­Ø¯", 1: "Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†", 2: "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", 3: "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡", 4: "Ø§Ù„Ø®Ù…ÙŠØ³", 5: "Ø§Ù„Ø¬Ù…Ø¹Ø©", 6: "Ø§Ù„Ø³Ø¨Øª"
    };
     
    const MONTH_MAP = {
        "ÙŠÙ†Ø§ÙŠØ±": 0, "ÙØ¨Ø±Ø§ÙŠØ±": 1, "Ù…Ø§Ø±Ø³": 2, "Ø£Ø¨Ø±ÙŠÙ„": 3, "Ù…Ø§ÙŠÙˆ": 4, "ÙŠÙˆÙ†ÙŠÙˆ": 5, 
        "ÙŠÙˆÙ„ÙŠÙˆ": 6, "Ø£ØºØ³Ø·Ø³": 7, "Ø³Ø¨ØªÙ…Ø¨Ø±": 8, "Ø£ÙƒØªÙˆØ¨Ø±": 9, "Ù†ÙˆÙÙ…Ø¨Ø±": 10, "Ø¯ÙŠØ³Ù…Ø¨Ø±": 11,
        "ÙŠÙ†Ø§ÙŠÙ€Ø±": 0, "ÙØ¨Ø±Ø§ÙŠÙ€Ø±": 1, "Ù…Ù€Ø§Ø±Ø³": 2, "Ø¥Ø¨Ø±ÙŠÙ€Ù„": 3, "Ù…Ø§ÙŠÙ€Ùˆ": 4, "ÙŠÙˆÙ†ÙŠÙ€Ùˆ": 5, 
        "ÙŠÙˆÙ„ÙŠÙ€Ùˆ": 6, "Ø£ØºØ³Ø·Ù€Ø³": 7, "Ø³Ø¨ØªÙ…Ø¨Ù€Ø±": 8, "Ø£ÙƒØªÙˆØ¨Ù€Ø±": 9, "Ù†ÙˆÙÙ…Ø¨Ù€Ø±": 10, "Ø¯ÙŠØ³Ù…Ø¨Ù€Ø±": 11 
    };

    /**
     * Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¥Ù„Ù‰ Ù…ÙØªØ§Ø­ Ø«Ø§Ø¨Øª (YYYY-MM-DD)
     * @param {Date} date - ÙƒØ§Ø¦Ù† Ø§Ù„ØªØ§Ø±ÙŠØ®
     * @returns {string} Ù…ÙØªØ§Ø­ Ø§Ù„ØªØ§Ø±ÙŠØ® (Ù…Ø«Ø§Ù„: 2025-12-08)
     */
    function formatDateKey(date) {
        if (!(date instanceof Date) || isNaN(date)) return null;
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // ğŸ’¡ Ø¯Ø§Ù„Ø© ØªØ­Ù„ÙŠÙ„ Ø§Ù„ØªØ§Ø±ÙŠØ® - Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ© Ù„Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø«Ø§Ø¨Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯
    function parseRegistrationDate(data) {
        let recordDate = null;
        
        // 1. Ø§Ù„Ø£ÙˆÙ„ÙˆÙŠØ©: Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø­Ù‚Ù„ Ø§Ù„Ø«Ø§Ø¨Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯ YYYY-MM-DD
        if (data.dateKey && data.dateKey.match(/^\d{4}-\d{2}-\d{2}$/)) {
            recordDate = new Date(data.dateKey); 
        } 
        
        // 2. Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙˆÙØ±ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø·Ø§Ø¨Ø¹ Ø§Ù„Ø²Ù…Ù†ÙŠ (Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ ÙÙŠ Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©)
        else if (data.registrationDateTimestamp && typeof data.registrationDateTimestamp.toDate === 'function') {
            recordDate = data.registrationDateTimestamp.toDate();
        } 
        
        // 3. Ø¥Ø°Ø§ Ù„Ù… ÙŠØªÙˆÙØ±ØŒ Ø§Ø³ØªØ®Ø¯Ù… Ø§Ù„ØªØ­Ù„ÙŠÙ„ Ø§Ù„Ù†ØµÙŠ Ø§Ù„Ù‚Ø¯ÙŠÙ… (Ù„Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØ© Ø¬Ø¯Ø§Ù‹)
        else if (data.registrationTime) {
            const timeString = data.registrationTime;
            const datePart = timeString.split(' â€“ ')[0].trim();
            const parts = datePart.split(' ');
            
            if (parts.length >= 3) {
                const day = parseInt(parts[0]);
                const monthName = parts[1].trim().replace(/[\u200e\u200f\s]/g, ''); 
                const month = MONTH_MAP[monthName];
                const year = parseInt(parts[2]);
                if (!isNaN(day) && month !== undefined && !isNaN(year)) {
                    recordDate = new Date(year, month, day);
                }
            }
        }
        
        if (recordDate && !isNaN(recordDate)) {
             recordDate.setHours(0, 0, 0, 0); 
             return recordDate;
        }
        return null;
    }
    
    // ----------------------------------------------------------------
    // 2. Ø¯ÙˆØ§Ù„ ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ø£Ø³Ø§Ø¨ÙŠØ¹ ÙˆØ§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ø´Ù‡Ø±ÙŠØ© 
    // ----------------------------------------------------------------
    
    function getCurrentAttendanceCycle() {
        const today = new Date();
        let startDate, endDate;

        if (today.getDate() <= 25) {
            // Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ø¯Ø£Øª ÙÙŠ 26 Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ù…Ø§Ø¶ÙŠ
            startDate = new Date(today.getFullYear(), today.getMonth() - 1, 26);
            endDate = new Date(today.getFullYear(), today.getMonth(), 25);
        } else {
            // Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„Ø­Ø§Ù„ÙŠØ© Ø¨Ø¯Ø£Øª ÙÙŠ 26 Ù‡Ø°Ø§ Ø§Ù„Ø´Ù‡Ø±
            startDate = new Date(today.getFullYear(), today.getMonth(), 26);
            endDate = new Date(today.getFullYear(), today.getMonth() + 1, 25);
        }
        
        startDate.setHours(0, 0, 0, 0); 
        endDate.setHours(23, 59, 59, 999); 

        const dateFormatter = new Intl.DateTimeFormat('ar-EG', { day: 'numeric', month: 'long', year: 'numeric' });
        const startStr = dateFormatter.format(startDate);
        const endStr = dateFormatter.format(endDate);

        return { 
            startDate: startDate,
            endDate: endDate,
            display: `${startStr} Ø­ØªÙ‰ ${endStr}`,
        };
    }

    function calculateWorkingWeeks(startDate, endDate) {
        const weeks = [];
        let currentDate = new Date(startDate);
        currentDate.setHours(0, 0, 0, 0); 
        
        // **Ø§Ù„Ø¨Ø¯Ø¡ Ù…Ù† Ø£Ù‚Ø±Ø¨ ÙŠÙˆÙ… Ø³Ø¨Øª Ù‚Ø¨Ù„ ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¨Ø¯Ø¡ (Ù„ØªØ­Ø¯ÙŠØ¯ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹)**
        let tempDate = new Date(startDate);
        let startDayIndex = tempDate.getDay(); 
        
        // 6 Ù‡Ùˆ ÙŠÙˆÙ… Ø§Ù„Ø³Ø¨Øª
        while (startDayIndex !== 6) { 
            tempDate.setDate(tempDate.getDate() - 1);
            startDayIndex = tempDate.getDay();
            // Ø­Ù…Ø§ÙŠØ© Ø¶Ø¯ Ø§Ù„ØªØ¬Ø§ÙˆØ²
            if (tempDate.getTime() < startDate.getTime() - (7 * 24 * 60 * 60 * 1000)) break; 
        }
        currentDate = new Date(tempDate); 

        // ØªØµÙÙŠØ± Ø§Ù„ÙƒØ§Ø´ Ù‚Ø¨Ù„ Ø§Ù„Ø¨Ø¯Ø¡ ÙÙŠ Ù…Ù„Ø¦Ù‡
        cycleDaysCache = {};

        // Ø§Ù„Ø­Ø³Ø§Ø¨ Ø­ØªÙ‰ Ù†Ù‡Ø§ÙŠØ© Ø§Ù„Ø¯ÙˆØ±Ø©
        while (currentDate.getTime() <= endDate.getTime()) { 
            let currentWeekDays = [];
            
            for (let i = 0; i < 7; i++) {
                const day = new Date(currentDate);
                const arabicDay = JS_DAY_MAP[day.getDay()];

                // ÙŠÙˆÙ… Ø§Ù„Ø³Ø¨Øª Ù‡Ùˆ Ø¨Ø¯Ø§ÙŠØ© Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ØŒ ÙˆÙ„ÙƒÙ†Ù†Ø§ Ù†Ù‡ØªÙ… ÙÙ‚Ø· Ø¨Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„ØªÙŠ ØªÙ‚Ø¹ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¯ÙˆØ±Ø©
                if (day.getTime() >= startDate.getTime() && day.getTime() <= endDate.getTime()) {
                    
                    const isWorkingDay = WORKING_DAYS.includes(arabicDay);
                    // ğŸ’¡ Ù…ÙØªØ§Ø­ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„Ø«Ø§Ø¨Øª (YYYY-MM-DD)
                    const dateKey = formatDateKey(day); 

                    const dayInfo = {
                        date: day,
                        dayName: arabicDay,
                        dateKey: dateKey, 
                        isWorkingDay: isWorkingDay
                    };
                    
                    currentWeekDays.push(dayInfo);

                    // Ù†Ù…Ù„Ø£ Ø§Ù„ÙƒØ§Ø´ Ø¨Ø¬Ù…ÙŠØ¹ Ø£ÙŠØ§Ù… Ø§Ù„Ø¯ÙˆØ±Ø© (Ø³ÙˆØ§Ø¡ ÙƒØ§Ù†Øª Ø£ÙŠØ§Ù… Ø¹Ù…Ù„ Ø£Ù… Ù„Ø§)
                    cycleDaysCache[dayInfo.dateKey] = dayInfo;
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }
            
            const daysInCycleInWeek = currentWeekDays.filter(d => d.date.getTime() <= endDate.getTime());
            
            if (daysInCycleInWeek.length > 0) {
                // Ù†Ø³ØªØ®Ø¯Ù… Ø£ÙŠØ§Ù… Ø§Ù„Ø¹Ù…Ù„ ÙÙ‚Ø· Ù„Ø¹Ø±Ø¶ Ù†Ø·Ø§Ù‚ Ø§Ù„ØªØ§Ø±ÙŠØ® ÙÙŠ Ø²Ø± Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹
                
                let startDisplay = daysInCycleInWeek[0].date.toLocaleDateString('ar-EG', { month: 'short', day: 'numeric' });
                let endDisplay = daysInCycleInWeek[daysInCycleInWeek.length - 1].date.toLocaleDateString('ar-EG', { month: 'short', day: 'numeric' });

                weeks.push({
                    index: weeks.length + 1,
                    // Ø£ÙŠØ§Ù… Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ù‡ÙŠ Ø£ÙŠØ§Ù… Ø§Ù„Ø¯ÙˆØ±Ø© Ø§Ù„ØªÙŠ ØªÙ‚Ø¹ ÙÙŠ Ù‡Ø°Ø§ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ (Ø¨Ù…Ø§ ÙÙŠÙ‡Ø§ Ø§Ù„Ø¬Ù…Ø¹Ø©)
                    days: daysInCycleInWeek, 
                    startDisplay: startDisplay,
                    endDisplay: endDisplay,
                });
            }
        }
        return weeks;
    }

    function initializeWeeksButtons() {
        // (Ù†ÙØ³ Ø§Ù„ÙƒÙˆØ¯)
        const cycle = getCurrentAttendanceCycle();
        cycleWeeks = calculateWorkingWeeks(cycle.startDate, cycle.endDate);
        const container = document.getElementById('week-buttons-container');
        container.innerHTML = '';
        
        document.getElementById('week-title-area').textContent = `ğŸ—“ï¸ Ø¹Ø±Ø¶ Ø§Ù„Ø­Ø¶ÙˆØ± Ø­Ø³Ø¨ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ (Ø§Ù„ÙØªØ±Ø©: ${cycle.display})`;

        if (cycleWeeks.length === 0) {
            container.innerHTML = '<p class="status-default-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø§Ø¨ÙŠØ¹ Ø¹Ù…Ù„ ÙƒØ§Ù…Ù„Ø© Ø£Ùˆ Ø¬Ø²Ø¦ÙŠØ© ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø¯ÙˆØ±Ø©.</p>';
            document.getElementById('week-details').innerHTML = '<p>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø³Ø§Ø¨ÙŠØ¹ Ù„Ø¹Ø±Ø¶Ù‡Ø§.</p>';
            return;
        }

        cycleWeeks.forEach(week => {
            const button = document.createElement('button');
            button.id = `btn-week-${week.index}`;
            button.textContent = `Ø£Ø³Ø¨ÙˆØ¹ ${week.index} (${week.startDisplay} - ${week.endDisplay})`;
            button.onclick = () => viewWeek(week);
            container.appendChild(button);
        });
        
        // Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ Ø§Ù„Ø£ÙˆÙ„ Ø§ÙØªØ±Ø§Ø¶ÙŠØ§Ù‹ Ø¨Ø¹Ø¯ Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡
        viewWeek(cycleWeeks[0]);
    }


    // ----------------------------------------------------------------
    // 3. ÙˆØ¸ÙŠÙØ© Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ¹Ø±Ø¶ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ÙˆØ§Ù„Ø£ÙŠØ§Ù…
    // ----------------------------------------------------------------

    async function fetchAttendanceData() {
        const resultArea = document.getElementById('result-area');
        resultArea.innerHTML = '<p style="color:#007bff;">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù…Ù† Firebase...</p>';

        allAttendanceData = {}; 

        try {
            const snapshot = await db.collection("user_attendance").get();
            const rawRecords = [];

            snapshot.forEach(doc => {
                rawRecords.push({ id: doc.id, ...doc.data() });
            });
            
            // ÙØ±Ø² Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ù„Ø¶Ù…Ø§Ù† Ø£Ù† Ø¢Ø®Ø± Ø³Ø¬Ù„ (Ø£Ø­Ø¯Ø« ØªØ³Ø¬ÙŠÙ„/Ø§Ø¹ØªØ°Ø§Ø±) Ù‡Ùˆ Ø§Ù„Ø°ÙŠ ÙŠØ¨Ù‚Ù‰
            rawRecords.sort((a, b) => {
                 const timeA = a.timestamp ? a.timestamp.seconds : 0;
                 const timeB = b.timestamp ? b.timestamp.seconds : 0;
                 return timeA - timeB; // ØªØµØ§Ø¹Ø¯ÙŠ (Ø§Ù„Ø£Ù‚Ø¯Ù… Ø£ÙˆÙ„Ø§Ù‹)
            });

            rawRecords.forEach(data => {
                const name = data.volunteerName;
                
                // ğŸ’¡ Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ ÙƒØ§Ø¦Ù† Ø§Ù„ØªØ§Ø±ÙŠØ® Ø§Ù„ØµØ­ÙŠØ­ ÙˆØ§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø«Ø§Ø¨Øª
                const recordDate = parseRegistrationDate(data);
                if(!recordDate) return;

                const dateKey = formatDateKey(recordDate); // Ù…ÙØªØ§Ø­ YYYY-MM-DD
                
                // Ø§Ù„ØªØ£ÙƒØ¯ Ø£Ù† Ø§Ù„Ø³Ø¬Ù„ ÙŠÙ‚Ø¹ Ø¶Ù…Ù† Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„ØªÙŠ ØªÙ‡ØªÙ… Ø¨Ù‡Ø§ Ø§Ù„Ø¯ÙˆØ±Ø© ( cycleDaysCache )
                if (!cycleDaysCache[dateKey]) return; 

                // Ù‡Ø°Ø§ Ø§Ù„Ù…Ù†Ø·Ù‚ Ø³ÙŠØ¶Ù…Ù† Ø£Ù† Ø¢Ø®Ø± Ø³Ø¬Ù„ Ù„Ù†ÙØ³ Ø§Ù„Ù…ØªØ·ÙˆØ¹ ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ… Ù‡Ùˆ Ø§Ù„Ø°ÙŠ ÙŠØªÙ… Ø§Ù„Ø§Ø­ØªÙØ§Ø¸ Ø¨Ù‡
                if (!allAttendanceData[dateKey]) {
                    allAttendanceData[dateKey] = {};
                }
                
                allAttendanceData[dateKey][name] = { 
                    status: data.status, 
                    reason: data.reason,
                    time: data.registrationTime.split(' â€“ ')[1] || '-' 
                };
            });

            resultArea.innerHTML = `<p class="status-present">âœ… **ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¬Ø¯ÙˆÙ„ Ø¨Ù†Ø¬Ø§Ø­.** (ØªÙ… Ø¬Ù„Ø¨ ${snapshot.docs.length} Ø³Ø¬Ù„)</p>`;
            
            // Ø¥Ø¹Ø§Ø¯Ø© Ø¹Ø±Ø¶ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ÙˆØ§Ù„ÙŠÙˆÙ… Ø§Ù„Ù†Ø´Ø· Ø¨Ø¹Ø¯ Ø§Ù„ØªØ­Ø¯ÙŠØ«
            if(cycleWeeks.length > 0) {
                 const activeWeekButton = document.querySelector('.week-buttons button.active');
                 let activeWeek = cycleWeeks[0]; 
                 
                 if (activeWeekButton) {
                     const weekIndexMatch = activeWeekButton.textContent.match(/Ø£Ø³Ø¨ÙˆØ¹ (\d+)/);
                     if (weekIndexMatch) {
                         const weekIndex = parseInt(weekIndexMatch[1]);
                         const foundWeek = cycleWeeks.find(w => w.index === weekIndex);
                         if (foundWeek) activeWeek = foundWeek;
                     }
                 }
                
                 let activeDateKey = activeWeek.days.find(d => d.isWorkingDay)?.dateKey;
                 
                 const activeDayButton = document.querySelector('.day-buttons button.active');
                 if (activeDayButton) {
                     activeDateKey = activeDayButton.getAttribute('data-date-key') || activeDateKey;
                 } 
                
                viewWeek(activeWeek); 
                
                if (activeDateKey) {
                    viewDay(activeDateKey);
                }

            }

        } catch (error) {
            resultArea.innerHTML = `<p class="status-absent">âŒ **Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:** ${error.message}</p>`;
            console.error("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª: ", error);
        }
    }
    
    async function initializeWeeksAndFetchData() {
         initializeWeeksButtons(); 
         await fetchAttendanceData();
    }
    
    function viewWeek(week) {
        const weekDetailsDiv = document.getElementById('week-details');
        
        document.querySelectorAll('.week-buttons button').forEach(btn => btn.classList.remove('active'));
        document.getElementById(`btn-week-${week.index}`)?.classList.add('active');
        
        let weekHeader = `
            <h3>Ù…Ù„Ø®Øµ Ø§Ù„Ø£Ø³Ø¨ÙˆØ¹ ${week.index}: Ù…Ù† ${week.startDisplay} Ø¥Ù„Ù‰ ${week.endDisplay}</h3>
            <div id="day-buttons-container" class="day-buttons" style="margin-bottom: 15px;">
                <h4>Ø§Ø®ØªØ± Ø§Ù„ÙŠÙˆÙ…:</h4>
        `;
        
        // ğŸ’¡ Ø¹Ø±Ø¶ Ø£ÙŠØ§Ù… Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„Ø© ÙÙ‚Ø· ÙÙŠ Ø§Ù„Ø£Ø²Ø±Ø§Ø±
        const workingDaysInWeek = week.days.filter(d => d.isWorkingDay);

        workingDaysInWeek.forEach(dayInfo => {
            const displayDate = dayInfo.date.toLocaleDateString('ar-EG', { month: 'short', day: 'numeric' });
            // ğŸ’¡ Ø§Ø³ØªØ®Ø¯Ø§Ù… dateKey Ø§Ù„Ø«Ø§Ø¨Øª ÙÙŠ Ø²Ø± Ø§Ù„ÙŠÙˆÙ…
            weekHeader += `<button class="day-btn" data-date-key="${dayInfo.dateKey}" onclick="viewDay('${dayInfo.dateKey}')">${dayInfo.dayName} (${displayDate})</button>`; 
        });
        
        weekHeader += `</div><div id="day-attendance-area"></div>`;
        weekDetailsDiv.innerHTML = weekHeader;
        
        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ø³ØªØ¯Ø¹Ø§Ø¡ viewDay Ù„Ù„ÙŠÙˆÙ… Ø§Ù„Ø£ÙˆÙ„ Ø¨Ø¹Ø¯ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø£Ø²Ø±Ø§Ø±
        if (workingDaysInWeek.length > 0) {
            viewDay(workingDaysInWeek[0].dateKey);
        }
    }

    function viewDay(dateKey) {
        // ğŸ’¡ Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø«Ø§Ø¨Øª YYYY-MM-DD
        const dayInfo = cycleDaysCache[dateKey]; 
        if (!dayInfo) return; 
        
        const dayAttendanceArea = document.getElementById('day-attendance-area');
        const arabicDate = dayInfo.date.toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        
        document.querySelectorAll('.day-buttons button').forEach(btn => btn.classList.remove('active'));
        document.querySelector(`button[data-date-key='${dateKey}']`)?.classList.add('active');

        let tableHTML = `
            <h4> Ø­Ø¶ÙˆØ± ÙŠÙˆÙ…: ${arabicDate} </h4>
            <div class="action-buttons">
                <button id="whatsapp-day-button" onclick="sendAttendanceListViaWhatsApp()"> ğŸ“² Ø¥Ø±Ø³Ø§Ù„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø¶ÙˆØ± Ù„ÙŠÙˆÙ… ${dayInfo.dayName} Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨ </button>
            </div>
            <table class="weekly-table" id="daily-attendance-table">
                <thead>
                    <tr>
                        <th style="text-align:right;">Ø§Ù„Ø§Ø³Ù…</th>
                        <th>Ø§Ù„Ø­Ø§Ù„Ø©</th>
                        <th>Ù…Ù„Ø§Ø­Ø¸Ø§Øª/Ø§Ù„Ø³Ø¨Ø¨</th>
                    </tr>
                </thead>
                <tbody>
        `;
        
        let finalAttendanceNames = []; 
        
        VOLUNTEER_NAMES_ORDERED.forEach(name => {
            const isFixed = FIXED_VOLUNTEERS[name].includes(dayInfo.dayName);
            // ğŸ’¡ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø³Ø¬Ù„Ø§Øª Ø§Ù„Ø­Ø¶ÙˆØ± Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø«Ø§Ø¨Øª
            const recordedStatus = allAttendanceData[dateKey] ? allAttendanceData[dateKey][name] : null;

            let displayStatus;
            let statusClass = '';
            let notes = '';
            
            // Ù…Ù†Ø·Ù‚ Ø§Ù„Ø­Ø¶ÙˆØ±: Ù…Ø¬Ø¯ÙˆÙ„ ÙˆÙ„Ù… ÙŠØ¹ØªØ°Ø±ØŒ Ø£Ùˆ Ø³Ø¬Ù„ Ø­Ø¶ÙˆØ± ØµØ±ÙŠØ­
            const isAttending = (isFixed && (!recordedStatus || recordedStatus.status !== 'Ø§Ø¹ØªØ°Ø§Ø±')) || 
                                (recordedStatus && recordedStatus.status === 'Ø­Ø¶ÙˆØ±');

            if (!isFixed && !recordedStatus) {
                displayStatus = 'ØºÙŠØ± Ù…Ø¬Ø¯ÙˆÙ„';
                statusClass = 'status-not-scheduled';
                notes = '-';
            } else if (recordedStatus) {
                
                // ğŸ’¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ù…Ø·Ù„ÙˆØ¨: Ø¹Ø±Ø¶ Ø§Ù„Ø³Ø¨Ø¨ ÙÙŠ Ø­Ø§Ù„Ø© "Ø§Ø¹ØªØ°Ø§Ø±" ÙˆØ¹Ø±Ø¶ Ø§Ù„ÙˆÙ‚Øª ÙÙŠ Ø­Ø§Ù„Ø© "Ø­Ø¶ÙˆØ±"
                if (recordedStatus.status === 'Ø§Ø¹ØªØ°Ø§Ø±') {
                    notes = recordedStatus.reason || '-';
                } else {
                    notes = recordedStatus.time || '-';
                }

                if (recordedStatus.status === 'Ø§Ø¹ØªØ°Ø§Ø±') {
                    displayStatus = 'Ø§Ø¹ØªØ°Ø§Ø± âŒ';
                    statusClass = 'status-absent';
                } else { 
                    displayStatus = 'Ø­Ø¶ÙˆØ± âœ…';
                    statusClass = 'status-present';
                }
            } else {
                displayStatus = 'Ø­Ø¶ÙˆØ± (Ø§ÙØªØ±Ø§Ø¶ÙŠ) âœ…';
                statusClass = 'status-present';
                notes = 'Ù…Ø¬Ø¯ÙˆÙ„ (Ù„Ù… ÙŠØ³Ø¬Ù„ Ø­Ø§Ù„Ø©)';
            }
            
            if (isAttending) {
                finalAttendanceNames.push(name);
            }

            tableHTML += `
                <tr>
                    <td style="text-align:right;">${name}</td>
                    <td class="${statusClass}">${displayStatus}</td>
                    <td>${notes}</td>
                </tr>
            `;
        });

        tableHTML += `</tbody></table>`;
        dayAttendanceArea.innerHTML = tableHTML;
        
        currentDayWhatsAppList.names = finalAttendanceNames;
        currentDayWhatsAppList.dayName = dayInfo.dayName;
        currentDayWhatsAppList.dateKey = dateKey;
        currentDayWhatsAppList.arabicDate = arabicDate; 
        
        document.getElementById('whatsapp-day-button').textContent = `ğŸ“² Ø¥Ø±Ø³Ø§Ù„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø¶ÙˆØ± Ù„ÙŠÙˆÙ… ${dayInfo.dayName} Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨ (${finalAttendanceNames.length} Ù…ØªØ·ÙˆØ¹)`;
    }

    // ----------------------------------------------------------------
    // 4. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ (Ù„Ù… ØªØªØºÙŠØ±)
    // ----------------------------------------------------------------

    function sendAttendanceListViaWhatsApp() {
        if (!currentDayWhatsAppList.dayName) return;

        const day = currentDayWhatsAppList.dayName;
        const attendanceList = currentDayWhatsAppList.names;
        const arabicDate = currentDayWhatsAppList.arabicDate; 

        let listText = attendanceList.map((name, index) => `${index + 1}. ${name}`).join('\n');
        
        if (attendanceList.length === 0) {
            listText = "Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø­Ø¶ÙˆØ± Ù…Ø¤ÙƒØ¯ Ù„Ù‡Ø°Ø§ Ø§Ù„ÙŠÙˆÙ….";
        }
        
        const message = `
ğŸ“Œ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ÙŠÙˆÙ…ÙŠØ©
ğŸ—“ï¸ Ø§Ù„ÙŠÙˆÙ… : ${day} - ${arabicDate} 
ğŸ•’ Ù…Ø¹Ø§Ø¯ Ø§Ù„Ø´ØºÙ„: Ù£ Ø§Ù„Ø¹ØµØ±
ğŸ‘¥ Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…ØªØ·ÙˆØ¹ÙŠÙ† : ${attendanceList.length}

---
Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ù…ØªØ·ÙˆØ¹ÙŠÙ† Ø§Ù„Ø­Ø§Ø¶Ø±ÙŠÙ† Ø§Ù„ÙŠÙˆÙ…:
${listText}
`;
        
        const encodedMessage = encodeURIComponent(message.trim());
        const whatsappUrl = `https://wa.me/?text=${encodedMessage}`;
        const sendButton = document.getElementById('whatsapp-day-button');
        sendButton.textContent = 'âœ… Ø¬Ø§Ø±ÙŠ ÙØªØ­ Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨...';
        
        window.open(whatsappUrl, '_blank');
        
        setTimeout(() => {
             sendButton.textContent = `ğŸ“² Ø¥Ø±Ø³Ø§Ù„ Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø­Ø¶ÙˆØ± Ù„ÙŠÙˆÙ… ${day} Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨ (${attendanceList.length} Ù…ØªØ·ÙˆØ¹)`;
        }, 5000);
    }
    
    // ----------------------------------------------------------------
    // 5. ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ (ØªÙ… ØªØ¹Ø¯ÙŠÙ„Ù‡Ø§ Ù„Ù„Ø§Ø¹ØªÙ…Ø§Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø«Ø§Ø¨Øª)
    // ----------------------------------------------------------------

    function getDaysInCycle(start, end) {
        const cycleDays = [];
        let currentDate = new Date(start);
        currentDate.setHours(0, 0, 0, 0); 
        
        while (currentDate.getTime() <= end.getTime()) { 
            const jsDayIndex = currentDate.getDay();
            const arabicDay = JS_DAY_MAP[jsDayIndex];

            // Ù†Ø­Ø³Ø¨ Ø£ÙŠØ§Ù… Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„Ø© ÙÙ‚Ø·
            if (WORKING_DAYS.includes(arabicDay)) {
                cycleDays.push({
                    date: new Date(currentDate), 
                    day: arabicDay,
                    // ğŸ’¡ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø«Ø§Ø¨Øª
                    dateKey: formatDateKey(currentDate) 
                });
            }
            currentDate.setDate(currentDate.getDate() + 1);
        }
        return cycleDays;
    }
    
    async function calculateMonthlyAttendance() {
        const monthlyReportArea = document.getElementById('monthly-report-area');
        monthlyReportArea.innerHTML = '<p style="color:#007bff;">Ø¬Ø§Ø±ÙŠ Ø¬Ù„Ø¨ ÙˆÙÙ„ØªØ±Ø© Ø§Ù„Ø³Ø¬Ù„Ø§Øª Ø§Ù„ØªØ§Ø±ÙŠØ®ÙŠØ© Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙ‚Ø±ÙŠØ±...</p>';

        try {
            if (Object.keys(allAttendanceData).length === 0) {
                 // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¬Ù„Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø£ÙˆÙ„Ø§Ù‹
                 await fetchAttendanceData(); 
                 if (Object.keys(allAttendanceData).length === 0) {
                     monthlyReportArea.innerHTML = `<p class="status-absent">âŒ **Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ø­Ø¶ÙˆØ± Ù„Ø¬Ù„Ø¨Ù‡Ø§.**</p>`;
                     return;
                 }
            }

            const cycle = getCurrentAttendanceCycle();
            // Ø§Ù„Ø­ØµÙˆÙ„ Ø¹Ù„Ù‰ Ø£ÙŠØ§Ù… Ø§Ù„Ø¹Ù…Ù„ Ø§Ù„ÙØ¹Ù„ÙŠØ© Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¯ÙˆØ±Ø© (Ù‡Ø°Ù‡ Ù‡ÙŠ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„ØªÙŠ ÙŠØªÙ… ØªÙˆÙ‚Ø¹ Ø§Ù„Ø­Ø¶ÙˆØ± ÙÙŠÙ‡Ø§)
            const cycleDays = getDaysInCycle(cycle.startDate, cycle.endDate); 
            
            const CLEAN_REPORT = {};
            VOLUNTEER_NAMES_ORDERED.forEach(name => {
                CLEAN_REPORT[name] = { expected: 0, attended: 0, apologies: 0, not_registered: 0 }; 
            });

            // ØªØ¬Ù…ÙŠØ¹ Ø§Ù„Ø­Ø§Ù„Ø© Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠØ© Ù„ÙƒÙ„ Ù…ØªØ·ÙˆØ¹ ÙÙŠ ÙƒÙ„ ÙŠÙˆÙ… Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¢Ø®Ø± ØªØ³Ø¬ÙŠÙ„
            const dailyStatusMap = new Map(); 
            
            for (const dateKey in allAttendanceData) { // dateKey Ù‡Ùˆ Ø§Ù„Ù…ÙØªØ§Ø­ Ø§Ù„Ø«Ø§Ø¨Øª YYYY-MM-DD
                // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù† Ø§Ù„Ù…ÙØªØ§Ø­ ÙŠÙ‚Ø¹ Ø¯Ø§Ø®Ù„ Ø§Ù„Ø¯ÙˆØ±Ø© (Ø¨Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„ÙƒØ§Ø´ Ù„Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø£Ù†Ù‡ ÙŠÙˆÙ… Ø¹Ù…Ù„ Ù…Ø¬Ø¯ÙˆÙ„)
                if (cycleDaysCache[dateKey]) {
                     for (const name in allAttendanceData[dateKey]) {
                        if (!dailyStatusMap.has(name)) {
                            dailyStatusMap.set(name, new Map());
                        }
                        
                        const currentStatus = allAttendanceData[dateKey][name].status;
                        
                        // ÙŠØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø­Ø§Ù„Ø©ØŒ Ø§Ù„Ø§Ø¹ØªØ°Ø§Ø± ÙŠÙ„ØºÙŠ Ø£ÙŠ Ø­Ø¶ÙˆØ± Ù‚Ø¨Ù„Ù‡ Ø£Ùˆ Ø¨Ø¹Ø¯Ù‡ ÙÙŠ Ù†ÙØ³ Ø§Ù„ÙŠÙˆÙ…
                        if (currentStatus === 'Ø§Ø¹ØªØ°Ø§Ø±') {
                            dailyStatusMap.get(name).set(dateKey, 'Ø§Ø¹ØªØ°Ø§Ø±');
                        } else if (currentStatus === 'Ø­Ø¶ÙˆØ±') {
                            dailyStatusMap.get(name).set(dateKey, 'Ø­Ø¶ÙˆØ±');
                        }
                    }
                }
            }
            
            // Ø­Ø³Ø§Ø¨ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„Ø©
            VOLUNTEER_NAMES_ORDERED.forEach(name => {
                const report = CLEAN_REPORT[name];
                
                let actualAttendance = 0;
                let actualApologies = 0;
                let explicitAttendanceOutOfSchedule = 0;
                let unregisteredScheduledAttendance = 0;
                
                cycleDays.forEach(dayInfo => {
                    const dateKey = dayInfo.dateKey;
                    const dayArabic = dayInfo.day;
                    const status = dailyStatusMap.get(name)?.get(dateKey);
                    
                    const isScheduled = FIXED_VOLUNTEERS[name].includes(dayArabic);

                    if (isScheduled) { 
                        report.expected++;
                        
                        if (status === 'Ø­Ø¶ÙˆØ±') {
                            actualAttendance++; 
                        } else if (status === 'Ø§Ø¹ØªØ°Ø§Ø±') {
                            actualApologies++; 
                        } else {
                            // Ù…Ø¬Ø¯ÙˆÙ„ ÙˆÙ„Ù… ÙŠØ³Ø¬Ù„ Ø­Ø§Ù„Ø© = Ø­Ø¶ÙˆØ± Ø§ÙØªØ±Ø§Ø¶ÙŠ
                            unregisteredScheduledAttendance++; 
                        }
                    } else { 
                        // ØºÙŠØ± Ù…Ø¬Ø¯ÙˆÙ„: ÙŠØ­Ø³Ø¨ Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ØµØ±ÙŠØ­ ÙÙ‚Ø· (Ù‡Ø°Ø§ ÙŠØ¶Ø§Ù Ø¥Ù„Ù‰ Attended)
                        if (status === 'Ø­Ø¶ÙˆØ±') {
                            explicitAttendanceOutOfSchedule++; 
                        }
                    }
                });
                
                // Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ù…Ø­ØªØ³Ø¨ = (Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ÙØ¹Ù„ÙŠ Ø§Ù„Ù…Ø³Ø¬Ù„ ÙÙŠ Ø£ÙŠØ§Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø© + Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ) + Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ØµØ±ÙŠØ­ ÙÙŠ ØºÙŠØ± Ø£ÙŠØ§Ù… Ø§Ù„Ø¬Ø¯ÙˆÙ„Ø©
                report.attended = actualAttendance + unregisteredScheduledAttendance + explicitAttendanceOutOfSchedule; 
                report.apologies = actualApologies; 
                
                // Ø¹Ø¯Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© = Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø© (Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„Ø©) - Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ÙØ¹Ù„ÙŠ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø£ÙŠØ§Ù… - Ø§Ù„Ø§Ø¹ØªØ°Ø§Ø± Ø§Ù„Ù…Ø³Ø¬Ù„ ÙÙŠ Ù‡Ø°Ù‡ Ø§Ù„Ø£ÙŠØ§Ù…
                report.not_registered = report.expected - actualAttendance - actualApologies;
                
                if (report.expected === 0) {
                     report.not_registered = 0;
                } else if (report.not_registered < 0) {
                     report.not_registered = 0;
                }
            });

            finalMonthlyReportData.cycleDisplay = cycle.display;
            finalMonthlyReportData.data = CLEAN_REPORT;

            let tableHTML = `
                <h3>ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø­Ø¶ÙˆØ± (Ø§Ù„Ø­Ø³Ø§Ø¨ ÙˆÙÙ‚Ø§Ù‹ Ù„Ù‚ÙˆØ§Ø¹Ø¯ Ø§Ù„Ø¹Ù…Ù„)</h3>
                <div class="monthly-summary">
                    <p>ØªÙ… Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ù‚Ø§Ø¹Ø¯Ø© **"Ø§Ù„Ù…Ø¬Ø¯ÙˆÙ„ Ø­Ø§Ø¶Ø± Ù…Ø§ Ù„Ù… ÙŠØ¹ØªØ°Ø±ØŒ ÙˆØ§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„ØµØ±ÙŠØ­ ÙŠØ­Ø³Ø¨ Ø¯Ø§Ø¦Ù…Ø§Ù‹"** Ù„Ù„ÙØªØ±Ø©:</p>
                    <p>ğŸ“… **${cycle.display}**</p>
                    <div class="action-buttons" style="margin-bottom: 0;">
                        <button id="copy-monthly-button" onclick="copyMonthlyTableContent()"> Ù†Ø³Ø® Ø§Ù„ØªÙ‚Ø±ÙŠØ± (Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ù…Ø­ØªØ³Ø¨ ÙÙ‚Ø·) </button>
                    </div>
                </div>
                
                <table class="monthly-table">
                    <thead>
                        <tr>
                            <th>Ø§Ù„Ø§Ø³Ù…</th>
                            <th>Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…ØªÙˆÙ‚Ø¹Ø© (Ù…Ø¬Ø¯ÙˆÙ„)</th>
                            <th>Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ù…Ø­ØªØ³Ø¨ (Ø§Ù„ÙØ¹Ù„ÙŠ + Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ)</th>
                            <th>Ø§Ù„Ø§Ø¹ØªØ°Ø§Ø± Ø§Ù„Ù…Ø³Ø¬Ù„ (Ø§Ù„ÙØ¹Ù„ÙŠ)</th>
                            <th>Ø¹Ø¯Ù… ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø§Ù„Ø© (Øº/Ø§)</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            VOLUNTEER_NAMES_ORDERED.forEach(name => {
                const report = CLEAN_REPORT[name];
                
                tableHTML += `
                    <tr>
                        <td>${name}</td>
                        <td>${report.expected} Ø£ÙŠØ§Ù…</td>
                        <td class="status-present">${report.attended} Ø£ÙŠØ§Ù…</td>
                        <td class="status-absent">${report.apologies} Ø£ÙŠØ§Ù…</td>
                        <td>${report.not_registered} Ø£ÙŠØ§Ù…</td>
                    </tr>
                `;
            });

            tableHTML += `</tbody></table>`;
            
            monthlyReportArea.innerHTML = tableHTML;
            
        } catch(error) {
             monthlyReportArea.innerHTML = `<p class="status-absent">âŒ **Ø®Ø·Ø£ ÙØ§Ø¯Ø­ ÙÙŠ Ù…Ø¹Ø§Ù„Ø¬Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:** ${error.message}. ÙŠØ±Ø¬Ù‰ Ù…Ø±Ø§Ø¬Ø¹Ø© Console Ù„Ù…Ø²ÙŠØ¯ Ù…Ù† Ø§Ù„ØªÙØ§ØµÙŠÙ„.</p>`;
             console.error("Critical Error in Monthly Calculation:", error);
        }
    }

    function copyMonthlyTableContent() {
        if (!finalMonthlyReportData.data || Object.keys(finalMonthlyReportData.data).length === 0) {
             alert('âŒ Ø§Ù„Ø±Ø¬Ø§Ø¡ Ø§Ù„Ø¶ØºØ· Ø¹Ù„Ù‰ "Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ Ø§Ù„Ø¯Ù‚ÙŠÙ‚" Ø£ÙˆÙ„Ø§Ù‹ Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª.');
             return;
        }

        const cycleDisplay = finalMonthlyReportData.cycleDisplay;
        const reportData = finalMonthlyReportData.data;
        
        let textToCopy = `ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø­Ø¶ÙˆØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ Ù„Ù„ÙØªØ±Ø© ${cycleDisplay}\n\n`;
        textToCopy += '------------------------------------------\n';
        
        VOLUNTEER_NAMES_ORDERED.forEach(name => {
            const report = reportData[name];
            if (report) {
                textToCopy += `${name}\t: ${report.attended} Ø£ÙŠØ§Ù… Ø­Ø¶ÙˆØ±\n`;
            }
        });

        navigator.clipboard.writeText(textToCopy.trim())
            .then(() => {
                alert(`âœ… ØªÙ… Ù†Ø³Ø® Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø´Ù‡Ø±ÙŠ Ø¨Ù†Ø¬Ø§Ø­!`);
            })
            .catch(err => {
                console.error('ÙØ´Ù„ ÙÙŠ Ø§Ù„Ù†Ø³Ø®:', err);
                alert('âŒ ÙØ´Ù„ ÙÙŠ Ù†Ø³Ø® Ø§Ù„ØªÙ‚Ø±ÙŠØ±. Ù‚Ø¯ Ù„Ø§ ÙŠØ¯Ø¹Ù… Ø§Ù„Ù…ØªØµÙØ­ Ù‡Ø°Ù‡ Ø§Ù„Ù…ÙŠØ²Ø©.');
            });
    }

    window.onload = initializeWeeksAndFetchData;
</script>

</body>
</html>
