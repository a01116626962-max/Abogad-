<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± Ø§Ù„Ù…ØªØ·ÙˆØ¹ÙŠÙ†</title>
    <style>
        /* Ø§Ù„Ø£Ù†Ù…Ø§Ø· CSS */
        body {
            font-family: 'Arial', sans-serif;
            background-color: #f4f4f9;
            color: #333;
            margin: 0;
            padding: 20px;
            text-align: right;
            direction: rtl;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: #fff;
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #007bff;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        /* ØªØ¹Ø¯ÙŠÙ„ Ø£Ù†Ù…Ø§Ø· Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¥Ø¯Ø®Ø§Ù„ Ù„ØªÙ„Ø§Ø¦Ù… Ø§Ù„ØªØµÙ…ÙŠÙ… */
        select, input[type="text"], input[type="time"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 20px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1em;
            direction: rtl;
            text-align: right;
        }
        /* ØªÙ†Ø³ÙŠÙ‚ Ø­Ø§ÙˆÙŠØ© Ù…Ø±Ø¨Ø¹Ø§Øª Ø§Ù„Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø© */
        #dates-checkbox-container {
            border: 1px solid #ccc;
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
            max-height: 200px;
            overflow-y: auto;
        }
        .date-checkbox-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            cursor: pointer;
        }
        .date-checkbox-item input[type="checkbox"] {
            /* ØªØ¹Ø¯ÙŠÙ„ Ø§ØªØ¬Ø§Ù‡ Ø§Ù„Ù€ checkbox ÙÙŠ Ø¨ÙŠØ¦Ø© RTL */
            margin-left: 10px; 
            margin-right: 0;
            width: auto;
            margin-bottom: 0;
        }
        button {
            padding: 12px 20px;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background-color: #28a745;
            transition: background-color 0.3s;
            font-size: 1.1em;
            width: 100%; /* Ø¬Ø¹Ù„ Ø§Ù„Ø²Ø± Ø¨Ø¹Ø±Ø¶ ÙƒØ§Ù…Ù„ */
        }
        button:hover {
            background-color: #218838;
        }
        #response-message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            display: none;
            font-weight: bold;
        }
        .success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        #whatsapp-link-container {
            margin-top: 20px;
            padding: 15px;
            background-color: #075E54;
            color: white;
            border-radius: 4px;
            text-align: center;
            display: none;
        }
        #whatsapp-link-container a {
            color: white;
            text-decoration: none;
            font-weight: bold;
            display: block;
            margin-top: 10px;
            padding: 10px;
            background-color: #128C7E;
            border-radius: 4px;
        }
        .apology-fields {
            padding: 15px;
            border: 1px solid #ffc107;
            background-color: #fff3cd;
            border-radius: 4px;
            margin-bottom: 20px;
            display: none;
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script> 
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
</head>
<body>

<div class="container">
    <h1>ğŸ“ ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± Ø§Ù„Ù…ØªØ·ÙˆØ¹ÙŠÙ†</h1>

    <form id="attendance-form">
        
        <label for="volunteer-name">Ø§Ù„Ø§Ø³Ù…:</label>
        <select id="volunteer-name" required>
            <option value="">Ø§Ø®ØªØ± Ø§Ø³Ù…Ùƒ</option>
        </select>

        <label for="registration-type">Ù†ÙˆØ¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„:</label>
        <select id="registration-type" onchange="toggleApologyFields()" required>
            <option value="Ø­Ø¶ÙˆØ±">Ø­Ø¶ÙˆØ±</option>
            <option value="Ø§Ø¹ØªØ°Ø§Ø±">Ø§Ø¹ØªØ°Ø§Ø±</option>
        </select>

        <label>Ø§Ù„ÙŠÙˆÙ…/Ø§Ù„ØªØ§Ø±ÙŠØ® (ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø¯Ø© Ø£ÙŠØ§Ù…):</label>
        <div id="dates-checkbox-container" onchange="toggleApologyFields()">
            </div>
        
        <div id="apology-container" class="apology-fields">
            <h4>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§Ø¹ØªØ°Ø§Ø±</h4>
            <label for="apology-reason">Ø³Ø¨Ø¨ Ø§Ù„Ø§Ø¹ØªØ°Ø§Ø±:</label>
            <input type="text" id="apology-reason" placeholder="Ù…Ø«Ø§Ù„: Ø¸Ø±ÙˆÙ Ø·Ø§Ø±Ø¦Ø©ØŒ Ù…Ø±Ø¶">
            
            <div id="late-apology-field" style="display:none;">
                <label for="late-reason">Ø³Ø¨Ø¨ ØªØ£Ø®Ø± Ø§Ù„Ø§Ø¹ØªØ°Ø§Ø± (Ø¥Ø°Ø§ ÙƒØ§Ù† Ø£Ø­Ø¯ Ø§Ù„Ø£ÙŠØ§Ù… Ù‡Ùˆ Ø§Ù„ÙŠÙˆÙ…):</label>
                <input type="text" id="late-reason" placeholder="Ù…Ø«Ø§Ù„: Ù„Ù… Ø£Ø³ØªØ·Ø¹ Ø§Ù„ÙˆØµÙˆÙ„ Ù„Ù„Ù…ÙˆØ¨Ø§ÙŠÙ„">
            </div>
        </div>

        <button type="submit">ØªØ³Ø¬ÙŠÙ„ ÙˆØ¥Ø±Ø³Ø§Ù„ Ù„Ù„ÙˆØ§ØªØ³Ø§Ø¨</button>
    </form>

    <div id="response-message"></div>
    <div id="whatsapp-link-container"></div>
</div>

<script>
    // âš ï¸ Ù…ÙØ§ØªÙŠØ­ Firebase (ØªÙ… ØªØ±ÙƒÙ‡Ø§ ÙƒÙ…Ø§ Ù‡ÙŠ Ù„ÙŠØ¹Ù…Ù„ Ø§Ù„ÙƒÙˆØ¯ Ø¨Ø´ÙƒÙ„ ØµØ­ÙŠØ­)
    const firebaseConfig = {
        apiKey: "AIzaSyCDJANXMfd6TR7R2ruLIi-xytlrB-LiCEs", 
        authDomain: "rdtt-15cbe.firebaseapp.com",
        projectId: "rdtt-15cbe",
        storageBucket: "rdtt-15cbe.firebasestorage.app",
        messagingSenderId: "219502671343",
        appId: "1:219502671343:web:b289b11869e25c9a30321a"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    
    // Ø±Ù‚Ù… Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ø§Ù„Ø°ÙŠ Ø³ÙŠØªÙ… Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø±Ø³Ø§Ù„Ø© Ø¥Ù„ÙŠÙ‡
    const whatsappNumber = "201223314173"; 
    
    const WORKING_DAYS = ["Ø§Ù„Ø³Ø¨Øª", "Ø§Ù„Ø£Ø­Ø¯", "Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†", "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡", "Ø§Ù„Ø®Ù…ÙŠØ³"];

    const FIXED_VOLUNTEERS = {
        "Ø£Ø­Ù…Ø¯": WORKING_DAYS, "Ù‡Ø¯ÙŠØ±": WORKING_DAYS, "Ù…Ø­Ù…Ø¯ Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…": WORKING_DAYS, 
        "Ù…Ø­Ù…Ø¯ Ø¹Ø¨Ø¯Ø§Ù„Ø­Ù…ÙŠØ¯": WORKING_DAYS, "Ø³Ø§Ù…Ù‰": ["Ø§Ù„Ø³Ø¨Øª", "Ø§Ù„Ø£Ø­Ø¯", "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡"], 
        "Ù…Ù…ØªØ§Ø²": WORKING_DAYS, "Ø­Ø¨ÙŠØ¨Ø©": WORKING_DAYS, "Ø³Ø§Ù†Ø¯ÙŠ": [],
        "Ø±Ø­Ø§Ø¨": ["Ø§Ù„Ø³Ø¨Øª", "Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†", "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡"], "Ù…Ø¹Ø§Ø°": ["Ø§Ù„Ø£Ø­Ø¯", "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", "Ø§Ù„Ø®Ù…ÙŠØ³"], 
        "Ù…Ø§Ø²Ù†": WORKING_DAYS, "ÙŠÙˆØ³Ù": [], "Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…": WORKING_DAYS, 
        "Ù…Ø±ÙˆØ§Ù†": [], "Ø¹Ø¨Ø¯Ø§Ù„Ø±Ø­Ù…Ù†": [], "Ù…Ø¹ØªØ²": WORKING_DAYS 
    };

    const JS_DAY_MAP = {
        0: "Ø§Ù„Ø£Ø­Ø¯", 1: "Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†", 2: "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", 3: "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡", 4: "Ø§Ù„Ø®Ù…ÙŠØ³", 5: "Ø§Ù„Ø¬Ù…Ø¹Ø©", 6: "Ø§Ù„Ø³Ø¨Øª"
    };
    
    const MONTH_MAP = [
        "ÙŠÙ†Ø§ÙŠØ±", "ÙØ¨Ø±Ø§ÙŠØ±", "Ù…Ø§Ø±Ø³", "Ø£Ø¨Ø±ÙŠÙ„", "Ù…Ø§ÙŠÙˆ", "ÙŠÙˆÙ†ÙŠÙˆ", 
        "ÙŠÙˆÙ„ÙŠÙˆ", "Ø£ØºØ³Ø·Ø³", "Ø³Ø¨ØªÙ…Ø¨Ø±", "Ø£ÙƒØªÙˆØ¨Ø±", "Ù†ÙˆÙÙ…Ø¨Ø±", "Ø¯ÙŠØ³Ù…Ø¨Ø±"
    ];
    
    /**
     * Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¥Ù„Ù‰ (ÙŠÙˆÙ…_Ø§Ù„Ø´Ù‡Ø± Ø§Ø³Ù…_Ø§Ù„Ø´Ù‡Ø± Ø§Ù„Ø³Ù†Ø©)
     */
    function formatDateDisplay(date) {
        const dayOfWeek = JS_DAY_MAP[date.getDay()]; 
        const dayOfMonth = date.getDate();
        const monthName = MONTH_MAP[date.getMonth()];
        const year = date.getFullYear();
        
        let display = `${dayOfWeek} (${dayOfMonth} ${monthName} ${year})`;
        
        const today = new Date();
        if (date.toDateString() === today.toDateString()) {
            display += " - Ø§Ù„ÙŠÙˆÙ…";
        }
        
        return display;
    }

    /**
     * Ø¯Ø§Ù„Ø© Ù…Ø³Ø§Ø¹Ø¯Ø© Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„ØªØ§Ø±ÙŠØ® Ø¥Ù„Ù‰ Ù…ÙØªØ§Ø­ Ø«Ø§Ø¨Øª (YYYY-MM-DD)
     */
     function formatDateKey(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    // ----------------------------------------------------------------
    // ÙˆØ¸ÙŠÙØ© ØªÙ‡ÙŠØ¦Ø© Ø§Ù„Ù‚ÙˆØ§Ø¦Ù… Ø§Ù„Ù…Ù†Ø³Ø¯Ù„Ø© (ØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡Ø§ Ù„Ø¥Ù†Ø´Ø§Ø¡ Ù…Ø±Ø¨Ø¹Ø§Øª Ø§Ø®ØªÙŠØ§Ø±)
    // ----------------------------------------------------------------

    function initializeForm() {
        const nameSelect = document.getElementById('volunteer-name');
        const dateContainer = document.getElementById('dates-checkbox-container');
        dateContainer.innerHTML = ''; // ØªÙØ±ÙŠØº Ø§Ù„Ø­Ø§ÙˆÙŠØ© Ù‚Ø¨Ù„ Ø§Ù„Ø¥Ø¶Ø§ÙØ©
        
        // 1. Ø¥Ø¶Ø§ÙØ© Ø£Ø³Ù…Ø§Ø¡ Ø§Ù„Ù…ØªØ·ÙˆØ¹ÙŠÙ†
        Object.keys(FIXED_VOLUNTEERS).sort().forEach(name => {
            const option = document.createElement('option');
            option.value = name;
            option.textContent = name;
            nameSelect.appendChild(option);
        });

        // 2. Ø¥Ø¶Ø§ÙØ© Ù…Ø±Ø¨Ø¹Ø§Øª Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ØªÙˆØ§Ø±ÙŠØ® (Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ + 10 Ø£ÙŠØ§Ù… Ù‚Ø§Ø¯Ù…Ø©)
        const today = new Date();
        today.setHours(0, 0, 0, 0);

        for (let i = 0; i < 11; i++) {
            const date = new Date(today);
            date.setDate(today.getDate() + i);
            
            const dateKey = formatDateKey(date);
            const dateDisplay = formatDateDisplay(date);

            const div = document.createElement('div');
            div.className = 'date-checkbox-item';

            const checkbox = document.createElement('input');
            checkbox.type = 'checkbox';
            checkbox.id = `date-${dateKey}`;
            checkbox.name = 'selected-dates';
            checkbox.value = dateKey;
            checkbox.setAttribute('data-date-display', dateDisplay);
            
            const label = document.createElement('label');
            label.htmlFor = `date-${dateKey}`;
            label.textContent = dateDisplay;

            div.appendChild(checkbox);
            div.appendChild(label);
            dateContainer.appendChild(div);
        }
    }

    // ----------------------------------------------------------------
    // ÙˆØ¸ÙŠÙØ© Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø§Ø¹ØªØ°Ø§Ø± (ØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡Ø§ Ù„Ù„ØªØ¹Ø§Ù…Ù„ Ù…Ø¹ Ø§Ù„ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯)
    // ----------------------------------------------------------------
    
    function toggleApologyFields() {
        const type = document.getElementById('registration-type').value;
        const apologyContainer = document.getElementById('apology-container');
        const apologyReason = document.getElementById('apology-reason');
        const lateReason = document.getElementById('late-reason');
        const lateApologyField = document.getElementById('late-apology-field');
        
        // 1. Ø¥Ø¸Ù‡Ø§Ø±/Ø¥Ø®ÙØ§Ø¡ Ø­Ø§ÙˆÙŠØ© Ø§Ù„Ø§Ø¹ØªØ°Ø§Ø±
        if (type === 'Ø§Ø¹ØªØ°Ø§Ø±') {
            apologyContainer.style.display = 'block';
            apologyReason.required = true;
            apologyReason.disabled = false;
        } else {
            apologyContainer.style.display = 'none';
            apologyReason.required = false;
            apologyReason.disabled = true;
        }

        // 2. Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ Ù„Ø¥Ø¸Ù‡Ø§Ø± Ø­Ù‚Ù„ Ø§Ù„ØªØ£Ø®Ø±
        const todayKey = formatDateKey(new Date());
        const selectedCheckboxes = document.querySelectorAll('#dates-checkbox-container input[type="checkbox"]:checked');
        let isTodaySelected = false;

        selectedCheckboxes.forEach(checkbox => {
            if (checkbox.value === todayKey) {
                isTodaySelected = true;
            }
        });
        
        if (type === 'Ø§Ø¹ØªØ°Ø§Ø±' && isTodaySelected) {
            // Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ø¹ØªØ°Ø§Ø±Ø§Ù‹ ÙˆØªÙ… Ø§Ø®ØªÙŠØ§Ø± Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ
            lateApologyField.style.display = 'block';
            lateReason.required = true;
            lateReason.disabled = false;
        } else {
            lateApologyField.style.display = 'none';
            lateReason.required = false;
            lateReason.disabled = true;
        }
    }

    // ----------------------------------------------------------------
    // ÙˆØ¸ÙŠÙØ© ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„ÙˆØ§ØªØ³Ø§Ø¨ (ØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡Ø§ Ù„Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ù…ØªØ¹Ø¯Ø¯)
    // ----------------------------------------------------------------
    
    document.getElementById('attendance-form').addEventListener('submit', function(e) {
        e.preventDefault();
        registerAttendance();
    });

    async function registerAttendance() {
        const name = document.getElementById('volunteer-name').value;
        const status = document.getElementById('registration-type').value;
        const submissionTime = new Date(); 

        const selectedDatesElements = document.querySelectorAll('#dates-checkbox-container input[type="checkbox"]:checked');
        
        if (selectedDatesElements.length === 0) {
            alert('ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± ÙŠÙˆÙ…/ØªØ§Ø±ÙŠØ® ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.');
            return;
        }

        let apologyReason = '';
        let lateReason = '';
        let fullReason = '';
        
        if (status === 'Ø§Ø¹ØªØ°Ø§Ø±') {
            apologyReason = document.getElementById('apology-reason').value;
            lateReason = document.getElementById('late-reason').value;

            fullReason = apologyReason;
            if (lateReason && document.querySelector(`#date-${formatDateKey(new Date())}:checked`)) {
                 // Ø¥Ø¶Ø§ÙØ© Ø³Ø¨Ø¨ Ø§Ù„ØªØ£Ø®Ø± ÙÙ‚Ø· Ø¥Ø°Ø§ ÙƒØ§Ù† Ø§Ù„ÙŠÙˆÙ… Ø§Ù„Ø­Ø§Ù„ÙŠ Ù…Ø­Ø¯Ø¯Ø§Ù‹
                fullReason += ` (ØªØ£Ø®Ø±: ${lateReason})`;
            }
            if (!apologyReason) {
                alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø¨Ø¨ Ø§Ù„Ø§Ø¹ØªØ°Ø§Ø±.');
                return;
            }
        }
        
        const messageDiv = document.getElementById('response-message');
        const whatsappContainer = document.getElementById('whatsapp-link-container');
        messageDiv.style.display = 'none';
        whatsappContainer.style.display = 'none';
        
        const selectedDatesData = [];

        try {
            // ğŸ’¡ ØªØ³Ø¬ÙŠÙ„ ÙƒÙ„ ÙŠÙˆÙ… Ø¨Ø´ÙƒÙ„ Ù…Ù†ÙØµÙ„ ÙÙŠ Firebase
            for (const element of selectedDatesElements) {
                const dateKeyYYYYMMDD = element.value;
                const dateDisplay = element.getAttribute('data-date-display');
                const docId = `${name}_${dateKeyYYYYMMDD}`;
                const dateObject = new Date(dateKeyYYYYMMDD); // Ø¨Ù†Ø§Ø¡ ÙƒØ§Ø¦Ù† Ø§Ù„ØªØ§Ø±ÙŠØ® Ù…Ù† Ø§Ù„Ù…ÙØªØ§Ø­ YYYY-MM-DD
                
                const dataToSave = {
                    volunteerName: name,
                    status: status,
                    reason: fullReason,
                    registrationDateTimestamp: firebase.firestore.Timestamp.fromDate(dateObject), 
                    dateKey: dateKeyYYYYMMDD, 
                    // ÙˆÙ‚Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø§Ù„ÙØ¹Ù„ÙŠ
                    registrationTime: dateDisplay + ' â€“ ' + submissionTime.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' }),
                    timestamp: firebase.firestore.FieldValue.serverTimestamp() 
                };

                await db.collection("user_attendance").doc(docId).set(dataToSave, { merge: true });
                
                selectedDatesData.push({
                    display: dateDisplay,
                    key: dateKeyYYYYMMDD
                });
            }

            messageDiv.className = 'success';
            messageDiv.textContent = `âœ… ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¨ÙŠØ§Ù†Ø§Øª ${selectedDatesElements.length} ÙŠÙˆÙ…/Ø£ÙŠØ§Ù… Ø¨Ù†Ø¬Ø§Ø­ ÙÙŠ Firebase.`;
            messageDiv.style.display = 'block';

            // ğŸŒŸ Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ Ù„ÙƒØ§ÙØ© Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…Ø³Ø¬Ù„Ø©
            createWhatsAppLink(name, status, selectedDatesData, submissionTime, apologyReason, lateReason);

        } catch (error) {
            messageDiv.className = 'error';
            messageDiv.textContent = `âŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„: ${error.message}`;
            messageDiv.style.display = 'block';
            console.error("Error writing documents: ", error);
        }
    }

    // ----------------------------------------------------------------
    // ÙˆØ¸ÙŠÙØ© Ø¥Ù†Ø´Ø§Ø¡ Ø±Ø§Ø¨Ø· Ø§Ù„ÙˆØ§ØªØ³Ø§Ø¨ - ØªÙ… ØªØ­Ø¯ÙŠØ«Ù‡Ø§ Ù„Ø¯Ù…Ø¬ Ø£ÙŠØ§Ù… Ù…ØªØ¹Ø¯Ø¯Ø©
    // ----------------------------------------------------------------
    
    function createWhatsAppLink(name, status, datesArray, submissionTime, apologyReason, lateReason) {
        
        const dateTimeDisplay = `${submissionTime.toLocaleDateString('ar-EG')} ${submissionTime.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' })}`;
        
        let datesList = datesArray.map(d => `â€¢ ${d.display}`).join('\n');
        
        let messageBody = `
ğŸ‘¤ Ø§Ù„Ù…ØªØ·ÙˆØ¹: ${name}
ğŸ“ Ø§Ù„Ø­Ø§Ù„Ø©: **${status}**

ğŸ—“ï¸ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…Ø³Ø¬Ù„Ø©: 
${datesList}

ğŸ•’ ÙˆÙ‚Øª Ø§Ù„ØªØ³Ø¬ÙŠÙ„ (Ø§Ù„ÙØ¹Ù„ÙŠ): ${dateTimeDisplay}
`;
        
        if (status === 'Ø§Ø¹ØªØ°Ø§Ø±') {
            const isTodayInSelection = datesArray.some(d => d.key === formatDateKey(new Date()));
            
            messageBody += `

Ø³Ø¨Ø¨ Ø§Ù„Ø§Ø¹ØªØ°Ø§Ø±: ${apologyReason || 'Ù„Ø§ ÙŠÙˆØ¬Ø¯ Ø³Ø¨Ø¨ Ø±Ø¦ÙŠØ³ÙŠ'}
Ø³Ø¨Ø¨ Ø§Ù„ØªØ£Ø®Ø±: ${isTodayInSelection && lateReason ? lateReason : 'Ù„Ù… ÙŠØªÙ… ØªØ³Ø¬ÙŠÙ„ ØªØ£Ø®Ø±'}
`;
        }
        
        const encodedMessage = encodeURIComponent(messageBody.trim());
        const whatsappUrl = `https://wa.me/${whatsappNumber}?text=${encodedMessage}`;
        
        const container = document.getElementById('whatsapp-link-container');
        container.innerHTML = `
            <p>Ù„Ù„ØªØ£ÙƒÙŠØ¯ØŒ ÙŠØ±Ø¬Ù‰ Ø¥Ø±Ø³Ø§Ù„ Ø¨ÙŠØ§Ù†Ø§Øª ${datesArray.length} ÙŠÙˆÙ…/Ø£ÙŠØ§Ù… Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨:</p>
            <a href="${whatsappUrl}" target="_blank">Ø§Ù†Ù‚Ø± Ù‡Ù†Ø§ Ù„Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨ ğŸ“²</a>
        `;
        container.style.display = 'block';
    }

    window.onload = function() {
        initializeForm();
        // Ø±Ø¨Ø· Ø§Ù„Ø£Ø­Ø¯Ø§Ø« Ø¨Ù…Ø¬Ø±Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ù†Ù…ÙˆØ°Ø¬
        document.getElementById('volunteer-name').addEventListener('change', toggleApologyFields);
        toggleApologyFields();
    };

</script>

</body>
</html>
