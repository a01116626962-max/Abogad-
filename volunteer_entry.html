<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± Ø§Ù„Ù…ØªØ·ÙˆØ¹ÙŠÙ†</title>
    <style>
        /* Ø§Ù„Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ© Ù„Ù„Ø£Ù„ÙˆØ§Ù† */
        :root {
            --bg-color: #f4f4f9;
            --container-bg: #ffffff;
            --text-color: #333;
            --input-border: #ccc;
        }

        /* Ø£Ù†Ù…Ø§Ø· Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ */
        body.dark-mode {
            --bg-color: #121212;
            --container-bg: #1e1e1e;
            --text-color: #e0e0e0;
            --input-border: #444;
        }

        body {
            font-family: 'Arial', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 20px;
            text-align: right;
            direction: rtl;
            transition: 0.3s;
        }
        .container {
            max-width: 600px;
            margin: 0 auto;
            background: var(--container-bg);
            padding: 25px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        h1 {
            color: #007bff;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
        }
        select, input[type="text"], input[type="password"], input[type="time"] {
            width: 100%;
            padding: 10px;
            margin-bottom: 20px;
            border: 1px solid var(--input-border);
            border-radius: 4px;
            box-sizing: border-box;
            font-size: 1em;
            background: var(--container-bg);
            color: var(--text-color);
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø­Ù‚Ù„ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ø¹ Ø§Ù„Ø²Ø± */
        .pass-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }
        .pass-wrapper input {
            padding-left: 45px; /* Ù…Ø³Ø§Ø­Ø© Ù„Ù„Ø²Ø± */
        }
        .toggle-pass {
            position: absolute;
            left: 10px;
            top: 10px;
            cursor: pointer;
            background: none;
            border: none;
            font-size: 0.9em;
            color: #007bff;
            width: auto;
            padding: 0;
        }

        /* Ø²Ø± Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ */
        .theme-toggle {
            float: left;
            background: #444;
            color: #fff;
            border: none;
            padding: 5px 10px;
            border-radius: 20px;
            cursor: pointer;
            font-size: 0.8em;
            width: auto;
            margin-bottom: 10px;
        }

        #dates-checkbox-container {
            border: 1px solid var(--input-border);
            padding: 10px;
            border-radius: 4px;
            margin-bottom: 20px;
            max-height: 200px;
            overflow-y: auto;
        }
        .date-checkbox-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            cursor: pointer;
        }
        .date-checkbox-item input[type="checkbox"] {
            margin-left: 10px; 
            margin-right: 0;
            width: auto;
            margin-bottom: 0;
        }
        button[type="submit"] {
            padding: 12px 20px;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            background-color: #28a745;
            transition: background-color 0.3s;
            font-size: 1.1em;
            width: 100%;
        }
        button:hover { background-color: #218838; }

        #response-message {
            margin-top: 20px;
            padding: 15px;
            border-radius: 4px;
            display: none;
            font-weight: bold;
        }
        .success { background-color: #d4edda; color: #155724; border: 1px solid #c3e6cb; }
        .error { background-color: #f8d7da; color: #721c24; border: 1px solid #f5c6cb; }

        #whatsapp-link-container {
            margin-top: 20px;
            padding: 15px;
            background-color: #075E54;
            color: white;
            border-radius: 4px;
            text-align: center;
            display: none;
        }
        #whatsapp-link-container a {
            color: white;
            text-decoration: none;
            font-weight: bold;
            display: block;
            margin-top: 10px;
            padding: 10px;
            background-color: #128C7E;
            border-radius: 4px;
        }
        .apology-fields {
            padding: 15px;
            border: 1px solid #ffc107;
            background-color: #fff3cd;
            color: #333;
            border-radius: 4px;
            margin-bottom: 20px;
            display: none;
        }
    </style>
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script> 
    <script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
</head>
<body>

<div class="container">
    <button class="theme-toggle" onclick="toggleTheme()">Ø§Ù„ÙˆØ¶Ø¹ Ø§Ù„Ù„ÙŠÙ„ÙŠ ğŸŒ™</button>
    <h1>ğŸ“ ØªØ³Ø¬ÙŠÙ„ Ø­Ø¶ÙˆØ± Ø§Ù„Ù…ØªØ·ÙˆØ¹ÙŠÙ†</h1>

    <form id="attendance-form">
        <label for="volunteer-name">Ø§Ù„Ø§Ø³Ù…:</label>
        <select id="volunteer-name" required>
            <option value="">Ø§Ø®ØªØ± Ø§Ø³Ù…Ùƒ</option>
        </select>

        <label for="volunteer-pass">ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ±:</label>
        <div class="pass-wrapper">
            <input type="password" id="volunteer-pass" maxlength="3" inputmode="numeric" placeholder="Ø£Ø¯Ø®Ù„ ÙƒÙˆØ¯ Ø§Ù„Ù…Ø±ÙˆØ±" required>
            <button type="button" class="toggle-pass" onclick="togglePass()">Ø¥Ø¸Ù‡Ø§Ø±</button>
        </div>

        <label for="registration-type">Ù†ÙˆØ¹ Ø§Ù„ØªØ³Ø¬ÙŠÙ„:</label>
        <select id="registration-type" onchange="toggleApologyFields()" required>
            <option value="Ø­Ø¶ÙˆØ±">Ø­Ø¶ÙˆØ±</option>
            <option value="Ø§Ø¹ØªØ°Ø§Ø±">Ø§Ø¹ØªØ°Ø§Ø±</option>
        </select>

        <label>Ø§Ù„ÙŠÙˆÙ…/Ø§Ù„ØªØ§Ø±ÙŠØ® (ÙŠÙ…ÙƒÙ† Ø§Ø®ØªÙŠØ§Ø± Ø¹Ø¯Ø© Ø£ÙŠØ§Ù…):</label>
        <div id="dates-checkbox-container" onchange="toggleApologyFields()"></div>
        
        <div id="apology-container" class="apology-fields">
            <h4>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø§Ø¹ØªØ°Ø§Ø±</h4>
            <label for="apology-reason">Ø³Ø¨Ø¨ Ø§Ù„Ø§Ø¹ØªØ°Ø§Ø±:</label>
            <input type="text" id="apology-reason" placeholder="Ù…Ø«Ø§Ù„: Ø¸Ø±ÙˆÙ Ø·Ø§Ø±Ø¦Ø©ØŒ Ù…Ø±Ø¶">
            
            <div id="late-apology-field" style="display:none;">
                <label for="late-reason">Ø³Ø¨Ø¨ ØªØ£Ø®Ø± Ø§Ù„Ø§Ø¹ØªØ°Ø§Ø± (Ù„Ù„Ù…Ø³Ø¬Ù„ÙŠÙ† Ø§Ù„ÙŠÙˆÙ…):</label>
                <input type="text" id="late-reason" placeholder="Ø§ÙƒØªØ¨ Ø³Ø¨Ø¨ Ø§Ù„ØªØ£Ø®Ø± Ù‡Ù†Ø§...">
            </div>
        </div>

        <button type="submit">ØªØ³Ø¬ÙŠÙ„ ÙˆØ¥Ø±Ø³Ø§Ù„ Ù„Ù„ÙˆØ§ØªØ³Ø§Ø¨</button>
    </form>

    <div id="response-message"></div>
    <div id="whatsapp-link-container"></div>
</div>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCDJANXMfd6TR7R2ruLIi-xytlrB-LiCEs", 
        authDomain: "rdtt-15cbe.firebaseapp.com",
        projectId: "rdtt-15cbe",
        storageBucket: "rdtt-15cbe.firebasestorage.app",
        messagingSenderId: "219502671343",
        appId: "1:219502671343:web:b289b11869e25c9a30321a"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const whatsappNumber = "201223314173"; 

    const FIXED_VOLUNTEERS = {
        "Ø£Ø­Ù…Ø¯": "492", "Ù…Ø­Ù…Ø¯ Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…": "837", "Ù…Ø­Ù…Ø¯ Ø¹Ø¨Ø¯Ø§Ù„Ø­Ù…ÙŠØ¯": "159", "Ø³Ø§Ù…Ù‰": "628", 
        "Ù…Ù…ØªØ§Ø²": "540", "Ø­Ø¨ÙŠØ¨Ø©": "317", "Ø³Ø§Ù†Ø¯ÙŠ": "641", "Ø±Ø­Ø§Ø¨": "715", 
        "Ù…Ø¹Ø§Ø°": "264", "Ù…Ø§Ø²Ù†": "903", "Ø¥Ø¨Ø±Ø§Ù‡ÙŠÙ…": "371", "Ù…Ø¹ØªØ²": "826",
        "Ø³Ø¬Ø¯Ø©": "582", "Ø´Ù…Ø³": "194"
    };

    const JS_DAY_MAP = { 0: "Ø§Ù„Ø£Ø­Ø¯", 1: "Ø§Ù„Ø¥Ø«Ù†ÙŠÙ†", 2: "Ø§Ù„Ø«Ù„Ø§Ø«Ø§Ø¡", 3: "Ø§Ù„Ø£Ø±Ø¨Ø¹Ø§Ø¡", 4: "Ø§Ù„Ø®Ù…ÙŠØ³", 5: "Ø§Ù„Ø¬Ù…Ø¹Ø©", 6: "Ø§Ù„Ø³Ø¨Øª" };
    const MONTH_MAP = ["ÙŠÙ†Ø§ÙŠØ±", "ÙØ¨Ø±Ø§ÙŠØ±", "Ù…Ø§Ø±Ø³", "Ø£Ø¨Ø±ÙŠÙ„", "Ù…Ø§ÙŠÙˆ", "ÙŠÙˆÙ†ÙŠÙˆ", "ÙŠÙˆÙ„ÙŠÙˆ", "Ø£ØºØ³Ø·Ø³", "Ø³Ø¨ØªÙ…Ø¨Ø±", "Ø£ÙƒØªÙˆØ¨Ø±", "Ù†ÙˆÙÙ…Ø¨Ø±", "Ø¯ÙŠØ³Ù…Ø¨Ø±"];
    
    function toggleTheme() {
        document.body.classList.toggle('dark-mode');
    }

    function togglePass() {
        const passInput = document.getElementById('volunteer-pass');
        const toggleBtn = document.querySelector('.toggle-pass');
        if (passInput.type === "password") {
            passInput.type = "text";
            toggleBtn.textContent = "Ø¥Ø®ÙØ§Ø¡";
        } else {
            passInput.type = "password";
            toggleBtn.textContent = "Ø¥Ø¸Ù‡Ø§Ø±";
        }
    }

    function formatDateKey(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
    }

    function initializeForm() {
        const nameSelect = document.getElementById('volunteer-name');
        const dateContainer = document.getElementById('dates-checkbox-container');
        Object.keys(FIXED_VOLUNTEERS).sort().forEach(name => {
            const option = document.createElement('option');
            option.value = name; option.textContent = name;
            nameSelect.appendChild(option);
        });
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        for (let i = 0; i < 11; i++) {
            const date = new Date(today);
            date.setDate(today.getDate() + i);
            const dateKey = formatDateKey(date);
            const display = `${JS_DAY_MAP[date.getDay()]} (${date.getDate()} ${MONTH_MAP[date.getMonth()]} ${date.getFullYear()})${i===0?' - Ø§Ù„ÙŠÙˆÙ…':''}`;
            const div = document.createElement('div');
            div.className = 'date-checkbox-item';
            div.innerHTML = `<input type="checkbox" id="date-${dateKey}" name="selected-dates" value="${dateKey}" data-date-display="${display}">
                             <label for="date-${dateKey}">${display}</label>`;
            dateContainer.appendChild(div);
        }
    }

    function toggleApologyFields() {
        const type = document.getElementById('registration-type').value;
        const isApology = (type === 'Ø§Ø¹ØªØ°Ø§Ø±');
        document.getElementById('apology-container').style.display = isApology ? 'block' : 'none';
        const todayKey = formatDateKey(new Date());
        const isTodaySelected = !!document.querySelector(`input[value="${todayKey}"]:checked`);
        document.getElementById('late-apology-field').style.display = (isApology && isTodaySelected) ? 'block' : 'none';
    }

    function validateLateReason(text) {
        const arabicCharCount = (text.match(/[\u0600-\u06FF]/g) || []).length;
        return text.length >= 8 && arabicCharCount >= 4;
    }

    document.getElementById('attendance-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const name = document.getElementById('volunteer-name').value;
        const enteredPass = document.getElementById('volunteer-pass').value;
        const status = document.getElementById('registration-type').value;

        if (FIXED_VOLUNTEERS[name] !== enteredPass) {
            alert("âŒ ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©!");
            return;
        }

        const selectedDatesElements = document.querySelectorAll('#dates-checkbox-container input[type="checkbox"]:checked');
        if (selectedDatesElements.length === 0) {
            alert('ÙŠØ¬Ø¨ Ø§Ø®ØªÙŠØ§Ø± ÙŠÙˆÙ… ÙˆØ§Ø­Ø¯ Ø¹Ù„Ù‰ Ø§Ù„Ø£Ù‚Ù„.');
            return;
        }

        let fullReason = "";
        if (status === 'Ø§Ø¹ØªØ°Ø§Ø±') {
            const reason = document.getElementById('apology-reason').value;
            const late = document.getElementById('late-reason').value;
            const todayKey = formatDateKey(new Date());
            const isTodaySelected = !!document.querySelector(`input[value="${todayKey}"]:checked`);
            if (!reason) { alert('ÙŠØ±Ø¬Ù‰ Ø¥Ø¯Ø®Ø§Ù„ Ø³Ø¨Ø¨ Ø§Ù„Ø§Ø¹ØªØ°Ø§Ø±.'); return; }
            if (isTodaySelected && !validateLateReason(late)) {
                alert('ÙŠØ±Ø¬Ù‰ ÙƒØªØ§Ø¨Ø© Ø³Ø¨Ø¨ ØªØ§Ø®ÙŠØ± Ø­Ù‚ÙŠÙ‚Ù‰');
                return;
            }
            fullReason = reason + (late ? ` (ØªØ£Ø®Ø±: ${late})` : "");
        }

        const selectedDatesData = [];
        try {
            const now = new Date();
            for (const element of selectedDatesElements) {
                const dateKey = element.value;
                const dateDisplay = element.getAttribute('data-date-display');
                const docId = `${name}_${dateKey}`;
                const dataToSave = {
                    volunteerName: name, status: status, reason: fullReason,
                    registrationDateTimestamp: firebase.firestore.Timestamp.fromDate(new Date(dateKey)), 
                    dateKey: dateKey, 
                    registrationTime: dateDisplay + ' â€“ ' + now.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' }),
                    timestamp: firebase.firestore.FieldValue.serverTimestamp() 
                };
                await db.collection("user_attendance").doc(docId).set(dataToSave, { merge: true });
                selectedDatesData.push({ display: dateDisplay, key: dateKey });
            }
            document.getElementById('response-message').className = 'success';
            document.getElementById('response-message').textContent = `âœ… ØªÙ… Ø§Ù„ØªØ³Ø¬ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­.`;
            document.getElementById('response-message').style.display = 'block';
            createWhatsAppLink(name, status, selectedDatesData, fullReason);
        } catch (error) {
            alert("Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ³Ø¬ÙŠÙ„: " + error.message);
        }
    });

    function createWhatsAppLink(name, status, datesArray, reason) {
        const now = new Date();
        const fullTimeStr = now.toLocaleDateString('ar-EG') + " Ø§Ù„Ø³Ø§Ø¹Ø© " + now.toLocaleTimeString('ar-EG', { hour: '2-digit', minute: '2-digit' });
        let datesList = datesArray.map(d => `â€¢ ${d.display}`).join('\n');
        
        let messageBody = `ğŸ‘¤ Ø§Ù„Ù…ØªØ·ÙˆØ¹: ${name}\nğŸ“ Ø§Ù„Ø­Ø§Ù„Ø©: *${status}*\n\nğŸ—“ï¸ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ù…Ø³Ø¬Ù„Ø©:\n${datesList}\n\nğŸ•’ ÙˆÙ‚Øª ÙˆØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ø±Ø³Ø§Ù„:\n${fullTimeStr}${reason ? `\n\nØ³Ø¨Ø¨ Ø§Ù„Ø§Ø¹ØªØ°Ø§Ø±: ${reason}` : ""}`;
        
        const whatsappUrl = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(messageBody.trim())}`;
        const container = document.getElementById('whatsapp-link-container');
        container.innerHTML = `<p>Ø§Ø¶ØºØ· Ù„Ù„Ø¥Ø±Ø³Ø§Ù„ Ø¹Ø¨Ø± ÙˆØ§ØªØ³Ø§Ø¨:</p><a href="${whatsappUrl}" target="_blank">Ø¥Ø±Ø³Ø§Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ğŸ“²</a>`;
        container.style.display = 'block';
    }

    window.onload = initializeForm;
</script>

</body>
</html>
