<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„ÙˆÙ‚Ø§Ø¦ÙŠØ©</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root {
            --primary: #2563eb;       
            --primary-dark: #1e40af;
            --secondary: #64748b;     
            --success: #10b981;       
            --warning: #f59e0b;       
            --danger: #ef4444;        
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            --text-main: #1e293b;
            --text-light: #64748b;
            --sidebar-width: 260px;
        }

        * { box-sizing: border-box; outline: none; }
        
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            display: flex;
            min-height: 100vh;
        }

        /* --- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© --- */
        .sidebar {
            width: var(--sidebar-width);
            background: #fff;
            border-left: 1px solid #e2e8f0;
            position: fixed;
            height: 100%;
            padding: 20px;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 10px rgba(0,0,0,0.02);
            z-index: 100;
            transition: transform 0.3s ease;
        }

        .brand {
            font-size: 1.4rem;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 40px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            color: var(--text-light);
            text-decoration: none;
            border-radius: 10px;
            margin-bottom: 8px;
            font-weight: 500;
            transition: all 0.3s;
            cursor: pointer;
        }

        .nav-link:hover, .nav-link.active {
            background-color: #eff6ff;
            color: var(--primary);
        }

        .nav-link i { width: 20px; text-align: center; }

        /* --- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ --- */
        .main-content {
            flex: 1;
            margin-right: var(--sidebar-width);
            padding: 30px;
            width: calc(100% - var(--sidebar-width));
            transition: margin-right 0.3s ease, width 0.3s ease;
        }

        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .page-title h2 { margin: 0; font-size: 1.8rem; }
        .page-title p { margin: 5px 0 0; color: var(--text-light); }

        /* --- Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª --- */
        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
            border: 1px solid #e2e8f0;
        }

        /* --- Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª --- */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            border-right: 4px solid var(--primary);
            box-shadow: 0 2px 4px rgba(0,0,0,0.03);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .stat-info h3 { margin: 0; font-size: 2rem; color: var(--text-main); }
        .stat-info p { margin: 0; color: var(--text-light); font-size: 0.9rem; }
        .stat-icon {
            font-size: 2.5rem;
            opacity: 0.15;
            color: var(--primary);
        }

        /* --- Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ --- */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-main); }
        
        input, select {
            width: 100%;
            padding: 12px;
            border: 1px solid #cbd5e1;
            border-radius: 8px;
            font-family: 'Tajawal';
            font-size: 1rem;
            transition: border-color 0.3s;
        }
        input:focus, select:focus { border-color: var(--primary); }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-weight: 700;
            cursor: pointer;
            font-family: 'Tajawal';
            transition: transform 0.1s, opacity 0.2s;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }
        .btn:active { transform: scale(0.98); }
        .btn-primary { background: var(--primary); color: white; width: 100%; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; padding: 6px 12px; font-size: 0.85rem;}
        .btn-edit { background: var(--warning); color: white; padding: 6px 12px; font-size: 0.85rem;}
        .btn-secondary { background: var(--secondary); color: white; }
        
        .btn-pdf { background: #dc2626; color: white; }
        .btn-pdf:hover { background: #b91c1c; }

        /* --- Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ --- */
        .table-container { overflow-x: auto; border-radius: 12px; border: 1px solid #e2e8f0; }
        table { width: 100%; border-collapse: collapse; min-width: 700px; }
        thead { background: #f8fafc; }
        th { padding: 15px; text-align: right; color: var(--text-light); font-size: 0.9rem; font-weight: 700; }
        td { padding: 15px; border-top: 1px solid #e2e8f0; font-size: 0.95rem; vertical-align: middle;}
        tr:hover { background-color: #f8fafc; }
        
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        .chart-box { height: 350px; position: relative; }

        .section { display: none; animation: fadeIn 0.4s; }
        .section.active { display: block; }

        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        .mobile-menu-btn { display: none; font-size: 1.5rem; background: none; border: none; cursor: pointer; color: var(--primary); }

        @media (max-width: 768px) {
            .sidebar { transform: translateX(100%); width: 260px; right: 0; }
            .sidebar.open { transform: translateX(0); }
            .main-content { margin-right: 0; width: 100%; padding: 15px; }
            .mobile-menu-btn { display: block; }
            .charts-container { grid-template-columns: 1fr; }
            .stat-card { border-right: none; border-top: 4px solid var(--primary); }
        }

        /* ØªÙ†Ø³ÙŠÙ‚ Ø®Ø§Øµ Ù„Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø®ÙÙŠ (PDF Template) */
        #pdf-template {
            display: none; /* Ù…Ø®ÙÙŠ Ø¹Ù† Ø§Ù„Ø´Ø§Ø´Ø© */
            direction: rtl;
            font-family: 'Tajawal', sans-serif;
            padding: 20px;
        }
        
        .pdf-header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #333; padding-bottom: 20px; }
        .pdf-table { width: 100%; border-collapse: collapse; margin-top: 20px; }
        .pdf-table th, .pdf-table td { border: 1px solid #000; padding: 10px; text-align: center; font-size: 14px; }
        .pdf-table th { background-color: #f0f0f0; font-weight: bold; }
        .pdf-footer { margin-top: 30px; text-align: right; font-size: 12px; }
    </style>
</head>
<body>

<aside class="sidebar" id="sidebar">
    <div class="brand">
        <i class="fa-solid fa-shield-heart"></i>
        <span>Ø£Ù†Ø´Ø·Ø© Ø§Ù„ÙˆÙ‚Ø§ÙŠØ©</span>
    </div>
    
    <nav>
        <div class="nav-link active" onclick="showSection('dashboard', this)">
            <i class="fa-solid fa-chart-pie"></i> Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©
        </div>
        <div class="nav-link" onclick="showSection('entry', this)">
            <i class="fa-solid fa-plus-circle"></i> ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯
        </div>
        <div class="nav-link" onclick="showSection('reports', this)">
            <i class="fa-solid fa-table-list"></i> Ø³Ø¬Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        </div>
    </nav>
    
    <div style="margin-top: auto; font-size: 0.8rem; color: #94a3b8; text-align: center;">
        Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª v2.0
    </div>
</aside>

<main class="main-content">
    
    <div class="header-section">
        <button class="mobile-menu-btn" onclick="toggleSidebar()"><i class="fa-solid fa-bars"></i></button>
        <div class="page-title">
            <h2 id="page-header-title">Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©</h2>
            <p id="current-date-display"></p>
        </div>
        <div class="user-info"></div>
    </div>

    <div id="dashboard" class="section active">
        <div class="stats-grid">
            <div class="stat-card" style="border-color: var(--primary);">
                <div class="stat-info">
                    <h3 id="kpi-activities">0</h3>
                    <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„Ù…Ø³Ø¬Ù„Ø©</p>
                </div>
                <div class="stat-icon" style="color: var(--primary);"><i class="fa-solid fa-clipboard-list"></i></div>
            </div>
            <div class="stat-card" style="border-color: var(--success);">
                <div class="stat-info">
                    <h3 id="kpi-beneficiaries">0</h3>
                    <p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªÙÙŠØ¯ÙŠÙ†</p>
                </div>
                <div class="stat-icon" style="color: var(--success);"><i class="fa-solid fa-users"></i></div>
            </div>
            <div class="stat-card" style="border-color: var(--warning);">
                <div class="stat-info">
                    <h3 id="kpi-top-activity" style="font-size: 1.2rem;">-</h3>
                    <p>Ø§Ù„Ù†Ø´Ø§Ø· Ø§Ù„Ø£ÙƒØ«Ø± ØªÙ†ÙÙŠØ°Ø§Ù‹</p>
                </div>
                <div class="stat-icon" style="color: var(--warning);"><i class="fa-solid fa-crown"></i></div>
            </div>
        </div>

        <div class="charts-container">
            <div class="card chart-box">
                <h4 style="margin-top:0; color:var(--text-light)">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙÙŠØ¯ÙŠÙ† Ø­Ø³Ø¨ Ø§Ù„Ù†Ø´Ø§Ø·</h4>
                <canvas id="chartActivities"></canvas>
            </div>
            <div class="card chart-box">
                <h4 style="margin-top:0; color:var(--text-light)">Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø®Ù„Ø§Ù„ Ø§Ù„Ø£ÙŠØ§Ù… Ø§Ù„Ø£Ø®ÙŠØ±Ø©</h4>
                <canvas id="chartTrend"></canvas>
            </div>
        </div>
    </div>

    <div id="entry" class="section">
        <div class="card" style="max-width: 800px; margin: auto;">
            <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:20px;">
                <h3 style="margin:0; color:var(--primary);">ğŸ“ ØªØ³Ø¬ÙŠÙ„ Ù†Ø´Ø§Ø· Ø¬Ø¯ÙŠØ¯</h3>
                <button type="button" id="cancel-edit-btn" onclick="resetForm()" class="btn btn-secondary" style="display:none; padding: 5px 15px;">Ø¥Ù„ØºØ§Ø¡ Ø§Ù„ØªØ¹Ø¯ÙŠÙ„</button>
            </div>
            
            <form id="data-form">
                <input type="hidden" id="edit-doc-id"> 
                <div class="form-grid">
                    <div class="form-group">
                        <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ø´Ø§Ø·</label>
                        <input type="date" id="activity-date" required>
                    </div>
                    
                    <div class="form-group">
                        <label>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªÙÙŠØ¯ÙŠÙ†</label>
                        <input type="number" id="beneficiaries" placeholder="Ù…Ø«Ø§Ù„: 50" min="0" required>
                    </div>

                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>Ù†ÙˆØ¹ Ø§Ù„Ù†Ø´Ø§Ø·</label>
                        <select id="activity" required>
                            <option value="" disabled selected>--- Ø§Ø®ØªØ± Ø§Ù„Ù†Ø´Ø§Ø· Ù…Ù† Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© ---</option>
                            <option value="1- Ø­Ù…Ù„Ø§Øª Ø·Ø±Ù‚ Ø§Ù„Ø£Ø¨ÙˆØ§Ø¨">1- Ø­Ù…Ù„Ø§Øª Ø·Ø±Ù‚ Ø§Ù„Ø£Ø¨ÙˆØ§Ø¨</option>
                            <option value="2- Ù„Ù‚Ø§Ø¡Ø§Øª Ø£Ø³Ø±ÙŠØ©">2- Ù„Ù‚Ø§Ø¡Ø§Øª Ø£Ø³Ø±ÙŠØ©</option>
                            <option value="3- Ù„Ù‚Ø§Ø¡Ø§Øª Ø¯ÙŠÙ†ÙŠØ© (Ù…Ø³Ø§Ø¬Ø¯/ÙƒÙ†Ø§Ø¦Ø³)">3- Ù„Ù‚Ø§Ø¡Ø§Øª Ø¯ÙŠÙ†ÙŠØ© (Ù…Ø³Ø§Ø¬Ø¯/ÙƒÙ†Ø§Ø¦Ø³)</option>
                            <option value="4- Ù…ÙŠØ¯Ø§Ù†ÙŠØ© (Ù…ÙŠØ§Ø¯ÙŠÙ†/Ø£Ø³ÙˆØ§Ù‚/ÙˆØ±Ø´)">4- Ù…ÙŠØ¯Ø§Ù†ÙŠØ© (Ù…ÙŠØ§Ø¯ÙŠÙ†/Ø£Ø³ÙˆØ§Ù‚/ÙˆØ±Ø´)</option>
                            <option value="5- Ù…Ù‡Ø±Ø¬Ø§Ù†Ø§Øª Ø±ÙŠØ§Ø¶ÙŠØ© ÙˆÙÙ†ÙŠØ©">5- Ù…Ù‡Ø±Ø¬Ø§Ù†Ø§Øª Ø±ÙŠØ§Ø¶ÙŠØ© ÙˆÙÙ†ÙŠØ©</option>
                            <option value="6- ÙˆØ±Ø´ Ø¹Ù…Ù„ Ù„Ù„Ø£Ø·ÙØ§Ù„">6- ÙˆØ±Ø´ Ø¹Ù…Ù„ Ù„Ù„Ø£Ø·ÙØ§Ù„</option>
                            <option value="7- ØªØ¯Ø±ÙŠØ¨Ø§Øª Ø§Ù„Ù‚ÙŠØ§Ø¯Ø§Øª">7- ØªØ¯Ø±ÙŠØ¨Ø§Øª Ø§Ù„Ù‚ÙŠØ§Ø¯Ø§Øª</option>
                            <option value="8- Ø§Ù„Ù…Ø¬Ù…Ø¹Ø§Øª Ø§Ù„Ø®Ø¯Ù…ÙŠØ© (Ù…Ø¯Ø§Ø±Ø³/Ø¬Ù…Ø¹ÙŠØ§Øª)">8- Ø§Ù„Ù…Ø¬Ù…Ø¹Ø§Øª Ø§Ù„Ø®Ø¯Ù…ÙŠØ©</option>
                            <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
                        </select>
                    </div>
                </div>

                <div style="margin-top: 20px;">
                    <button type="submit" id="submit-btn" class="btn btn-primary">
                        <i class="fa-solid fa-save"></i> Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="reports" class="section">
        <div class="card">
            <div style="display: flex; gap: 15px; flex-wrap: wrap; align-items: flex-end; margin-bottom: 20px; background: #f8fafc; padding: 15px; border-radius: 10px;">
                <div style="flex: 1; min-width: 200px;">
                    <label style="font-size:0.9rem; font-weight:bold;">Ù…Ù† ØªØ§Ø±ÙŠØ®:</label>
                    <input type="date" id="filter-from-date">
                </div>
                <div style="flex: 1; min-width: 200px;">
                    <label style="font-size:0.9rem; font-weight:bold;">Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®:</label>
                    <input type="date" id="filter-to-date">
                </div>
                <button onclick="renderTable()" class="btn btn-primary" style="width: auto;">
                    <i class="fa-solid fa-filter"></i> Ø¹Ø±Ø¶
                </button>
                <button onclick="exportToPDF()" class="btn btn-pdf" style="width: auto;">
                    <i class="fa-solid fa-file-pdf"></i> Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± (PDF)
                </button>
            </div>

            <div class="table-container">
                <table id="reports-table">
                    <thead>
                        <tr>
                            <th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th>
                            <th>Ø§Ù„Ù†Ø´Ø§Ø·</th>
                            <th>Ø§Ù„Ù…Ø³ØªÙÙŠØ¯ÙŠÙ†</th>
                            <th style="width: 150px;">Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th>
                        </tr>
                    </thead>
                    <tbody id="data-table-body">
                        </tbody>
                </table>
            </div>
            <div id="table-loading" style="text-align: center; padding: 20px; display: none;">
                <i class="fa-solid fa-spinner fa-spin fa-2x" style="color: var(--primary);"></i>
            </div>
        </div>
    </div>

    <div id="pdf-template">
        <div class="pdf-header" style="border: none; margin-bottom: 10px; text-align: center;">
            <img id="pdf-logo-img" src="" style="width: 100%; max-width: 100%; height: auto;" alt="Header">
        </div>
        
        <div style="text-align: center; margin-bottom: 20px;">
            <h3 style="margin: 5px 0; text-decoration: underline;">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„ÙˆÙ‚Ø§Ø¦ÙŠØ© Ø§Ù„Ù…Ù†ÙØ°Ø©</h3>
            <p id="pdf-date-range" style="margin: 5px 0; font-size: 14px;">Ù…Ù† ØªØ§Ø±ÙŠØ®: ... Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®: ...</p>
        </div>
        
        <table class="pdf-table">
            <thead>
                <tr>
                    <th style="width: 40%; background-color: #e5e7eb;">Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„ÙˆÙ‚Ø§Ø¦ÙŠØ© Ø§Ù„Ù…Ù†ÙØ°Ø©</th>
                    <th style="width: 30%; background-color: #e5e7eb;">Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù†Ø´Ø·Ø©</th>
                    <th style="width: 30%; background-color: #e5e7eb;">Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªÙÙŠØ¯ÙŠÙ†</th>
                </tr>
            </thead>
            <tbody id="pdf-table-body">
                </tbody>
            <tfoot>
                <tr style="background-color: #f3f4f6; font-weight: bold;">
                    <td>Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø¹Ø§Ù…</td>
                    <td id="pdf-total-activities">0</td>
                    <td id="pdf-total-beneficiaries">0</td>
                </tr>
            </tfoot>
        </table>

        <div class="pdf-footer">
            <p>ØªÙ… Ø§Ø³ØªØ®Ø±Ø§Ø¬ Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø¨ØªØ§Ø±ÙŠØ®: <span id="pdf-print-date"></span></p>
        </div>
    </div>

</main>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    // ====================================================
    // ğŸ–¼ï¸ Ù…ÙƒØ§Ù† ÙƒÙˆØ¯ Ø§Ù„ØµÙˆØ±Ø© Base64
    // ====================================================
    // ğŸ”´ Ø¶Ø¹ ÙƒÙˆØ¯ Ø§Ù„Ù€ Base64 Ø§Ù„Ø·ÙˆÙŠÙ„ Ø¬Ø¯Ø§Ù‹ Ù‡Ù†Ø§ Ø¨Ø¯Ù„Ø§Ù‹ Ù…Ù† Ø§Ù„Ù†Øµ Ø§Ù„Ù…ÙˆØ¬ÙˆØ¯ Ø¨ÙŠÙ† Ø¹Ù„Ø§Ù…Ø§Øª Ø§Ù„ØªÙ†ØµÙŠØµ
    const PDF_HEADER_IMG = "data:image/jpeg;base64, ...... Ø¶Ø¹ Ø§Ù„ÙƒÙˆØ¯ Ù‡Ù†Ø§ ......";

    // ====================================================
    // âš™ï¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
    // ====================================================
    const firebaseConfig = {
        apiKey: "AIzaSyCDJANXMfd6TR7R2ruLIi-xytlrB-LiCEs", 
        authDomain: "rdtt-15cbe.firebaseapp.com",
        projectId: "rdtt-15cbe",
        storageBucket: "rdtt-15cbe.firebasestorage.app",
        messagingSenderId: "219502671343",
        appId: "1:219502671343:web:b289b11869e25c9a30321a"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const ACTIVITIES_COLLECTION = 'dashboard_preventive_logs';

    let allDataCache = [];
    let chartInstance1 = null;
    let chartInstance2 = null;

    // ====================================================
    // ğŸš€ Ø¹Ù†Ø¯ ØªØ­Ù…ÙŠÙ„ Ø§Ù„ØµÙØ­Ø©
    // ====================================================
    window.onload = function() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('activity-date').value = today;
        document.getElementById('current-date-display').textContent = new Date().toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        
        // ØªØ¹ÙŠÙŠÙ† Ø§Ù„ØµÙˆØ±Ø© Ù„Ù„Ù‚Ø§Ù„Ø¨ Ø§Ù„Ù…Ø®ÙÙŠ Ø¹Ù†Ø¯ Ø§Ù„ØªØ­Ù…ÙŠÙ„
        if(PDF_HEADER_IMG && PDF_HEADER_IMG.length > 50) {
            document.getElementById('pdf-logo-img').src = PDF_HEADER_IMG;
        }

        loadDashboardData();
    };

    // ====================================================
    // ğŸ”¢ Ø¯Ø§Ù„Ø© ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ø£Ø±Ù‚Ø§Ù… (Animation Counter)
    // ====================================================
    function animateValue(obj, start, end, duration) {
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            
            // Ù…Ø¹Ø§Ø¯Ù„Ø© Ø§Ù„Ø­Ø±ÙƒØ© Ù„Ø¬Ø¹Ù„Ù‡Ø§ ØªØ¨Ø¯Ø£ Ø³Ø±ÙŠØ¹Ø§Ù‹ ÙˆØªØ¨Ø·Ø¦ ÙÙŠ Ø§Ù„Ù†Ù‡Ø§ÙŠØ© (Ease-out)
            const easeOutQuad = (t) => t * (2 - t);
            const currentVal = Math.floor(easeOutQuad(progress) * (end - start) + start);
            
            obj.innerHTML = currentVal.toLocaleString('ar-EG');
            
            if (progress < 1) {
                window.requestAnimationFrame(step);
            } else {
                obj.innerHTML = end.toLocaleString('ar-EG'); // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø±Ù‚Ù… Ø§Ù„Ù†Ù‡Ø§Ø¦ÙŠ
            }
        };
        window.requestAnimationFrame(step);
    }

    // ====================================================
    // ğŸ“± ÙˆØ¸Ø§Ø¦Ù Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
    // ====================================================
    function toggleSidebar() {
        document.getElementById('sidebar').classList.toggle('open');
    }

    function showSection(sectionId, linkElement) {
        document.querySelectorAll('.section').forEach(sec => sec.classList.remove('active'));
        document.getElementById(sectionId).classList.add('active');
        document.querySelectorAll('.nav-link').forEach(link => link.classList.remove('active'));
        linkElement.classList.add('active');

        const titles = { 'dashboard': 'Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©', 'entry': 'ØªØ³Ø¬ÙŠÙ„ Ù†Ø´Ø§Ø· Ø¬Ø¯ÙŠØ¯', 'reports': 'Ø³Ø¬Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª ÙˆØ§Ù„ØªÙ‚Ø§Ø±ÙŠØ±' };
        document.getElementById('page-header-title').textContent = titles[sectionId];

        if(sectionId === 'dashboard') loadDashboardData();
        if(sectionId === 'reports') renderTable();
        
        if(window.innerWidth <= 768) {
            document.getElementById('sidebar').classList.remove('open');
        }
    }

    // ====================================================
    // ğŸ’¾ Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
    // ====================================================
    document.getElementById('data-form').addEventListener('submit', async function(event) {
        event.preventDefault();
        const btn = document.getElementById('submit-btn');
        const originalBtnText = btn.innerHTML;
        btn.disabled = true;
        btn.innerHTML = '<i class="fa-solid fa-spinner fa-spin"></i> Ø¬Ø§Ø±ÙŠ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©...';

        const docId = document.getElementById('edit-doc-id').value;
        const data = {
            date: document.getElementById('activity-date').value,
            activity: document.getElementById('activity').value,
            beneficiaries: parseInt(document.getElementById('beneficiaries').value) || 0,
            count: 1,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        try {
            if (docId) {
                await db.collection(ACTIVITIES_COLLECTION).doc(docId).update(data);
                Swal.fire({ icon: 'success', title: 'ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„', timer: 1500, showConfirmButton: false });
                resetForm();
            } else {
                await db.collection(ACTIVITIES_COLLECTION).add(data);
                Swal.fire({ icon: 'success', title: 'ØªÙ… Ø§Ù„Ø­ÙØ¸', timer: 1500, showConfirmButton: false });
                document.getElementById('activity').value = '';
                document.getElementById('beneficiaries').value = '';
            }
        } catch (error) {
            Swal.fire({ icon: 'error', title: 'Ø®Ø·Ø£', text: 'ÙØ´Ù„ Ø§Ù„Ø§ØªØµØ§Ù„' });
        } finally {
            btn.disabled = false;
            btn.innerHTML = originalBtnText;
        }
    });

    async function loadDataFromFireStore(fromDate = null, toDate = null) {
        let q = db.collection(ACTIVITIES_COLLECTION).orderBy('date', 'desc');
        if (fromDate && toDate) q = q.where('date', '>=', fromDate).where('date', '<=', toDate);
        const snapshot = await q.get();
        return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    }

    async function deleteItem(id) {
        const result = await Swal.fire({ title: 'Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ØŸ', icon: 'warning', showCancelButton: true, confirmButtonText: 'Ù†Ø¹Ù…ØŒ Ø§Ø­Ø°Ù!', cancelButtonText: 'Ø¥Ù„ØºØ§Ø¡' });
        if (result.isConfirmed) {
            await db.collection(ACTIVITIES_COLLECTION).doc(id).delete();
            Swal.fire('ØªÙ… Ø§Ù„Ø­Ø°Ù!', '', 'success');
            renderTable(); loadDashboardData();
        }
    }

    function editItem(id, date, activity, beneficiaries) {
        document.querySelectorAll('.nav-link')[1].click(); 
        document.getElementById('edit-doc-id').value = id;
        document.getElementById('activity-date').value = date;
        document.getElementById('activity').value = activity;
        document.getElementById('beneficiaries').value = beneficiaries;
        
        const btn = document.getElementById('submit-btn');
        btn.innerHTML = '<i class="fa-solid fa-pen"></i> ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
        btn.classList.add('btn-warning');
        document.getElementById('cancel-edit-btn').style.display = 'block';
    }

    function resetForm() {
        document.getElementById('data-form').reset();
        document.getElementById('edit-doc-id').value = '';
        document.getElementById('activity-date').value = new Date().toISOString().split('T')[0];
        const btn = document.getElementById('submit-btn');
        btn.innerHTML = '<i class="fa-solid fa-save"></i> Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
        btn.classList.remove('btn-warning');
        document.getElementById('cancel-edit-btn').style.display = 'none';
    }

    // ====================================================
    // ğŸ“Š Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© (Dashboard) - Ù…Ø¹ Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª
    // ====================================================
    async function loadDashboardData() {
        const data = await loadDataFromFireStore();
        allDataCache = data;
        const totalActivities = data.length;
        const totalBeneficiaries = data.reduce((sum, item) => sum + (parseInt(item.beneficiaries) || 0), 0);
        
        const activityCounts = {};
        data.forEach(item => { activityCounts[item.activity] = (activityCounts[item.activity] || 0) + 1; });
        let topActivity = "-";
        let maxCount = 0;
        for (const [key, value] of Object.entries(activityCounts)) {
            if (value > maxCount) { maxCount = value; topActivity = key; }
        }

        // ØªØ´ØºÙŠÙ„ Ø§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù† Ù„Ù„Ø£Ø±Ù‚Ø§Ù…
        const kpiActivities = document.getElementById("kpi-activities");
        const kpiBeneficiaries = document.getElementById("kpi-beneficiaries");

        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø¹Ø¯Ù… Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„ØªØ´ØºÙŠÙ„ Ø¥Ø°Ø§ ÙƒØ§Ù†Øª Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù†ÙØ³Ù‡Ø§ (Ø§Ø®ØªÙŠØ§Ø±ÙŠØŒ Ù‡Ù†Ø§ Ø³Ù†Ù‚ÙˆÙ… Ø¨Ø§Ù„ØªØ­Ø¯ÙŠØ« Ø¯Ø§Ø¦Ù…Ø§Ù‹)
        animateValue(kpiActivities, 0, totalActivities, 2000); // Ù…Ø¯Ø© 2 Ø«Ø§Ù†ÙŠØ©
        animateValue(kpiBeneficiaries, 0, totalBeneficiaries, 2500); // Ù…Ø¯Ø© 2.5 Ø«Ø§Ù†ÙŠØ©

        document.getElementById('kpi-top-activity').textContent = topActivity.split(' ')[0] + '...';

        updateCharts(data);
    }

    function updateCharts(data) {
        const beneficiariesByActivity = {};
        data.forEach(item => {
            const act = item.activity.substring(0, 15) + (item.activity.length>15 ? '..' : ''); 
            beneficiariesByActivity[act] = (beneficiariesByActivity[act] || 0) + item.beneficiaries;
        });

        const timelineData = {};
        const sortedDates = data.sort((a,b) => new Date(a.date) - new Date(b.date));
        sortedDates.forEach(item => {
            timelineData[item.date] = (timelineData[item.date] || 0) + item.beneficiaries;
        });

        if(chartInstance1) chartInstance1.destroy();
        if(chartInstance2) chartInstance2.destroy();

        const ctx1 = document.getElementById('chartActivities').getContext('2d');
        chartInstance1 = new Chart(ctx1, {
            type: 'doughnut',
            data: {
                labels: Object.keys(beneficiariesByActivity),
                datasets: [{ data: Object.values(beneficiariesByActivity), backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6'], borderWidth: 1 }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: {font:{family:'Tajawal'}} } } }
        });

        const ctx2 = document.getElementById('chartTrend').getContext('2d');
        const dates = Object.keys(timelineData).slice(-10);
        const values = Object.values(timelineData).slice(-10);
        chartInstance2 = new Chart(ctx2, {
            type: 'bar',
            data: { labels: dates, datasets: [{ label: 'Ø¹Ø¯Ø¯ Ø§Ù„Ù…Ø³ØªÙÙŠØ¯ÙŠÙ†', data: values, backgroundColor: '#3b82f6', borderRadius: 5 }] },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
        });
    }

    // ====================================================
    // ğŸ“‹ Ø§Ù„Ø¬Ø¯ÙˆÙ„
    // ====================================================
    async function renderTable() {
        const tbody = document.getElementById('data-table-body');
        const fromDate = document.getElementById('filter-from-date').value;
        const toDate = document.getElementById('filter-to-date').value;

        tbody.innerHTML = '';
        document.getElementById('table-loading').style.display = 'block';

        const data = await loadDataFromFireStore(fromDate, toDate);
        
        document.getElementById('table-loading').style.display = 'none';

        if(data.length === 0) {
            tbody.innerHTML = `<tr><td colspan="4" style="text-align:center; padding:30px; color:#94a3b8;">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>`;
            return;
        }

        let totalBen = 0;
        data.forEach(item => {
            totalBen += item.beneficiaries;
            const row = `
                <tr>
                    <td>${item.date}</td>
                    <td style="font-weight:600; color:var(--primary-dark)">${item.activity}</td>
                    <td><span style="background:#dcfce7; color:#166534; padding:4px 8px; border-radius:6px; font-weight:bold;">${item.beneficiaries.toLocaleString('ar-EG')}</span></td>
                    <td>
                        <button class="btn btn-edit" onclick="editItem('${item.id}', '${item.date}', '${item.activity}', ${item.beneficiaries})"><i class="fa-solid fa-pen"></i></button>
                        <button class="btn btn-danger" onclick="deleteItem('${item.id}')"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>`;
            tbody.insertAdjacentHTML('beforeend', row);
        });

        tbody.insertAdjacentHTML('beforeend', `<tr style="background:#eff6ff; font-weight:bold;"><td colspan="2">Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ:</td><td colspan="2">${totalBen.toLocaleString('ar-EG')}</td></tr>`);
    }

    // ====================================================
    // ğŸ“„ ØªØµØ¯ÙŠØ± PDF (Ø§Ø³ØªØ®Ø¯Ø§Ù… Base64 Ù„Ù„ØµÙˆØ±Ø©)
    // ====================================================
    async function exportToPDF() {
        const fromDate = document.getElementById('filter-from-date').value;
        const toDate = document.getElementById('filter-to-date').value;
        
        Swal.fire({title: 'Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ù…Ù„Ù...', didOpen: () => { Swal.showLoading() }});

        const rawData = await loadDataFromFireStore(fromDate, toDate);

        if (rawData.length === 0) {
            Swal.close();
            Swal.fire('ØªÙ†Ø¨ÙŠÙ‡', 'Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª Ù„ØªØµØ¯ÙŠØ±Ù‡Ø§', 'info');
            return;
        }

        const summary = {};
        rawData.forEach(item => {
            if (!summary[item.activity]) summary[item.activity] = { count: 0, beneficiaries: 0 };
            summary[item.activity].count += 1;
            summary[item.activity].beneficiaries += parseInt(item.beneficiaries || 0);
        });

        const pdfBody = document.getElementById('pdf-table-body');
        pdfBody.innerHTML = '';
        let totalActs = 0;
        let totalBen = 0;

        Object.keys(summary).forEach(key => {
            totalActs += summary[key].count;
            totalBen += summary[key].beneficiaries;
            const row = `<tr>
                <td style="text-align:right">${key}</td>
                <td>${summary[key].count.toLocaleString('ar-EG')}</td>
                <td>${summary[key].beneficiaries.toLocaleString('ar-EG')}</td>
            </tr>`;
            pdfBody.insertAdjacentHTML('beforeend', row);
        });

        document.getElementById('pdf-total-activities').innerText = totalActs.toLocaleString('ar-EG');
        document.getElementById('pdf-total-beneficiaries').innerText = totalBen.toLocaleString('ar-EG');
        
        if (fromDate && toDate) {
            document.getElementById('pdf-date-range').innerText = `Ù…Ù† ØªØ§Ø±ÙŠØ®: ${fromDate} Ø¥Ù„Ù‰ ØªØ§Ø±ÙŠØ®: ${toDate}`;
        } else {
            document.getElementById('pdf-date-range').innerText = `ØªÙ‚Ø±ÙŠØ± Ø´Ø§Ù…Ù„ Ø­ØªÙ‰ ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…`;
        }
        document.getElementById('pdf-print-date').innerText = new Date().toLocaleDateString('ar-EG');

        // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„ØµÙˆØ±Ø© Ù‚Ø¨Ù„ Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
        if(!document.getElementById('pdf-logo-img').src.includes('base64')) {
             console.warn("Ù„Ù… ÙŠØªÙ… ÙˆØ¶Ø¹ ÙƒÙˆØ¯ Base64 Ù„Ù„ØµÙˆØ±Ø©!");
        }

        const element = document.getElementById('pdf-template');
        element.style.display = 'block'; 

        const opt = {
            margin:       [5, 10, 10, 10], // Ù‡ÙˆØ§Ù…Ø´ Ø£ØµØºØ± Ù„Ø§Ø³ØªÙŠØ¹Ø§Ø¨ Ø§Ù„ØµÙˆØ±Ø©
            filename:     `Preventive_Report_${new Date().toISOString().split('T')[0]}.pdf`,
            image:        { type: 'jpeg', quality: 1.0 }, // Ø¬ÙˆØ¯Ø© Ø¹Ø§Ù„ÙŠØ© Ù„Ù„ØµÙˆØ±Ø©
            html2canvas:  { scale: 2, useCORS: true },
            jsPDF:        { unit: 'mm', format: 'a4', orientation: 'portrait' }
        };

        html2pdf().set(opt).from(element).save().then(() => {
            element.style.display = 'none'; 
            Swal.close();
        });
    }

</script>
</body>
</html>
