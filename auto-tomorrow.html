<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„ÙˆÙ‚Ø§Ø¦ÙŠØ©</title>
    
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script> <script src="https://cdn.jsdelivr.net/npm/chart.js"></script> <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script> <style>
        :root {
            --primary: #2563eb;       
            --primary-dark: #1e40af;
            --secondary: #64748b;     
            --success: #10b981;       
            --warning: #f59e0b;       
            --danger: #ef4444;        
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            --text-main: #1e293b;
            --text-light: #64748b;
            --sidebar-width: 260px;
        }

        * { box-sizing: border-box; outline: none; }
        
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            display: flex;
            min-height: 100vh;
        }

        /* --- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© --- */
        .sidebar {
            width: var(--sidebar-width);
            background: #fff;
            border-left: 1px solid #e2e8f0;
            position: fixed;
            height: 100%;
            padding: 20px;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 10px rgba(0,0,0,0.02);
            z-index: 100;
            transition: transform 0.3s ease;
        }

        .brand {
            font-size: 1.4rem;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 40px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            color: var(--text-light);
            text-decoration: none;
            border-radius: 10px;
            margin-bottom: 8px;
            font-weight: 500;
            transition: all 0.3s;
            cursor: pointer;
        }

        .nav-link:hover, .nav-link.active {
            background-color: #eff6ff;
            color: var(--primary);
        }

        /* --- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ --- */
        .main-content {
            flex: 1;
            margin-right: var(--sidebar-width);
            padding: 30px;
            width: calc(100% - var(--sidebar-width));
            transition: margin-right 0.3s ease, width 0.3s ease;
        }

        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        /* --- Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª ÙˆØ§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª --- */
        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
            border: 1px solid #e2e8f0;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            border-right: 4px solid var(--primary);
            box-shadow: 0 2px 4px rgba(0,0,0,0.03);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .stat-info h3 { margin: 0; font-size: 2rem; color: var(--text-main); }
        .stat-icon { font-size: 2.5rem; opacity: 0.15; color: var(--primary); }

        /* --- Ø§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ© --- */
        .charts-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }
        .chart-box { height: 350px; position: relative; }

        /* --- Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ ÙˆØ§Ù„Ø¬Ø¯Ø§ÙˆÙ„ --- */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; }
        input, select { width: 100%; padding: 12px; border: 1px solid #cbd5e1; border-radius: 8px; font-family: 'Tajawal'; }
        
        .btn { padding: 12px 24px; border: none; border-radius: 8px; font-weight: 700; cursor: pointer; font-family: 'Tajawal'; display: inline-flex; align-items: center; gap: 8px; color: white;}
        .btn-primary { background: var(--primary); }
        .btn-danger { background: var(--danger); font-size: 0.8rem; padding: 6px 12px; }
        .btn-edit { background: var(--warning); font-size: 0.8rem; padding: 6px 12px; }
        .btn-pdf { background: #dc2626; } /* Ø²Ø± PDF Ø£Ø­Ù…Ø± */

        .table-container { overflow-x: auto; border-radius: 12px; border: 1px solid #e2e8f0; }
        table { width: 100%; border-collapse: collapse; min-width: 700px; }
        thead { background: #f8fafc; }
        th, td { padding: 15px; text-align: right; border-bottom: 1px solid #e2e8f0; }

        /* --- ØªØ¨Ø¯ÙŠÙ„ Ø§Ù„Ø£Ù‚Ø³Ø§Ù… --- */
        .section { display: none; animation: fadeIn 0.4s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* --- Ø§Ø³ØªØ¬Ø§Ø¨Ø© Ø§Ù„Ø¬ÙˆØ§Ù„ --- */
        .mobile-menu-btn { display: none; font-size: 1.5rem; background: none; border: none; cursor: pointer; color: var(--primary); }
        @media (max-width: 768px) {
            .sidebar { transform: translateX(100%); width: 260px; right: 0; }
            .sidebar.open { transform: translateX(0); }
            .main-content { margin-right: 0; width: 100%; padding: 15px; }
            .mobile-menu-btn { display: block; }
            .charts-container { grid-template-columns: 1fr; }
        }

        /* ============================================================
           ğŸ”´ ØªØµÙ…ÙŠÙ… Ø§Ù„ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ù…Ø®ØµØµ Ù„Ù„Ø·Ø¨Ø§Ø¹Ø© (Ù…Ø®ÙÙŠ)
           ============================================================ */
        #pdf-template {
            display: none; 
            width: 100%; background: white; padding: 20px; direction: rtl; font-family: 'Tajawal', sans-serif; color: #000;
        }
        .report-header { display: flex; justify-content: space-between; align-items: center; border-bottom: 2px solid #000; padding-bottom: 10px; margin-bottom: 20px; }
        .header-title { font-size: 18px; font-weight: bold; text-align: center; width: 100%; }
        
        .custom-table { width: 100%; border-collapse: collapse; margin-top: 10px; border: 2px solid #000; }
        .custom-table th, .custom-table td { border: 1px solid #000; padding: 8px; text-align: center; font-size: 14px; vertical-align: middle; }
        .custom-table th { background-color: #e0e0e0; font-weight: bold; font-size: 15px; }
        
        .col-activity { width: 50%; text-align: right !important; font-weight: bold; padding-right: 15px !important; }
        .total-row { background-color: #f0f0f0; font-weight: bold; }
    </style>
</head>
<body>

<aside class="sidebar" id="sidebar">
    <div class="brand">
        <i class="fa-solid fa-shield-heart"></i>
        <span>Ø£Ù†Ø´Ø·Ø© Ø§Ù„ÙˆÙ‚Ø§ÙŠØ©</span>
    </div>
    <nav>
        <div class="nav-link active" onclick="showSection('dashboard', this)">
            <i class="fa-solid fa-chart-pie"></i> Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©
        </div>
        <div class="nav-link" onclick="showSection('entry', this)">
            <i class="fa-solid fa-plus-circle"></i> ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯
        </div>
        <div class="nav-link" onclick="showSection('reports', this)">
            <i class="fa-solid fa-table-list"></i> Ø§Ù„ØªÙ‚Ø§Ø±ÙŠØ± ÙˆØ§Ù„Ø·Ø¨Ø§Ø¹Ø©
        </div>
    </nav>
</aside>

<main class="main-content">
    <div class="header-section">
        <button class="mobile-menu-btn" onclick="toggleSidebar()"><i class="fa-solid fa-bars"></i></button>
        <div>
            <h2 id="page-header-title" style="margin:0">Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©</h2>
            <p id="current-date-display" style="margin:5px 0 0; color:#64748b"></p>
        </div>
    </div>

    <div id="dashboard" class="section active">
        <div class="stats-grid">
            <div class="stat-card">
                <div class="stat-info"><h3 id="kpi-activities">0</h3><p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ù†Ø´Ø·Ø©</p></div>
                <div class="stat-icon"><i class="fa-solid fa-clipboard-list"></i></div>
            </div>
            <div class="stat-card">
                <div class="stat-info"><h3 id="kpi-beneficiaries">0</h3><p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªÙÙŠØ¯ÙŠÙ†</p></div>
                <div class="stat-icon" style="color: var(--success);"><i class="fa-solid fa-users"></i></div>
            </div>
            <div class="stat-card">
                <div class="stat-info"><h3 id="kpi-top-activity" style="font-size:1.2rem">-</h3><p>Ø§Ù„Ø£ÙƒØ«Ø± ØªÙ†ÙÙŠØ°Ø§Ù‹</p></div>
                <div class="stat-icon" style="color: var(--warning);"><i class="fa-solid fa-crown"></i></div>
            </div>
        </div>

        <div class="charts-container">
            <div class="card chart-box">
                <h4 style="margin-top:0; color:var(--text-light)">ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ù…Ø³ØªÙÙŠØ¯ÙŠÙ†</h4>
                <canvas id="chartActivities"></canvas>
            </div>
            <div class="card chart-box">
                <h4 style="margin-top:0; color:var(--text-light)">Ø§Ù„Ø£Ø¯Ø§Ø¡ Ø§Ù„Ø£Ø®ÙŠØ±</h4>
                <canvas id="chartTrend"></canvas>
            </div>
        </div>
    </div>

    <div id="entry" class="section">
        <div class="card" style="max-width: 800px; margin: auto;">
            <h3 style="margin-bottom:20px; color:var(--primary);">ğŸ“ ØªØ³Ø¬ÙŠÙ„ Ù†Ø´Ø§Ø· Ø¬Ø¯ÙŠØ¯</h3>
            <form id="data-form">
                <input type="hidden" id="edit-doc-id"> 
                <div class="form-grid">
                    <div class="form-group">
                        <label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ø´Ø§Ø·</label>
                        <input type="date" id="activity-date" required>
                    </div>
                    <div class="form-group">
                        <label>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªÙÙŠØ¯ÙŠÙ†</label>
                        <input type="number" id="beneficiaries" placeholder="0" min="0" required>
                    </div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>Ù†ÙˆØ¹ Ø§Ù„Ù†Ø´Ø§Ø·</label>
                        <select id="activity" required>
                            <option value="" disabled selected>--- Ø§Ø®ØªØ± Ø§Ù„Ù†Ø´Ø§Ø· ---</option>
                            <option value="1- Ø­Ù…Ù„Ø§Øª Ø·Ø±Ù‚ Ø§Ù„Ø£Ø¨ÙˆØ§Ø¨">1- Ø­Ù…Ù„Ø§Øª Ø·Ø±Ù‚ Ø§Ù„Ø£Ø¨ÙˆØ§Ø¨</option>
                            <option value="2- Ù„Ù‚Ø§Ø¡Ø§Øª Ø£Ø³Ø±ÙŠØ©">2- Ù„Ù‚Ø§Ø¡Ø§Øª Ø£Ø³Ø±ÙŠØ©</option>
                            <option value="3- Ù„Ù‚Ø§Ø¡Ø§Øª Ø¯ÙŠÙ†ÙŠØ© (Ù…Ø³Ø§Ø¬Ø¯/ÙƒÙ†Ø§Ø¦Ø³)">3- Ù„Ù‚Ø§Ø¡Ø§Øª Ø¯ÙŠÙ†ÙŠØ© (Ù…Ø³Ø§Ø¬Ø¯/ÙƒÙ†Ø§Ø¦Ø³)</option>
                            <option value="4- Ù…ÙŠØ¯Ø§Ù†ÙŠØ© (Ù…ÙŠØ§Ø¯ÙŠÙ†/Ø£Ø³ÙˆØ§Ù‚/ÙˆØ±Ø´)">4- Ù…ÙŠØ¯Ø§Ù†ÙŠØ© (Ù…ÙŠØ§Ø¯ÙŠÙ†/Ø£Ø³ÙˆØ§Ù‚/ÙˆØ±Ø´)</option>
                            <option value="5- Ù…Ù‡Ø±Ø¬Ø§Ù†Ø§Øª Ø±ÙŠØ§Ø¶ÙŠØ© ÙˆÙÙ†ÙŠØ©">5- Ù…Ù‡Ø±Ø¬Ø§Ù†Ø§Øª Ø±ÙŠØ§Ø¶ÙŠØ© ÙˆÙÙ†ÙŠØ©</option>
                            <option value="6- ÙˆØ±Ø´ Ø¹Ù…Ù„ Ù„Ù„Ø£Ø·ÙØ§Ù„">6- ÙˆØ±Ø´ Ø¹Ù…Ù„ Ù„Ù„Ø£Ø·ÙØ§Ù„</option>
                            <option value="7- ØªØ¯Ø±ÙŠØ¨Ø§Øª Ø§Ù„Ù‚ÙŠØ§Ø¯Ø§Øª">7- ØªØ¯Ø±ÙŠØ¨Ø§Øª Ø§Ù„Ù‚ÙŠØ§Ø¯Ø§Øª</option>
                            <option value="8- Ø§Ù„Ù…Ø¬Ù…Ø¹Ø§Øª Ø§Ù„Ø®Ø¯Ù…ÙŠØ© (Ù…Ø¯Ø§Ø±Ø³/Ø¬Ù…Ø¹ÙŠØ§Øª)">8- Ø§Ù„Ù…Ø¬Ù…Ø¹Ø§Øª Ø§Ù„Ø®Ø¯Ù…ÙŠØ©</option>
                            <option value="Ø£Ø®Ø±Ù‰">Ø£Ø®Ø±Ù‰</option>
                        </select>
                    </div>
                </div>
                <div style="margin-top: 20px; display:flex; gap:10px;">
                    <button type="submit" id="submit-btn" class="btn btn-primary" style="flex:1">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
                    <button type="button" id="cancel-edit-btn" onclick="resetForm()" class="btn" style="background:#64748b; display:none;">Ø¥Ù„ØºØ§Ø¡</button>
                </div>
            </form>
        </div>
    </div>

    <div id="reports" class="section">
        <div class="card">
            <div style="background:#f8fafc; padding:15px; border-radius:10px; display:flex; gap:10px; flex-wrap:wrap; align-items:end; margin-bottom:20px;">
                <div style="flex:1"><label>Ù…Ù†:</label><input type="date" id="filter-from-date"></div>
                <div style="flex:1"><label>Ø¥Ù„Ù‰:</label><input type="date" id="filter-to-date"></div>
                <button onclick="renderTable()" class="btn btn-primary"><i class="fa-solid fa-filter"></i> Ø¹Ø±Ø¶</button>
                <button onclick="exportToPDF()" class="btn btn-pdf"><i class="fa-solid fa-print"></i> Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„ØªÙ‚Ø±ÙŠØ± (Ø±Ø³Ù…ÙŠ)</button>
            </div>

            <div class="table-container">
                <table id="reports-table">
                    <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù†Ø´Ø§Ø·</th><th>Ø§Ù„Ù…Ø³ØªÙÙŠØ¯ÙŠÙ†</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
                    <tbody id="data-table-body"></tbody>
                </table>
            </div>
            <div id="table-loading" style="text-align:center; padding:20px; display:none;">Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ù…ÙŠÙ„...</div>
        </div>
    </div>

    <div id="pdf-template">
        <div class="report-header">
            <div style="width:100px;"><i class="fa-solid fa-hands-holding-child fa-3x"></i></div>
            <div class="header-title">
                ØµÙ†Ø¯ÙˆÙ‚ Ù…ÙƒØ§ÙØ­Ø© ÙˆØ¹Ù„Ø§Ø¬ Ø§Ù„Ø¥Ø¯Ù…Ø§Ù† ÙˆØ§Ù„ØªØ¹Ø§Ø·ÙŠ<br>
                <span style="font-size:14px; font-weight:normal;">ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„ÙˆÙ‚Ø§Ø¦ÙŠØ© Ø§Ù„Ù…Ù†ÙØ°Ø©</span><br>
                <span id="pdf-date-display" style="font-size:12px; font-weight:normal;"></span>
            </div>
        </div>
        <table class="custom-table">
            <thead>
                <tr><th class="col-activity">Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„ÙˆÙ‚Ø§Ø¦ÙŠØ© Ø§Ù„Ù…Ù†ÙØ°Ø©</th><th>Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù†Ø´Ø·Ø©</th><th>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªÙÙŠØ¯</th></tr>
            </thead>
            <tbody>
                <tr><td class="col-activity">1- Ø­Ù…Ù„Ø§Øª Ø·Ø±Ù‚ Ø§Ù„Ø£Ø¨ÙˆØ§Ø¨</td><td id="count-1">0</td><td id="ben-1">0</td></tr>
                <tr><td class="col-activity">2- Ù„Ù‚Ø§Ø¡Ø§Øª Ø£Ø³Ø±ÙŠØ©</td><td id="count-2">0</td><td id="ben-2">0</td></tr>
                <tr><td class="col-activity">3- Ù„Ù‚Ø§Ø¡Ø§Øª Ø¯ÙŠÙ†ÙŠØ© - ÙƒÙ†Ø§Ø¦Ø³ - Ù…Ø³Ø§Ø¬Ø¯</td><td id="count-3">0</td><td id="ben-3">0</td></tr>
                <tr><td class="col-activity" style="line-height:1.5">4- Ø§Ù„Ù…ÙŠØ¯Ø§Ù†ÙŠØ© (Ù…ÙŠØ§Ø¯ÙŠÙ† Ø¹Ø§Ù…Ø© - Ù…ÙˆØ§Ù‚Ù - Ù…Ù†Ø§Ø·Ù‚ Ù…Ø­ÙŠØ·Ø© - Ù…Ø­Ø§Ù„ - ÙˆØ±Ø´)</td><td id="count-4">0</td><td id="ben-4">0</td></tr>
                <tr><td class="col-activity">5- Ø§Ù„Ù…Ù‡Ø±Ø¬Ø§Ù†Ø§Øª ÙˆØ§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„Ø±ÙŠØ§Ø¶ÙŠØ© ÙˆØ§Ù„ÙÙ†ÙŠØ©</td><td id="count-5">0</td><td id="ben-5">0</td></tr>
                <tr><td class="col-activity">6- ÙˆØ±Ø´ Ø¹Ù…Ù„ Ù„Ù„Ø§Ø·ÙØ§Ù„</td><td id="count-6">0</td><td id="ben-6">0</td></tr>
                <tr><td class="col-activity">7- ØªØ¯Ø±ÙŠØ¨Ø§Øª Ø§Ù„Ù‚ÙŠØ§Ø¯Ø§Øª Ø§Ù„Ø·Ø¨ÙŠØ¹ÙŠØ© ÙˆØ§Ù„Ø´Ø¨Ø§Ø¨ÙŠØ©</td><td id="count-7">0</td><td id="ben-7">0</td></tr>
                <tr><td class="col-activity">8- Ø§Ù„Ù…Ø¬Ù…Ø¹Ø§Øª Ø§Ù„Ø®Ø¯Ù…ÙŠØ© (Ù…Ø¯Ø§Ø±Ø³ - Ù…Ø±Ø§ÙƒØ² Ø´Ø¨Ø§Ø¨ - Ø¬Ù…Ø¹ÙŠØ§Øª)</td><td id="count-8">0</td><td id="ben-8">0</td></tr>
            </tbody>
            <tfoot>
                <tr class="total-row"><td class="col-activity" style="text-align:center!important">Ø§Ù„Ø§Ø¬Ù…Ø§Ù„ÙŠ</td><td id="total-count">0</td><td id="total-ben">0</td></tr>
            </tfoot>
        </table>
    </div>

</main>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>

<script>
    // 1. Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyCDJANXMfd6TR7R2ruLIi-xytlrB-LiCEs", 
        authDomain: "rdtt-15cbe.firebaseapp.com",
        projectId: "rdtt-15cbe",
        storageBucket: "rdtt-15cbe.firebasestorage.app",
        messagingSenderId: "219502671343",
        appId: "1:219502671343:web:b289b11869e25c9a30321a"
    };
    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const ACTIVITIES_COLLECTION = 'dashboard_preventive_logs';

    let chartInstance1 = null;
    let chartInstance2 = null;

    // 2. Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø§Ù„Ø£ÙˆÙ„ÙŠ
    window.onload = function() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('activity-date').value = today;
        document.getElementById('filter-to-date').value = today;
        document.getElementById('current-date-display').textContent = new Date().toLocaleDateString('ar-EG', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
        loadDashboardData();
    };

    // 3. Ø§Ù„ØªÙ†Ù‚Ù„ ÙˆØ§Ù„Ù‚ÙˆØ§Ø¦Ù…
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
    function showSection(sectionId, linkElement) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(sectionId).classList.add('active');
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        linkElement.classList.add('active');
        
        if(sectionId === 'dashboard') loadDashboardData();
        if(sectionId === 'reports') renderTable();
        
        if(window.innerWidth <= 768) document.getElementById('sidebar').classList.remove('open');
    }

    // 4. Ø§Ù„Ø¹Ù…Ù„ÙŠØ§Øª (Ø­ÙØ¸ØŒ ØªØ¹Ø¯ÙŠÙ„ØŒ Ø­Ø°Ù)
    document.getElementById('data-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const btn = document.getElementById('submit-btn');
        btn.disabled = true; btn.innerText = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...';

        const id = document.getElementById('edit-doc-id').value;
        const data = {
            date: document.getElementById('activity-date').value,
            activity: document.getElementById('activity').value,
            beneficiaries: parseInt(document.getElementById('beneficiaries').value) || 0,
            count: 1, timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        try {
            if(id) {
                await db.collection(ACTIVITIES_COLLECTION).doc(id).update(data);
                Swal.fire('ØªÙ… Ø§Ù„ØªØ¹Ø¯ÙŠÙ„', '', 'success');
            } else {
                await db.collection(ACTIVITIES_COLLECTION).add(data);
                Swal.fire('ØªÙ… Ø§Ù„Ø­ÙØ¸', '', 'success');
            }
            resetForm();
        } catch(err) { Swal.fire('Ø®Ø·Ø£', 'ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø§Ù†ØªØ±Ù†Øª', 'error'); }
        btn.disabled = false; btn.innerText = 'Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
    });

    async function deleteItem(id) {
        const r = await Swal.fire({ title: 'Ø­Ø°ÙØŸ', icon: 'warning', showCancelButton: true, confirmButtonText: 'Ù†Ø¹Ù…', cancelButtonText: 'Ù„Ø§' });
        if(r.isConfirmed) {
            await db.collection(ACTIVITIES_COLLECTION).doc(id).delete();
            renderTable(); loadDashboardData();
            Swal.fire('ØªÙ… Ø§Ù„Ø­Ø°Ù', '', 'success');
        }
    }

    function editItem(id, date, act, ben) {
        document.querySelectorAll('.nav-link')[1].click(); // Ø§Ù„Ø°Ù‡Ø§Ø¨ Ù„Ù„ØªØ¨ÙˆÙŠØ¨ Ø§Ù„Ø«Ø§Ù†ÙŠ
        document.getElementById('edit-doc-id').value = id;
        document.getElementById('activity-date').value = date;
        document.getElementById('activity').value = act;
        document.getElementById('beneficiaries').value = ben;
        document.getElementById('cancel-edit-btn').style.display = 'block';
        document.getElementById('submit-btn').innerText = 'ØªØ¹Ø¯ÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
    }

    function resetForm() {
        document.getElementById('data-form').reset();
        document.getElementById('edit-doc-id').value = '';
        document.getElementById('cancel-edit-btn').style.display = 'none';
        document.getElementById('submit-btn').innerText = 'Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª';
    }

    // 5. Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø© ÙˆØ§Ù„Ø±Ø³ÙˆÙ… Ø§Ù„Ø¨ÙŠØ§Ù†ÙŠØ©
    async function loadDashboardData() {
        const snap = await db.collection(ACTIVITIES_COLLECTION).get();
        const data = snap.docs.map(d => d.data());

        // KPIs
        const totalActs = data.length;
        const totalBen = data.reduce((s, i) => s + (i.beneficiaries || 0), 0);
        
        // Ø§Ù„Ø£ÙƒØ«Ø± ØªÙƒØ±Ø§Ø±Ø§Ù‹
        const counts = {}; data.forEach(i => counts[i.activity] = (counts[i.activity]||0)+1);
        let topAct = "-", max = 0;
        for(let k in counts) if(counts[k] > max) { max = counts[k]; topAct = k; }

        document.getElementById('kpi-activities').innerText = totalActs.toLocaleString('ar-EG');
        document.getElementById('kpi-beneficiaries').innerText = totalBen.toLocaleString('ar-EG');
        document.getElementById('kpi-top-activity').innerText = topAct.split(' ')[0] + '..';

        updateCharts(data);
    }

    function updateCharts(data) {
        // Doughnut Data
        const benByAct = {};
        data.forEach(i => benByAct[i.activity] = (benByAct[i.activity]||0) + i.beneficiaries);

        // Bar Data (Timeline)
        const timeline = {};
        data.sort((a,b) => new Date(a.date) - new Date(b.date)).forEach(i => timeline[i.date] = (timeline[i.date]||0) + i.beneficiaries);

        if(chartInstance1) chartInstance1.destroy();
        if(chartInstance2) chartInstance2.destroy();

        // Chart 1
        const ctx1 = document.getElementById('chartActivities').getContext('2d');
        chartInstance1 = new Chart(ctx1, {
            type: 'doughnut',
            data: {
                labels: Object.keys(benByAct),
                datasets: [{ data: Object.values(benByAct), backgroundColor: ['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6'] }]
            },
            options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'right', labels: {font:{family:'Tajawal'}} } } }
        });

        // Chart 2
        const ctx2 = document.getElementById('chartTrend').getContext('2d');
        chartInstance2 = new Chart(ctx2, {
            type: 'bar',
            data: {
                labels: Object.keys(timeline).slice(-7), // Ø¢Ø®Ø± 7 Ø£ÙŠØ§Ù…
                datasets: [{ label: 'Ù…Ø³ØªÙÙŠØ¯ÙŠÙ†', data: Object.values(timeline).slice(-7), backgroundColor: '#3b82f6', borderRadius: 4 }]
            },
            options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true } }, plugins: { legend: { display: false } } }
        });
    }

    // 6. Ø§Ù„Ø¬Ø¯ÙˆÙ„ ÙˆØ§Ù„Ù…Ø¹Ø§ÙŠÙ†Ø©
    async function renderTable() {
        const tbody = document.getElementById('data-table-body');
        const from = document.getElementById('filter-from-date').value;
        const to = document.getElementById('filter-to-date').value;
        
        tbody.innerHTML = ''; document.getElementById('table-loading').style.display = 'block';
        
        let q = db.collection(ACTIVITIES_COLLECTION).orderBy('date', 'desc');
        if(from && to) q = q.where('date', '>=', from).where('date', '<=', to);
        
        const snap = await q.get();
        document.getElementById('table-loading').style.display = 'none';

        if(snap.empty) { tbody.innerHTML = '<tr><td colspan="4">Ù„Ø§ ØªÙˆØ¬Ø¯ Ø¨ÙŠØ§Ù†Ø§Øª</td></tr>'; return; }

        snap.docs.forEach(doc => {
            const d = doc.data();
            tbody.innerHTML += `
                <tr>
                    <td>${d.date}</td>
                    <td style="font-weight:bold">${d.activity}</td>
                    <td><span style="background:#dcfce7;color:#166534;padding:2px 8px;border-radius:10px">${d.beneficiaries}</span></td>
                    <td>
                        <button onclick="editItem('${doc.id}','${d.date}','${d.activity}',${d.beneficiaries})" class="btn btn-edit"><i class="fa-solid fa-pen"></i></button>
                        <button onclick="deleteItem('${doc.id}')" class="btn btn-danger"><i class="fa-solid fa-trash"></i></button>
                    </td>
                </tr>`;
        });
    }

    // 7. Ø·Ø¨Ø§Ø¹Ø© PDF (Ø§Ù„ØªÙ†Ø³ÙŠÙ‚ Ø§Ù„Ø«Ø§Ø¨Øª)
    async function exportToPDF() {
        const from = document.getElementById('filter-from-date').value;
        const to = document.getElementById('filter-to-date').value;
        
        Swal.fire({title: 'Ø¬Ø§Ø±ÙŠ Ø§Ù„ØªØ­Ø¶ÙŠØ±...', didOpen: () => Swal.showLoading()});

        let q = db.collection(ACTIVITIES_COLLECTION);
        if(from && to) q = q.where('date', '>=', from).where('date', '<=', to);
        const snap = await q.get();

        // ØªØµÙÙŠØ± Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª
        let stats = {}; for(let i=1; i<=8; i++) stats[i] = { c:0, b:0 };

        // ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        snap.docs.forEach(doc => {
            const d = doc.data();
            const act = d.activity;
            const ben = parseInt(d.beneficiaries) || 0;

            if(act.includes('1-') || act.includes('Ø·Ø±Ù‚ Ø§Ù„Ø£Ø¨ÙˆØ§Ø¨')) { stats[1].c++; stats[1].b += ben; }
            else if(act.includes('2-') || act.includes('Ø£Ø³Ø±ÙŠØ©')) { stats[2].c++; stats[2].b += ben; }
            else if(act.includes('3-') || act.includes('Ø¯ÙŠÙ†ÙŠØ©') || act.includes('Ù…Ø³Ø§Ø¬Ø¯')) { stats[3].c++; stats[3].b += ben; }
            else if(act.includes('4-') || act.includes('Ù…ÙŠØ¯Ø§Ù†ÙŠØ©')) { stats[4].c++; stats[4].b += ben; }
            else if(act.includes('5-') || act.includes('Ù…Ù‡Ø±Ø¬Ø§Ù†Ø§Øª')) { stats[5].c++; stats[5].b += ben; }
            else if(act.includes('6-') || act.includes('ÙˆØ±Ø´') || act.includes('Ø£Ø·ÙØ§Ù„')) { stats[6].c++; stats[6].b += ben; }
            else if(act.includes('7-') || act.includes('ØªØ¯Ø±ÙŠØ¨Ø§Øª') || act.includes('Ø§Ù„Ù‚ÙŠØ§Ø¯Ø§Øª')) { stats[7].c++; stats[7].b += ben; }
            else if(act.includes('8-') || act.includes('Ø§Ù„Ù…Ø¬Ù…Ø¹Ø§Øª') || act.includes('Ù…Ø¯Ø§Ø±Ø³')) { stats[8].c++; stats[8].b += ben; }
        });

        // ØªØ¹Ø¨Ø¦Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„
        let totC=0, totB=0;
        for(let i=1; i<=8; i++) {
            document.getElementById(`count-${i}`).innerText = stats[i].c.toLocaleString('ar-EG');
            document.getElementById(`ben-${i}`).innerText = stats[i].b.toLocaleString('ar-EG');
            totC += stats[i].c; totB += stats[i].b;
        }
        document.getElementById('total-count').innerText = totC.toLocaleString('ar-EG');
        document.getElementById('total-ben').innerText = totB.toLocaleString('ar-EG');

        // Ø§Ù„ØªØ§Ø±ÙŠØ®
        if(from && to) document.getElementById('pdf-date-display').innerText = `Ù…Ù† ${from} Ø¥Ù„Ù‰ ${to}`;
        else document.getElementById('pdf-date-display').innerText = `Ø­ØªÙ‰ ØªØ§Ø±ÙŠØ® Ø§Ù„ÙŠÙˆÙ…`;

        // Ø§Ù„Ø·Ø¨Ø§Ø¹Ø©
        const el = document.getElementById('pdf-template');
        el.style.display = 'block';
        html2pdf().set({ margin: 10, filename: 'Report.pdf', image: { type: 'jpeg', quality: 0.98 }, html2canvas: { scale: 2 }, jsPDF: { unit: 'mm', format: 'a4' } }).from(el).save().then(() => { el.style.display = 'none'; Swal.close(); });
    }
</script>

</body>
                                          </html>
