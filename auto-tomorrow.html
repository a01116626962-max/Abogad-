<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ù†Ø¸Ø§Ù… Ø¥Ø¯Ø§Ø±Ø© Ø§Ù„Ø£Ù†Ø´Ø·Ø© Ø§Ù„ÙˆÙ‚Ø§Ø¦ÙŠØ©</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@400;500;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>

    <style>
        :root {
            --primary: #2563eb;       
            --primary-dark: #1e40af;
            --secondary: #64748b;     
            --success: #10b981;       
            --warning: #f59e0b;       
            --danger: #ef4444;        
            --bg-body: #f1f5f9;
            --bg-card: #ffffff;
            --text-main: #1e293b;
            --text-light: #64748b;
            --sidebar-width: 260px;
        }

        * { box-sizing: border-box; outline: none; }
        
        body {
            font-family: 'Tajawal', sans-serif;
            background-color: var(--bg-body);
            color: var(--text-main);
            margin: 0;
            display: flex;
            min-height: 100vh;
        }

        /* --- Ø§Ù„Ù‚Ø§Ø¦Ù…Ø© Ø§Ù„Ø¬Ø§Ù†Ø¨ÙŠØ© --- */
        .sidebar {
            width: var(--sidebar-width);
            background: #fff;
            border-left: 1px solid #e2e8f0;
            position: fixed;
            height: 100%;
            padding: 20px;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 10px rgba(0,0,0,0.02);
            z-index: 100;
            transition: transform 0.3s ease;
        }

        .brand {
            font-size: 1.4rem;
            font-weight: 800;
            color: var(--primary);
            margin-bottom: 40px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 15px;
            color: var(--text-light);
            text-decoration: none;
            border-radius: 10px;
            margin-bottom: 8px;
            font-weight: 500;
            transition: all 0.3s;
            cursor: pointer;
        }

        .nav-link:hover, .nav-link.active {
            background-color: #eff6ff;
            color: var(--primary);
        }

        /* --- Ø§Ù„Ù…Ø­ØªÙˆÙ‰ Ø§Ù„Ø±Ø¦ÙŠØ³ÙŠ --- */
        .main-content {
            flex: 1;
            margin-right: var(--sidebar-width);
            padding: 30px;
            width: calc(100% - var(--sidebar-width));
            transition: margin-right 0.3s ease, width 0.3s ease;
        }

        .header-section {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .page-title h2 { margin: 0; font-size: 1.8rem; }
        .page-title p { margin: 5px 0 0; color: var(--text-light); }

        /* --- Ø§Ù„Ø¨Ø·Ø§Ù‚Ø§Øª --- */
        .card {
            background: var(--bg-card);
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            margin-bottom: 25px;
            border: 1px solid #e2e8f0;
        }

        /* --- Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª --- */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: #fff;
            padding: 20px;
            border-radius: 12px;
            border-right: 4px solid var(--primary);
            box-shadow: 0 2px 4px rgba(0,0,0,0.03);
            display: flex;
            align-items: center;
            justify-content: space-between;
        }
        .stat-info h3 { margin: 0; font-size: 2rem; color: var(--text-main); }
        .stat-info p { margin: 0; color: var(--text-light); font-size: 0.9rem; }
        .stat-icon { font-size: 2.5rem; opacity: 0.15; color: var(--primary); }

        /* --- Ø§Ù„Ù†Ù…Ø§Ø°Ø¬ --- */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
        }

        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 600; color: var(--text-main); }
        
        input, select {
            width: 100%; padding: 12px; border: 1px solid #cbd5e1;
            border-radius: 8px; font-family: 'Tajawal'; font-size: 1rem;
        }

        .btn {
            padding: 12px 24px; border: none; border-radius: 8px;
            font-weight: 700; cursor: pointer; font-family: 'Tajawal';
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
        }
        .btn-primary { background: var(--primary); color: white; width: 100%; }
        .btn-success { background: var(--success); color: white; }
        .btn-danger { background: var(--danger); color: white; padding: 6px 12px; }
        .btn-edit { background: var(--warning); color: white; padding: 6px 12px; }
        .btn-pdf { background: #dc2626; color: white; }

        /* --- Ø§Ù„Ø¬Ø¯Ø§ÙˆÙ„ --- */
        .table-container { overflow-x: auto; border-radius: 12px; border: 1px solid #e2e8f0; }
        table { width: 100%; border-collapse: collapse; min-width: 700px; }
        thead { background: #f8fafc; }
        th { padding: 15px; text-align: right; color: var(--text-light); font-weight: 700; }
        td { padding: 15px; border-top: 1px solid #e2e8f0; }
        
        .charts-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 25px; margin-bottom: 30px; }
        .chart-box { height: 350px; position: relative; }
        .section { display: none; animation: fadeIn 0.4s; }
        .section.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
        .mobile-menu-btn { display: none; font-size: 1.5rem; background: none; border: none; cursor: pointer; color: var(--primary); }

        @media (max-width: 768px) {
            .sidebar { transform: translateX(100%); right: 0; }
            .sidebar.open { transform: translateX(0); }
            .main-content { margin-right: 0; width: 100%; padding: 15px; }
            .mobile-menu-btn { display: block; }
        }

        /* ========================================
        ğŸ¨ ØªÙ†Ø³ÙŠÙ‚ ØªÙ‚Ø±ÙŠØ± Ø§Ù„Ø·Ø¨Ø§Ø¹Ø© (Ø§Ù„ØµÙˆØ±Ø© ÙˆØ§Ù„Ø®Ø§Ù†Ø§Øª)
        ========================================
        */
        #pdf-template {
            display: none; /* Ù…Ø®ÙÙŠØŒ ÙŠØ¸Ù‡Ø± ÙÙ‚Ø· Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØµØ¯ÙŠØ± */
            width: 794px;  /* Ø¹Ø±Ø¶ A4 Ø¨Ø§Ù„Ø¨ÙƒØ³Ù„ ØªÙ‚Ø±ÙŠØ¨Ø§Ù‹ */
            height: 1123px; /* Ø§Ø±ØªÙØ§Ø¹ A4 */
            position: relative;
            margin: 0 auto;
            color: #000;
            font-family: 'Arial', sans-serif; /* Ø®Ø· ÙˆØ§Ø¶Ø­ Ù„Ù„Ø£Ø±Ù‚Ø§Ù… */
        }

        /* Ø§Ù„ØµÙˆØ±Ø© Ø§Ù„Ø®Ù„ÙÙŠØ© ØªÙ…Ù„Ø£ Ø§Ù„Ù‚Ø§Ù„Ø¨ */
        #pdf-bg-image {
            width: 100%;
            height: 100%;
            display: block;
            object-fit: fill; 
        }

        /* Ø§Ù„Ø®Ø§Ù†Ø§Øª (Overlay Values) */
        .val-box {
            position: absolute;
            /* background: rgba(255, 255, 0, 0.3); Ù„ØªØ¬Ø±Ø¨Ø© Ø§Ù„Ø£Ù…Ø§ÙƒÙ† - Ø§Ø­Ø°ÙÙ‡Ø§ Ù„Ø§Ø­Ù‚Ø§Ù‹ */
            width: 15%; /* Ø¹Ø±Ø¶ ØªÙ‚Ø¯ÙŠØ±ÙŠ Ù„Ù„Ø®Ø§Ù†Ø© */
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 16px;
            font-weight: bold;
            color: #000;
            z-index: 10;
        }

        /* Ø§Ù„Ø¥Ø­Ø¯Ø§Ø«ÙŠØ§Øª Ø§Ù„ØªÙ‚Ø±ÙŠØ¨ÙŠØ© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØ±Ø© (Percentage for responsiveness within PDF container) */
        /* Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙˆØ³Ø·: Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù†Ø´Ø·Ø© - Left: 42% (RTL means visual right is low %, visually centered is ~45%) */
        /* Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø£ÙŠØ³Ø±: Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªÙÙŠØ¯ÙŠÙ† - Left: 15% */
        
        /* Ø¶Ø¨Ø· Ø§Ù„Ø¹Ù…ÙˆØ¯ Ø§Ù„Ø±Ø£Ø³ÙŠ Ù„ÙƒÙ„ ØµÙ - ØªÙ… Ø§Ù„ØªÙ‚Ø¯ÙŠØ± Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø§Ù„ØµÙˆØ±Ø© */
        /* Ø§Ù„ØµÙ 1: Ø·Ø±Ù‚ Ø§Ù„Ø£Ø¨ÙˆØ§Ø¨ */
        .r1 { top: 22.5%; } 
        /* Ø§Ù„ØµÙ 2: Ù„Ù‚Ø§Ø¡Ø§Øª Ø£Ø³Ø±ÙŠØ© */
        .r2 { top: 28.5%; }
        /* Ø§Ù„ØµÙ 3: Ù„Ù‚Ø§Ø¡Ø§Øª Ø¯ÙŠÙ†ÙŠØ© */
        .r3 { top: 34.5%; }
        /* Ø§Ù„ØµÙ 4: Ù…Ø¨Ø§Ø¯Ø±Ø§Øª Ù…ÙŠØ¯Ø§Ù†ÙŠØ© */
        .r4 { top: 43.5%; }
        /* Ø§Ù„ØµÙ 5: Ù…Ù‡Ø±Ø¬Ø§Ù†Ø§Øª */
        .r5 { top: 52.5%; }
        /* Ø§Ù„ØµÙ 6: ÙˆØ±Ø´ Ø¹Ù…Ù„ */
        .r6 { top: 58.5%; }
        /* Ø§Ù„ØµÙ 7: ØªØ¯Ø±ÙŠØ¨Ø§Øª Ù‚ÙŠØ§Ø¯Ø§Øª */
        .r7 { top: 64.5%; }
        /* Ø§Ù„ØµÙ 8: Ù…Ø¬Ù…Ø¹Ø§Øª Ø®Ø¯Ù…ÙŠØ© */
        .r8 { top: 72.5%; }
        /* Ø§Ù„ØµÙ 9: Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ */
        .r9 { top: 78.5%; }

        /* Ø¶Ø¨Ø· Ø§Ù„Ø£Ø¹Ù…Ø¯Ø© Ø£ÙÙ‚ÙŠØ§Ù‹ */
        .col-count { left: 45%; width: 18%; text-align: center; } /* Ø¹Ù…ÙˆØ¯ Ø¹Ø¯Ø¯ Ø§Ù„Ø£Ù†Ø´Ø·Ø© */
        .col-ben { left: 16%; width: 18%; text-align: center; }   /* Ø¹Ù…ÙˆØ¯ Ø§Ù„Ù…Ø³ØªÙÙŠØ¯ÙŠÙ† */

    </style>
</head>
<body>

<aside class="sidebar" id="sidebar">
    <div class="brand">
        <i class="fa-solid fa-shield-heart"></i>
        <span>Ø£Ù†Ø´Ø·Ø© Ø§Ù„ÙˆÙ‚Ø§ÙŠØ©</span>
    </div>
    <nav>
        <div class="nav-link active" onclick="showSection('dashboard', this)"><i class="fa-solid fa-chart-pie"></i> Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©</div>
        <div class="nav-link" onclick="showSection('entry', this)"><i class="fa-solid fa-plus-circle"></i> ØªØ³Ø¬ÙŠÙ„ Ø¬Ø¯ÙŠØ¯</div>
        <div class="nav-link" onclick="showSection('reports', this)"><i class="fa-solid fa-table-list"></i> Ø³Ø¬Ù„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</div>
    </nav>
</aside>

<main class="main-content">
    <div class="header-section">
        <button class="mobile-menu-btn" onclick="toggleSidebar()"><i class="fa-solid fa-bars"></i></button>
        <div class="page-title">
            <h2 id="page-header-title">Ù„ÙˆØ­Ø© Ø§Ù„Ù‚ÙŠØ§Ø¯Ø©</h2>
            <p id="current-date-display"></p>
        </div>
    </div>

    <div id="dashboard" class="section active">
        <div class="stats-grid">
            <div class="stat-card" style="border-color: var(--primary);">
                <div class="stat-info"><h3 id="kpi-activities">0</h3><p>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ø£Ù†Ø´Ø·Ø©</p></div>
                <div class="stat-icon"><i class="fa-solid fa-clipboard-list"></i></div>
            </div>
            <div class="stat-card" style="border-color: var(--success);">
                <div class="stat-info"><h3 id="kpi-beneficiaries">0</h3><p>Ø§Ù„Ù…Ø³ØªÙÙŠØ¯ÙŠÙ†</p></div>
                <div class="stat-icon"><i class="fa-solid fa-users"></i></div>
            </div>
            <div class="stat-card" style="border-color: var(--warning);">
                <div class="stat-info"><h3 id="kpi-top-activity">-</h3><p>Ø§Ù„Ø£ÙƒØ«Ø± ØªÙ†ÙÙŠØ°Ø§Ù‹</p></div>
                <div class="stat-icon"><i class="fa-solid fa-crown"></i></div>
            </div>
        </div>
        <div class="charts-container">
            <div class="card chart-box"><canvas id="chartActivities"></canvas></div>
            <div class="card chart-box"><canvas id="chartTrend"></canvas></div>
        </div>
    </div>

    <div id="entry" class="section">
        <div class="card" style="max-width: 800px; margin: auto;">
            <h3>ğŸ“ ØªØ³Ø¬ÙŠÙ„ Ù†Ø´Ø§Ø· Ø¬Ø¯ÙŠØ¯</h3>
            <form id="data-form">
                <input type="hidden" id="edit-doc-id"> 
                <div class="form-grid">
                    <div class="form-group"><label>ØªØ§Ø±ÙŠØ® Ø§Ù„Ù†Ø´Ø§Ø·</label><input type="date" id="activity-date" required></div>
                    <div class="form-group"><label>Ø¥Ø¬Ù…Ø§Ù„ÙŠ Ø§Ù„Ù…Ø³ØªÙÙŠØ¯ÙŠÙ†</label><input type="number" id="beneficiaries" required></div>
                    <div class="form-group" style="grid-column: 1 / -1;">
                        <label>Ù†ÙˆØ¹ Ø§Ù„Ù†Ø´Ø§Ø·</label>
                        <select id="activity" required>
                            <option value="" disabled selected>--- Ø§Ø®ØªØ± Ø§Ù„Ù†Ø´Ø§Ø· ---</option>
                            <option value="1- Ø­Ù…Ù„Ø§Øª Ø·Ø±Ù‚ Ø§Ù„Ø£Ø¨ÙˆØ§Ø¨">1- Ø­Ù…Ù„Ø§Øª Ø·Ø±Ù‚ Ø§Ù„Ø£Ø¨ÙˆØ§Ø¨</option>
                            <option value="2- Ù„Ù‚Ø§Ø¡Ø§Øª Ø£Ø³Ø±ÙŠØ©">2- Ù„Ù‚Ø§Ø¡Ø§Øª Ø£Ø³Ø±ÙŠØ©</option>
                            <option value="3- Ù„Ù‚Ø§Ø¡Ø§Øª Ø¯ÙŠÙ†ÙŠØ©">3- Ù„Ù‚Ø§Ø¡Ø§Øª Ø¯ÙŠÙ†ÙŠØ© (Ù…Ø³Ø§Ø¬Ø¯/ÙƒÙ†Ø§Ø¦Ø³)</option>
                            <option value="4- Ù…ÙŠØ¯Ø§Ù†ÙŠØ©">4- Ù…ÙŠØ¯Ø§Ù†ÙŠØ© (Ù…ÙŠØ§Ø¯ÙŠÙ†/Ø£Ø³ÙˆØ§Ù‚/ÙˆØ±Ø´)</option>
                            <option value="5- Ù…Ù‡Ø±Ø¬Ø§Ù†Ø§Øª Ø±ÙŠØ§Ø¶ÙŠØ© ÙˆÙÙ†ÙŠØ©">5- Ù…Ù‡Ø±Ø¬Ø§Ù†Ø§Øª Ø±ÙŠØ§Ø¶ÙŠØ© ÙˆÙÙ†ÙŠØ©</option>
                            <option value="6- ÙˆØ±Ø´ Ø¹Ù…Ù„ Ù„Ù„Ø£Ø·ÙØ§Ù„">6- ÙˆØ±Ø´ Ø¹Ù…Ù„ Ù„Ù„Ø£Ø·ÙØ§Ù„</option>
                            <option value="7- ØªØ¯Ø±ÙŠØ¨Ø§Øª Ø§Ù„Ù‚ÙŠØ§Ø¯Ø§Øª">7- ØªØ¯Ø±ÙŠØ¨Ø§Øª Ø§Ù„Ù‚ÙŠØ§Ø¯Ø§Øª</option>
                            <option value="8- Ø§Ù„Ù…Ø¬Ù…Ø¹Ø§Øª Ø§Ù„Ø®Ø¯Ù…ÙŠØ©">8- Ø§Ù„Ù…Ø¬Ù…Ø¹Ø§Øª Ø§Ù„Ø®Ø¯Ù…ÙŠØ© (Ù…Ø¯Ø§Ø±Ø³/Ø¬Ù…Ø¹ÙŠØ§Øª)</option>
                        </select>
                    </div>
                </div>
                <button type="submit" id="submit-btn" class="btn btn-primary" style="margin-top:20px;">Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª</button>
            </form>
        </div>
    </div>

    <div id="reports" class="section">
        <div class="card">
            <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap:wrap;">
                <input type="date" id="filter-from-date">
                <input type="date" id="filter-to-date">
                <button onclick="renderTable()" class="btn btn-primary">Ø¹Ø±Ø¶</button>
                <button onclick="exportToPDF()" class="btn btn-pdf"><i class="fa-solid fa-file-pdf"></i> Ø·Ø¨Ø§Ø¹Ø© Ø§Ù„Ø¬Ø¯ÙˆÙ„</button>
            </div>
            <div class="table-container">
                <table id="reports-table">
                    <thead><tr><th>Ø§Ù„ØªØ§Ø±ÙŠØ®</th><th>Ø§Ù„Ù†Ø´Ø§Ø·</th><th>Ø§Ù„Ù…Ø³ØªÙÙŠØ¯ÙŠÙ†</th><th>Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª</th></tr></thead>
                    <tbody id="data-table-body"></tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="pdf-template">
        <img id="pdf-bg-image-el" src="" alt="Background" style="width: 100%; height: 100%;">

        <div class="val-box col-count r1" id="p-count-1"></div>
        <div class="val-box col-ben r1" id="p-ben-1"></div>

        <div class="val-box col-count r2" id="p-count-2"></div>
        <div class="val-box col-ben r2" id="p-ben-2"></div>

        <div class="val-box col-count r3" id="p-count-3"></div>
        <div class="val-box col-ben r3" id="p-ben-3"></div>

        <div class="val-box col-count r4" id="p-count-4"></div>
        <div class="val-box col-ben r4" id="p-ben-4"></div>

        <div class="val-box col-count r5" id="p-count-5"></div>
        <div class="val-box col-ben r5" id="p-ben-5"></div>

        <div class="val-box col-count r6" id="p-count-6"></div>
        <div class="val-box col-ben r6" id="p-ben-6"></div>

        <div class="val-box col-count r7" id="p-count-7"></div>
        <div class="val-box col-ben r7" id="p-ben-7"></div>

        <div class="val-box col-count r8" id="p-count-8"></div>
        <div class="val-box col-ben r8" id="p-ben-8"></div>

        <div class="val-box col-count r9" id="p-total-count"></div>
        <div class="val-box col-ben r9" id="p-total-ben"></div>
    </div>

</main>

<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.0/firebase-firestore.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
    // ====================================================
    // ğŸ–¼ï¸ Ù…ÙƒØ§Ù† ÙƒÙˆØ¯ Ø§Ù„ØµÙˆØ±Ø© Base64
    // ====================================================
    // ğŸ”´ Ù‡Ø§Ù… Ø¬Ø¯Ø§Ù‹: Ø¶Ø¹ ÙƒÙˆØ¯ Base64 Ø§Ù„Ø·ÙˆÙŠÙ„ Ù‡Ù†Ø§ Ø¨ÙŠÙ† Ø¹Ù„Ø§Ù…ØªÙŠ Ø§Ù„ØªÙ†ØµÙŠØµ
    const TABLE_IMAGE_BASE64 = "
        
    // Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Firebase
    const firebaseConfig = {
        apiKey: "AIzaSyCDJANXMfd6TR7R2ruLIi-xytlrB-LiCEs", 
        authDomain: "rdtt-15cbe.firebaseapp.com",
        projectId: "rdtt-15cbe",
        storageBucket: "rdtt-15cbe.firebasestorage.app",
        messagingSenderId: "219502671343",
        appId: "1:219502671343:web:b289b11869e25c9a30321a"
    };

    if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const ACTIVITIES_COLLECTION = 'dashboard_preventive_logs';

    let chartInstance1 = null;
    let chartInstance2 = null;

    window.onload = function() {
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('activity-date').value = today;
        document.getElementById('current-date-display').textContent = new Date().toLocaleDateString('ar-EG');
        
        // ØªØ¹ÙŠÙŠÙ† ØµÙˆØ±Ø© Ø§Ù„Ø®Ù„ÙÙŠØ©
        if(TABLE_IMAGE_BASE64 && TABLE_IMAGE_BASE64.length > 50) {
            document.getElementById('pdf-bg-image-el').src = TABLE_IMAGE_BASE64;
        }

        loadDashboardData();
    };

    // --- Ø¯ÙˆØ§Ù„ Ø§Ù„ÙˆØ§Ø¬Ù‡Ø© ÙˆØ§Ù„Ø£Ù†ÙŠÙ…ÙŠØ´Ù† ---
    function toggleSidebar() { document.getElementById('sidebar').classList.toggle('open'); }
    
    function showSection(sectionId, link) {
        document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
        document.getElementById(sectionId).classList.add('active');
        document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
        link.classList.add('active');
        if(sectionId === 'dashboard') loadDashboardData();
        if(sectionId === 'reports') renderTable();
    }

    function animateValue(id, start, end, duration) {
        const obj = document.getElementById(id);
        let startTimestamp = null;
        const step = (timestamp) => {
            if (!startTimestamp) startTimestamp = timestamp;
            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
            obj.innerHTML = Math.floor(progress * (end - start) + start).toLocaleString('ar-EG');
            if (progress < 1) window.requestAnimationFrame(step);
        };
        window.requestAnimationFrame(step);
    }

    // --- Firebase Logic ---
    async function loadDataFromFireStore(fromDate, toDate) {
        let q = db.collection(ACTIVITIES_COLLECTION).orderBy('date', 'desc');
        if (fromDate && toDate) q = q.where('date', '>=', fromDate).where('date', '<=', toDate);
        const snapshot = await q.get();
        return snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
    }

    document.getElementById('data-form').addEventListener('submit', async function(e) {
        e.preventDefault();
        const btn = document.getElementById('submit-btn');
        btn.innerHTML = 'Ø¬Ø§Ø±ÙŠ Ø§Ù„Ø­ÙØ¸...'; btn.disabled = true;
        
        const data = {
            date: document.getElementById('activity-date').value,
            activity: document.getElementById('activity').value,
            beneficiaries: parseInt(document.getElementById('beneficiaries').value) || 0,
            timestamp: firebase.firestore.FieldValue.serverTimestamp()
        };

        const docId = document.getElementById('edit-doc-id').value;
        if(docId) await db.collection(ACTIVITIES_COLLECTION).doc(docId).update(data);
        else await db.collection(ACTIVITIES_COLLECTION).add(data);
        
        Swal.fire({icon:'success', title:'ØªÙ… Ø§Ù„Ø­ÙØ¸', timer:1500, showConfirmButton:false});
        document.getElementById('data-form').reset();
        document.getElementById('activity-date').value = new Date().toISOString().split('T')[0];
        btn.innerHTML = 'Ø­ÙØ¸ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª'; btn.disabled = false;
    });

    async function deleteItem(id) {
        if(confirm('Ù‡Ù„ Ø£Ù†Øª Ù…ØªØ£ÙƒØ¯ Ù…Ù† Ø§Ù„Ø­Ø°ÙØŸ')) {
            await db.collection(ACTIVITIES_COLLECTION).doc(id).delete();
            renderTable(); loadDashboardData();
        }
    }

    // --- Dashboard ---
    async function loadDashboardData() {
        const data = await loadDataFromFireStore();
        const totalActs = data.length;
        const totalBen = data.reduce((s, i) => s + (i.beneficiaries||0), 0);
        
        animateValue("kpi-activities", 0, totalActs, 1000);
        animateValue("kpi-beneficiaries", 0, totalBen, 1500);
        
        // Ø­Ø³Ø§Ø¨ Ø§Ù„Ø£ÙƒØ«Ø± ØªÙƒØ±Ø§Ø±Ø§Ù‹
        const counts = {};
        data.forEach(x => counts[x.activity] = (counts[x.activity]||0)+1);
        const top = Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b, "-");
        document.getElementById('kpi-top-activity').innerText = top.split(' ')[0] + '..';

        updateCharts(data);
    }

    function updateCharts(data) {
        const agg = {};
        data.forEach(i => agg[i.activity] = (agg[i.activity]||0) + i.beneficiaries);
        
        if(chartInstance1) chartInstance1.destroy();
        const ctx1 = document.getElementById('chartActivities').getContext('2d');
        chartInstance1 = new Chart(ctx1, {
            type: 'doughnut',
            data: { labels: Object.keys(agg), datasets: [{ data: Object.values(agg), backgroundColor: ['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6'] }] },
            options: { maintainAspectRatio: false, plugins: { legend: { position: 'right' } } }
        });
    }

    async function renderTable() {
        const f = document.getElementById('filter-from-date').value;
        const t = document.getElementById('filter-to-date').value;
        const data = await loadDataFromFireStore(f, t);
        const tbody = document.getElementById('data-table-body');
        tbody.innerHTML = '';
        
        data.forEach(item => {
            tbody.innerHTML += `
                <tr>
                    <td>${item.date}</td>
                    <td>${item.activity}</td>
                    <td>${item.beneficiaries}</td>
                    <td><button onclick="deleteItem('${item.id}')" class="btn btn-danger"><i class="fa fa-trash"></i></button></td>
                </tr>`;
        });
    }

    // ====================================================
    // ğŸ–¨ï¸ Ø¯Ø§Ù„Ø© Ø§Ù„ØªØµØ¯ÙŠØ± PDF (Overlay Logic)
    // ====================================================
    async function exportToPDF() {
        const fromDate = document.getElementById('filter-from-date').value;
        const toDate = document.getElementById('filter-to-date').value;
        
        Swal.fire({title: 'Ø¬Ø§Ø±ÙŠ ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¬Ø¯ÙˆÙ„...', didOpen: () => { Swal.showLoading() }});

        const data = await loadDataFromFireStore(fromDate, toDate);

        // 1. ØªØµÙÙŠØ± Ø§Ù„Ø¹Ø¯Ø§Ø¯Ø§Øª (8 ÙØ¦Ø§Øª)
        let stats = {
            1: { count: 0, ben: 0 }, 2: { count: 0, ben: 0 }, 3: { count: 0, ben: 0 },
            4: { count: 0, ben: 0 }, 5: { count: 0, ben: 0 }, 6: { count: 0, ben: 0 },
            7: { count: 0, ben: 0 }, 8: { count: 0, ben: 0 }
        };

        // 2. ØªÙˆØ²ÙŠØ¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø¹Ù„Ù‰ Ø§Ù„ÙØ¦Ø§Øª Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø¨Ø¯Ø§ÙŠØ© Ø§Ø³Ù… Ø§Ù„Ù†Ø´Ø§Ø·
        data.forEach(item => {
            let key = 0;
            if (item.activity.startsWith("1-")) key = 1;
            else if (item.activity.startsWith("2-")) key = 2;
            else if (item.activity.startsWith("3-")) key = 3;
            else if (item.activity.startsWith("4-")) key = 4;
            else if (item.activity.startsWith("5-")) key = 5;
            else if (item.activity.startsWith("6-")) key = 6;
            else if (item.activity.startsWith("7-")) key = 7;
            else if (item.activity.startsWith("8-")) key = 8;

            if (key > 0) {
                stats[key].count += 1;
                stats[key].ben += (parseInt(item.beneficiaries) || 0);
            }
        });

        // 3. ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø£Ø±Ù‚Ø§Ù… ÙÙˆÙ‚ Ø§Ù„ØµÙˆØ±Ø©
        let totalC = 0, totalB = 0;
        for (let i = 1; i <= 8; i++) {
            document.getElementById(`p-count-${i}`).innerText = stats[i].count > 0 ? stats[i].count : '';
            document.getElementById(`p-ben-${i}`).innerText = stats[i].ben > 0 ? stats[i].ben.toLocaleString('ar-EG') : '';
            totalC += stats[i].count;
            totalB += stats[i].ben;
        }

        // ÙƒØªØ§Ø¨Ø© Ø§Ù„Ø¥Ø¬Ù…Ø§Ù„ÙŠ
        document.getElementById('p-total-count').innerText = totalC;
        document.getElementById('p-total-ben').innerText = totalB.toLocaleString('ar-EG');

        // 4. Ø¥Ø¸Ù‡Ø§Ø± Ø§Ù„Ù‚Ø§Ù„Ø¨ ÙˆØ¥Ù†Ø´Ø§Ø¡ PDF
        const element = document.getElementById('pdf-template');
        element.style.display = 'block';

        const opt = {
            margin:       0,
            filename:     `Preventive_Table_${new Date().toISOString().split('T')[0]}.pdf`,
            image:        { type: 'jpeg', quality: 0.98 },
            html2canvas:  { scale: 2, useCORS: true },
            jsPDF:        { unit: 'px', format: [794, 1123], orientation: 'portrait' } 
            // 794x1123 Ù‡ÙŠ Ø£Ø¨Ø¹Ø§Ø¯ A4 Ø¨Ø§Ù„Ø¨ÙƒØ³Ù„ Ø¹Ù†Ø¯ 96 DPIØŒ Ù…Ù…Ø§ ÙŠØ¶Ù…Ù† ØªØ·Ø§Ø¨Ù‚ Ø§Ù„ØµÙˆØ±Ø©
        };

        html2pdf().set(opt).from(element).save().then(() => {
            element.style.display = 'none';
            Swal.close();
        });
    }
</script>
</body>
</html>
